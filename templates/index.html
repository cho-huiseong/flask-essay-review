<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>아카데미창 · 다쓰 리포트</title>

<!-- 폰트/라이브러리 -->
<link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
:root{
  --brand:#2140B1; --brand-700:#1a2f91;
  --ink:#111827; --muted:#6B7280; --line:rgba(17,24,39,.10);
  --bg:#f7f9ff; --white:#fff;
}
*{ box-sizing:border-box; font-family:'SUIT',system-ui,sans-serif; letter-spacing:-.2px }
html,body{ margin:0; color:var(--ink); background:var(--bg) }
a{ color:inherit; text-decoration:none }
.hidden{ display:none !important }
.muted{ color:var(--muted) }
.container{ max-width:1180px; margin:0 auto; padding:0 24px }

/* 헤더 */
header{
  position:sticky; top:0; z-index:20; background:rgba(255,255,255,.75);
  backdrop-filter:blur(10px); border-bottom:1px solid var(--line);
}
.nav{ height:66px; display:flex; align-items:center; justify-content:space-between }
.nav-left{ display:flex; align-items:center; gap:10px; font-weight:900 }
.nav-right{ display:flex; gap:12px; align-items:center }
.btn{ border:none; height:44px; padding:0 18px; border-radius:14px; font-weight:800; cursor:pointer; transition:.2s }
.btn-primary{ background:var(--brand); color:#fff; box-shadow:0 8px 20px rgba(33,64,177,.18) }
.btn-primary:hover{ transform:translateY(-1px); box-shadow:0 12px 28px rgba(33,64,177,.22) }
.btn-ghost{ background:#fff; border:1px solid #e5e7eb }
.avatar{ width:32px; height:32px; border-radius:50%; background:#EEF2FF; color:#2140B1; display:flex; align-items:center; justify-content:center; font-weight:900 }
.dropdown{ position:relative }
.dropdown-menu{ position:absolute; right:0; top:44px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 12px 30px rgba(17,24,39,.12); padding:8px; min-width:160px; display:none }
.dropdown-menu a, .dropdown-menu button{ display:block; width:100%; text-align:left; background:transparent; border:none; padding:8px 10px; border-radius:8px; font-weight:700; color:#374151; cursor:pointer }
.dropdown-menu a:hover, .dropdown-menu button:hover{ background:#f3f4f6 }

/* HERO */
.hero{
  padding:88px 0 40px;
  background:
    radial-gradient(1200px 600px at 80% -30%, rgba(33,64,177,.22), transparent),
    radial-gradient(900px 500px at -10% 20%, rgba(33,64,177,.12), transparent),
    linear-gradient(180deg, #ffffff 0%, #f7f9ff 60%);
  border-bottom:1px solid var(--line);
}
.hero h1{ margin:0 0 12px; font-size:clamp(36px,6vw,64px); line-height:1.08; font-weight:900 }
.hero p{ margin:0 0 24px; font-size:18px; color:#4b5563 }

/* ============== 3-STEP 데모 ============== */
.container.wide{ max-width:1440px; }                      /* 480(카피)+1120(모니터)+여백 */
.step{ padding:70px 0; }
.step-grid{ display:grid; gap:24px; align-items:center }
.step-grid.fixed{ grid-template-columns:400px 960px; } /* 모니터 1120px 고정 */
@media(max-width:1440px){ .step-grid.fixed{ grid-template-columns:1fr; } }
.step h2{ margin:0 0 8px; font-size:32px; font-weight:900 }
.step p{ margin:0; color:#6b7280 }
.step .cta-row{ display:flex; gap:10px; margin-top:12px }
.monitor{
  border-radius:22px; padding:16px; background:rgba(255,255,255,.8);
  border:1px solid rgba(229,231,235,.8); box-shadow:0 30px 60px rgba(33,64,177,.14), inset 0 0 0 1px #eef2ff;
}
.monitor .bar{ height:22px; display:flex; align-items:center; gap:8px; padding:0 10px; }
.dot{ width:10px; height:10px; border-radius:50% }
.dot.red{ background:#ff5f57 } .dot.yellow{ background:#ffbd2e } .dot.green{ background:#28c840 }
.screen{ border-radius:16px; background:#fff; border:1px solid #eef2ff; overflow:hidden; }
.viewport{ position:relative; overflow:hidden }
.stage{ width:1120px; margin:0 auto; padding:18px; transform-origin: top center; }

/* 입력/결과 데모 스타일 */
.panel{ background:rgba(255,255,255,.6); backdrop-filter:blur(14px); border:1px solid rgba(255,255,255,.5);
  border-radius:22px; padding:22px; box-shadow:0 10px 30px rgba(17,24,39,.1) }
.form-label{ font-weight:900; margin:12px 0 6px; display:block }
.input,.textarea{ width:100%; padding:14px 16px; border:1px solid #e5e7eb; border-radius:12px; font-size:16px; line-height:1.6; resize:none }
.input:focus,.textarea:focus{ outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(33,64,177,.18) }
.textarea::placeholder,.input::placeholder{ color:#9CA3AF }
#passages{ display:grid; grid-template-columns:1fr 1fr; gap:14px }
@media (max-width:680px){ #passages{ grid-template-columns:1fr } }
.kpi{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
@media (max-width:900px){ .kpi{ grid-template-columns:1fr } }
canvas.demoChart{ height:140px !important; }
.divider{ height:1px; background:var(--line); margin:14px 0 }

/* 모달 */
.modal-backdrop{ position:fixed; inset:0; background:rgba(17,24,39,.4); display:flex; align-items:center; justify-content:center; z-index:50 }
.modal{ width:min(560px,90vw); background:#fff; border-radius:18px; border:1px solid #e5e7eb; box-shadow:0 24px 60px rgba(17,24,39,.22); padding:18px }
.modal-backdrop.hidden{ display:none !important; }
.tabs{ display:flex; gap:8px; margin-bottom:12px }
.tab{ flex:1; height:40px; border-radius:999px; border:1px solid #e5e7eb; background:#f8fafc; font-weight:800; cursor:pointer }
.tab.active{ background:#EEF2FF; border-color:#dbe4ff; color:var(--brand-700) }
.row{ display:flex; gap:10px }
</style>
</head>

<body>
<header>
  <div class="container nav">
    <div class="nav-left" style="gap:10px">
      <img src="/static/academy_logo.png" alt="아카데미창" style="height:20px;object-fit:contain">
      <span style="font-weight:900">아카데미창</span>
    </div>
    <div class="nav-right">
      <div id="profileArea" class="dropdown hidden">
        <div id="profileBtn" class="btn btn-ghost" style="display:flex;align-items:center;gap:8px">
          <div class="avatar" id="avatarInitial">A</div>
          <span id="profileName" class="muted" style="font-weight:800"></span>
        </div>
        <div class="dropdown-menu" id="profileMenu">
          <button onclick="logout()">로그아웃</button>
        </div>
      </div>
      <button id="loginBtn" class="btn btn-ghost" onclick="openAuth()">로그인</button>
      <button class="btn btn-primary" onclick="goToEditor()">AI 첨삭하기</button>
    </div>
  </div>
</header>

<main>
  <!-- HERO -->
  <section id="homeSection" class="hero">
    <div class="container">
      <h1>글 평가와 예시 작성,<br/>바로 체험해 보세요</h1>
      <p>입력 → 평가 → 예시답안 · 차이점까지, 실제 화면 크기로 보여줍니다.</p>
      <div style="display:flex; gap:12px; flex-wrap:wrap">
        <button class="btn btn-primary" style="height:52px" onclick="document.getElementById('step1').scrollIntoView({behavior:'smooth'});">체험 시작</button>
      </div>
    </div>
  </section>

  <!-- STEP 1 -->
  <section id="step1" class="step">
    <div class="container wide step-grid fixed">
      <div>
        <h2>1. 입력하기</h2>
        <p>학생·질문·제시문(여러 개)·논술문을 그대로 붙여넣기만 하세요. 글자 수는 자동으로 세고, 제시문은 버튼으로 빠르게 추가돼요.</p>
        <div class="cta-row"><button class="btn btn-primary" onclick="document.getElementById('step2').scrollIntoView({behavior:'smooth'});">다음 단계</button></div>
      </div>
      <div class="monitor">
        <div class="bar"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
        <div class="screen">
          <div class="viewport" data-demo="input" data-stage="960">
            <div class="stage input-demo">
              <h3 style="margin:0 0 6px;font-weight:900">✨ 너의 글, 오늘 더 멀리 날아가게.</h3>
              <p class="muted" style="margin-top:0">정성껏 쓴 문장 위에 필요한 피드백만 얹어, 목표에 닿도록 부드럽게 이끌어 드릴게요.</p>

              <label class="form-label">학생 이름</label>
              <div class="panel" style="padding:12px">홍길동</div>

              <label class="form-label">질문</label>
              <div class="panel" style="padding:12px" data-demo-question>제시문을 바탕으로 '공정'의 의미를 정의하고, 사회적 약자 보호의 관점에서 그 정당성을 논하시오.</div>

              <label class="form-label">제시문 <span class="muted">(최소 1개)</span></label>
              <div id="demoPassages" class="row" style="flex-wrap:wrap">
                <div class="panel" style="padding:12px;flex:1;min-width:300px" data-demo-passage>“공정은 누구나 경쟁에 참여할 수 있도록 동등한 출발선을 보장하려는 사회의 약속이다.”</div>
                <div class="panel" style="padding:12px;flex:1;min-width:300px" data-demo-passage>“성과에 따른 차등 보상은 동기를 높이지만, 출발선이 기울어져 있으면 불평등을 확대할 수 있다.”</div>
                <div class="panel" style="padding:12px;flex:1;min-width:300px" data-demo-passage>“약자를 보호하는 정책은 경쟁을 약화시키는 예외가 아니라 참여 능력을 회복시키는 조건이다.”</div>
                <div class="panel" style="padding:12px;flex:1;min-width:300px" data-demo-passage>“제도는 기회의 불균형을 완화하기 위해 투명한 기준과 명확한 종료 조건을 갖추어야 한다.”</div>
              </div>

              <label class="form-label">논술문</label>
              <div class="panel" style="padding:12px">
                나는 공정을 결과의 균등이 아니라 기회의 균등으로 이해한다. 같은 규칙이 주어져도 출발선이 기울어 있으면 경쟁은 공정해 보이지 않는다. … (생략) … 출발선의 균형과 결과의 책임이 함께 작동할 때 우리는 비로소 공정하다고 말할 수 있다.
              </div>

              <label class="form-label">글자 수 제한</label>
              <div class="row">
                <div class="panel" style="padding:12px;flex:1">기준 700</div>
                <div class="panel" style="padding:12px;flex:1">± 50</div>
              </div>
              <div style="text-align:center;margin-top:10px"><button class="btn btn-primary">⚡ 리포트 생성</button></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- STEP 2 -->
  <section id="step2" class="step">
    <div class="container wide step-grid fixed">
      <div>
        <h2>2. 평가 받기</h2>
        <p>논리·독해·구성·표현 4개 항목 점수와 이유를 한 화면에서 확인하세요. 합격/예비/다시쓰기 기준도 함께 보여드립니다.</p>
        <div class="cta-row"><button class="btn btn-primary" onclick="document.getElementById('step3').scrollIntoView({behavior:'smooth'});">다음 단계</button></div>
      </div>
      <div class="monitor">
        <div class="bar"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
        <div class="screen">
          <div class="viewport" data-demo="score" data-stage="960">
            <div class="stage">
              <div class="panel" style="margin-bottom:10px">
                <div style="display:flex;align-items:center;gap:14px">
                  <div style="font-size:28px">🙂</div>
                  <div style="flex:1">
                    <div style="font-weight:900">총점 <span style="color:#10b981">37</span> / 40 · <span style="color:#10b981">합격</span></div>
                    <div class="muted" style="margin-top:4px">근거 배열과 문장의 연결이 자연스럽습니다.</div>
                    <div style="margin-top:8px;position:relative;height:10px;background:#eef2ff;border-radius:999px;overflow:hidden">
                      <div style="width:92.5%;height:100%;background:#10b981"></div>
                      <div style="position:absolute;left:75%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.15)"></div>
                      <div style="position:absolute;left:90%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.25)"></div>
                    </div>
                  </div>
                  <div style="position:relative;width:110px;height:110px">
                    <svg width="110" height="110">
                      <circle r="52" cx="55" cy="55" fill="transparent" stroke="#eef2ff" stroke-width="10"></circle>
                      <circle r="52" cx="55" cy="55" fill="transparent" stroke="#10b981" stroke-width="10"
                        stroke-dasharray="327" stroke-dashoffset="49"></circle>
                    </svg>
                    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:900">37</div>
                  </div>
                </div>
              </div>

              <div class="kpi">
                <div class="panel"><div style="font-weight:800">논리력 (9)</div><div class="muted" style="margin-top:6px">주장-근거-예시가 짝을 이루며 반론 대비가 포함됨.</div></div>
                <div class="panel"><div style="font-weight:800">독해력 (9)</div><div class="muted" style="margin-top:6px">제시문 핵심을 정확히 요약하고 상호관계를 반영.</div></div>
                <div class="panel"><div style="font-weight:800">구성력 (9)</div><div class="muted" style="margin-top:6px">문단 전환이 매끄럽고 단락 목표가 명확함.</div></div>
                <div class="panel"><div style="font-weight:800">표현력 (10)</div><div class="muted" style="margin-top:6px">어휘 선택이 적절하고 문법 오류가 거의 없음.</div></div>
              </div>

              <div style="margin-top:14px" class="panel">
                <canvas id="demoChart" class="demoChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- STEP 3 -->
  <section id="step3" class="step">
    <div class="container wide step-grid fixed">
      <div>
        <h2>3. 예시답안 · 비교분석</h2>
        <p>예시답안 보기를 누르면 내 글과 다른 점을 줄글로 정리해 드려요. 마음에 들면 PDF 저장하고, 내 기록에서 언제든 다시 볼 수 있어요.</p>
        <div class="cta-row">
          <button class="btn btn-primary" onclick="location.hash='#editor'">내 글로 시작하기</button>
        </div>
      </div>
      <div class="monitor">
        <div class="bar"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
        <div class="screen">
          <div class="viewport" data-demo="example" data-stage="960">
            <div class="stage">
              <div class="panel">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
                  <h3 style="margin:0">📝 예시답안</h3>
                  <button id="demoExampleBtn" class="btn btn-primary" onclick="renderDemoExample()">예시답안 보기</button>
                </div>
                <p class="muted" style="margin-top:6px">권장 글자수 범위를 벗어나도 참고용 예시는 표시됩니다.</p>
                <div id="demoExampleWrap" class="hidden">
                  <div id="demoExampleText" class="panel" style="background:#fff"></div>
                  <div class="panel" style="background:#fff;margin-top:12px">
                    <h3 style="margin:0">🔍 비교 분석</h3>
                    <div id="demoComparisonText" style="margin-top:8px;line-height:1.8"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 실제 에디터 -->
  <section id="editorSection" class="hidden" style="visibility:hidden; padding:56px 0">
    <div class="container">

      <!-- 입력 -->
      <div id="inputPanel" class="panel">
        <h2 style="margin:0 0 12px; font-weight:900">✨ 너의 글, 오늘 더 멀리 날아가게.</h2>
        <p class="muted" style="margin-top:0">정성껏 쓴 문장 위에 필요한 피드백만 얹어, 목표에 닿도록 부드럽게 이끌어 드릴게요.</p>

        <label class="form-label">학생 이름</label>
        <input id="studentName" class="input" placeholder="예: 홍길동" />

        <label class="form-label">질문</label>
        <textarea id="question" class="textarea" rows="2" placeholder="질문을 여기에 작성해 주세요."></textarea>

        <label class="form-label">제시문 <span class="muted">(최소 1개)</span></label>
        <div id="passages">
          <textarea class="passage textarea" rows="3" placeholder="제시문을 그대로 적어 주세요."></textarea>
        </div>
        <div style="display:flex; justify-content:flex-end; margin-top:8px">
          <button type="button" id="btnAddPassage" class="btn btn-ghost">➕ 제시문 더 추가</button>
        </div>

        <label class="form-label">논술문 <span class="muted">(학생 작성 글)</span></label>
        <textarea id="essay" class="textarea" rows="6" placeholder="제시문만 근거로, 배경지식 없이 작성해 주세요." oninput="updateCharCount()"></textarea>
        <div id="charCount" class="muted" style="margin-top:6px"></div>

        <label class="form-label">글자 수 제한</label>
        <div class="row">
          <input id="charLimit" class="input" placeholder="예: 700" />
          <input id="charRange" class="input" placeholder="± 예: 50" />
        </div>

        <div style="margin-top:18px; text-align:center">
          <button class="btn btn-primary" onclick="submitEssay()">⚡ 리포트 생성</button>
        </div>
        <div id="loading" class="muted" style="display:none; margin-top:8px">⏳ 읽고 있어요…</div>
        <div id="error" class="muted" style="display:none; color:#dc2626; margin-top:8px">잠시 후 다시 시도해 주세요.</div>
      </div>

      <!-- 결과 (예시 버튼만 노출) -->
      <div id="resultCard" class="panel hidden" style="margin-top:18px">
        <h3 style="margin-top:0">📊 한눈에 이해되는 리포트</h3>
        <div id="evalSummary"></div>
      </div>

      <!-- 예시/비교 + PDF (버튼 누르기 전에는 감춤) -->
      <div id="exampleSection" class="panel hidden" style="margin-top:18px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <h3 style="margin:0">📝 예시답안</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn btn-ghost" onclick="openRecords()">내 기록</button>
          </div>
        </div>
        <div id="exampleNote" class="muted" style="margin-top:8px;display:none"></div>
        <div id="exampleOutput" class="panel" style="background:#fff"></div>
        <div id="comparisonOutput" class="panel" style="background:#fff;margin-top:12px"></div>
        <button id="btnSavePDF" class="btn btn-primary" style="margin-top:14px"
        onclick="downloadPDF_v2()">📥 PDF 저장</button>
        <button class="btn btn-ghost" style="margin-top:14px" onclick="resetReport()">🔄 새 리포트 시작</button>
      </div>

    </div>
  </section>
</main>

<!-- AUTH MODAL -->
<div id="authWrap" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="authTitle">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="authTitle" style="margin:0;font-weight:900">내 계정</h3>
      <button class="btn btn-ghost" onclick="closeAuth()">닫기</button>
    </div>
    <div class="tabs" style="margin-top:10px">
      <button id="tabLogin" class="tab active" onclick="switchTab('login')">로그인</button>
      <button id="tabRegister" class="tab" onclick="switchTab('register')">회원가입</button>
    </div>
    <div id="loginPanel">
      <label class="form-label">이메일</label>
      <input id="loginEmail" class="input" placeholder="you@example.com" />
      <label class="form-label">비밀번호</label>
      <input id="loginPassword" type="password" class="input" placeholder="••••••" />
      <button class="btn btn-primary" style="margin-top:12px" onclick="login()">로그인</button>
      <div id="loginError" class="muted" style="color:#dc2626;margin-top:8px;display:none"></div>
    </div>
    <div id="registerPanel" class="hidden">
      <label class="form-label">이름</label>
      <input id="regName" class="input" placeholder="홍길동" />
      <label class="form-label">이메일</label>
      <input id="regEmail" class="input" placeholder="you@example.com" />
      <label class="form-label">비밀번호 (6자 이상)</label>
      <input id="regPassword" type="password" class="input" placeholder="••••••" />
      <button class="btn btn-primary" style="margin-top:12px" onclick="register()">회원가입</button>
      <div id="registerError" class="muted" style="color:#dc2626;margin-top:8px;display:none"></div>
    </div>
  </div>
</div>

<!-- RECORDS MODAL -->
<div id="recordsWrap" class="modal-backdrop hidden">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0;font-weight:900">내 기록</h3>
      <button class="btn btn-ghost" onclick="closeRecords()">닫기</button>
    </div>
    <div id="recordsList" class="muted" style="margin-top:8px">불러오는 중…</div>
  </div>
</div>

<script>
/* ===== 데모 데이터 ===== */
const demoSet = {
  student: "김다움",
  question: "제시문을 바탕으로 '공정'의 의미를 정의하고, 사회적 약자 보호의 관점에서 그 정당성을 논하시오.",
  passages: [
    "공정은 누구나 경쟁에 참여할 수 있도록 동등한 출발선을 보장하려는 사회의 약속이다.",
    "성과에 따른 차등 보상은 동기를 높이지만, 출발선이 기울어져 있으면 불평등을 확대할 수 있다.",
    "약자를 보호하는 정책은 경쟁을 약화시키는 예외가 아니라 참여 능력을 회복시키는 조건이다.",
    "제도는 기회의 불균형을 완화하기 위해 투명한 기준과 명확한 종료 조건을 갖추어야 한다."
  ],
  essay:"나는 공정을 결과의 균등이 아니라 기회의 균등으로 이해한다. 같은 규칙이 주어져도 출발선이 기울어 있으면 경쟁은 공정해 보이지 않는다. … (생략) … 출발선의 균형과 결과의 책임이 함께 작동할 때 우리는 비로소 공정하다고 말할 수 있다.",
  charBase:700, charRange:50,
  scores:[9,9,9,10], total:37, status:"합격",
  reasons:{
    "논리력":"주장→근거→조건→결론으로 전개가 일관됨.",
    "독해력":"출발선·차등·약자보호·제도설계의 핵심을 각각 논지에 연결.",
    "구성력":"도입-본문-결론의 아치형 구조, 단락 목표가 분명.",
    "표현력":"핵심어 반복으로 응집력 강화, 문법 오류 없음."
  },
  example:"공정은 결과의 동일을 강제하는 규범이 아니라, 누구나 경쟁에 참여할 수 있도록 출발선을 균등화하는 원칙이다. 이때 약자 보호는 예외가 아니라 공정의 조건이다. 교육·정보·건강과 같은 기본 역량을 보장해 참여 능력을 끌어올리고, 이후의 성과는 예측 가능한 기준에 따라 차등 보상되어야 한다.\n\n지원은 목적·대상·기간·종료 조건이 명확해야 한다. 보정이 성과 보상과 뒤섞이면 특혜로 오해되기 때문이다. 반대로 성과가 확인되면 더 큰 자율과 책임을 부여해야 제도는 신뢰를 얻는다. 결국 공정은 ‘기회 보정’과 ‘성과 책임’이 동시에 작동할 때 유지된다.",
  comparison:"원문은 ‘지원과 보상 분리’의 필요성을 간단히 언급했다. 예시는 지원의 네 요소(목적·대상·기간·종료)를 분명히 해 정책 설계의 닫힘을 확보한다. 또한 원문이 추상적 범주에 머문 반면, 예시는 교육·정보·건강 등으로 구체화하여 적용 가능성을 높였다. 마지막으로 결론에서 ‘기회 보정 + 성과 책임’이라는 이원 구조를 공식처럼 제시해 메시지 회수와 기억 용이성을 강화했다."
};

/* ===== 라우팅 ===== */
function show(section){
  const home = document.getElementById('homeSection');
  const editor = document.getElementById('editorSection');
  home.classList.toggle('hidden', section!=='home');
  editor.classList.toggle('hidden', section!=='editor');
  if(section==='editor'){
    requestAnimationFrame(refreshAutosize);
    if (document.fonts && document.fonts.ready) document.fonts.ready.then(()=>refreshAutosize());
    editor.style.visibility = 'visible';
  }
  window.scrollTo({ top:0, behavior:'instant' });
}
function go(section){ location.hash = (section==='editor' ? '#editor' : '#home'); show(section); }
function routeFromHash(){ const h=(location.hash||'').toLowerCase(); if(h==='#editor') show('editor'); else show('home'); }
window.addEventListener('hashchange', routeFromHash);
window.addEventListener('DOMContentLoaded', routeFromHash);
function goToEditor(){ if(!currentUser){ deferredAction='goEditor'; openAuth(); return; } location.hash='#editor'; show('editor'); setTimeout(()=>{document.getElementById('studentName')?.focus({preventScroll:true});},0); }

/* ===== 실 화면 스케일: 1120px 1:1, 필요 시 축소 ===== */
function scaleDemo(){
  document.querySelectorAll('.viewport').forEach(vp=>{
    const stage = vp.querySelector('.stage');
    if(!stage) return;
    const stageW = parseInt(vp.dataset.stage || '1120', 10); // 랜딩=960, 에디터=1120
    stage.style.width = stageW + 'px';
    const maxW = (vp.closest('.screen')||vp).clientWidth;
    const scale = Math.min(1, maxW / stageW);
    stage.style.transformOrigin = 'top center';
    stage.style.transform = `scale(${scale})`;
    const rect = stage.getBoundingClientRect();        // 변환 후 실제 높이
    vp.style.height = rect.height + 'px';               // h*scale 아님!
  });
}
window.addEventListener('DOMContentLoaded', scaleDemo);
window.addEventListener('resize', scaleDemo);

/* ===== 데모 차트 ===== */
function renderDemoChart(){
  const el=document.getElementById('demoChart');
  if(!el) return;
  new Chart(el.getContext('2d'),{
    type:'bar',
    data:{ labels:['논리력','독해력','구성력','표현력'],
      datasets:[{ data:[9,9,9,10], backgroundColor:"rgba(33,64,177,.75)", borderRadius:8, barThickness:28, categoryPercentage:0.65 }]},
    options:{ animation:{duration:400},
      scales:{ x:{grid:{display:false},ticks:{color:'#6B7280',font:{size:12}}},
               y:{beginAtZero:true,max:10,ticks:{stepSize:1,color:'#9CA3AF',font:{size:11}},grid:{color:'rgba(17,24,39,.06)'}}},
      plugins:{legend:{display:false}}}
  });
}
window.addEventListener('DOMContentLoaded', renderDemoChart);

/* ===== 데모 예시 토글 ===== */
function renderDemoExample(){
  const btn=document.getElementById('demoExampleBtn');
  const wrap=document.getElementById('demoExampleWrap');
  const ex=document.getElementById('demoExampleText');
  const cmp=document.getElementById('demoComparisonText');
  btn.disabled=true; const old=btn.textContent; btn.textContent='생성 중…';
  setTimeout(()=>{
    ex.innerHTML = (demoSet.example||'').replace(/\n/g,'<br>');
    cmp.innerHTML = (demoSet.comparison||'').replace(/\n/g,'<br>');
    wrap.classList.remove('hidden');
    btn.textContent='예시답안 생성됨';
  }, 500);
}

/* ===== textarea 자동 리사이즈 & 카운트 ===== */
function autoResize(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,1200)+'px'; }
function refreshAutosize(){ document.querySelectorAll('textarea').forEach(t=>{ autoResize(t); }); }
function bindAutoResize(){ document.querySelectorAll('textarea').forEach(t=>{ t.addEventListener('input',()=>autoResize(t)); autoResize(t); }); }
window.addEventListener('DOMContentLoaded', bindAutoResize);
function updateCharCount(){
  const essay=document.getElementById('essay').value;
  const l=parseInt(document.getElementById('charLimit').value);
  const r=parseInt(document.getElementById('charRange').value)||0;
  const enabled=!Number.isNaN(l);
  const min=enabled?Math.max(0,l-r):0;
  const max=enabled?l+r:Infinity;
  const inRange=!enabled?true:(essay.length>=min && essay.length<=max);
  const el=document.getElementById('charCount');
  el.textContent = enabled ? `현재 글자 수: ${essay.length} · 기준 ${min}~${max}` : `현재 글자 수: ${essay.length}`;
  el.style.color = inRange ? '#6B7280' : '#ef4444';
}

/* ===== 제시문 추가 (전역 바인딩) ===== */
window.addPassage = function(){
  const t=document.createElement('textarea');
  t.className='passage textarea'; t.rows=3;
  t.placeholder='제시문을 그대로 적어 주세요.';
  document.getElementById('passages').appendChild(t);
  t.addEventListener('input',()=>autoResize(t));
  autoResize(t); t.focus();
};
document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('btnAddPassage')?.addEventListener('click', ()=>window.addPassage()); });

/* ===== 상태 ===== */
let scoreChart, savedScores=[], savedReasons={}, savedExample="", savedComparison="";
let exampleGenerated=false; let currentUser=null; let deferredAction=null;

function resetReport(){
  document.getElementById('studentName').value = '';
  document.getElementById('question').value = '';

  // 첫 번째 제시문만 비우고 나머지는 제거
  document.querySelectorAll('.passage').forEach((p, i) => {
    if (i === 0) p.value = '';
    else p.remove();
  });

  document.getElementById('essay').value = '';
  document.getElementById('charLimit').value = '';
  document.getElementById('charRange').value = '';
  document.getElementById('charCount').textContent = '';

  // 결과/예시 영역 닫고 비우기
  document.getElementById('resultCard').classList.add('hidden');
  document.getElementById('exampleSection').classList.add('hidden');
  document.getElementById('exampleNote').style.display = 'none';
  document.getElementById('exampleOutput').innerHTML = '';
  document.getElementById('comparisonOutput').innerHTML = '';

  // 상태값 / 차트 초기화
  savedScores = [];
  savedReasons = {};
  savedExample = '';
  savedComparison = '';
  if (scoreChart) { try { scoreChart.destroy(); } catch(e) {} scoreChart = null; }

  updatePdfBtnState();
  refreshAutosize();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}


// === PDF v2 유틸/버튼 바인딩 ===
window.__pdf_version = 'v2.1-2025-10-10';

function updatePdfBtnState(){
  const b = document.getElementById('btnSavePDF');
  if(!b) return;
  b.disabled = !(savedScores?.length); // 점수 없을 때 비활성화
}

async function waitFontsAndImages(root){
  try { if (document.fonts?.ready) await document.fonts.ready; } catch(e){}
  const imgs = Array.from(root.querySelectorAll('img')).filter(i=>!i.complete);
  await Promise.all(imgs.map(img=>new Promise(res=>{ img.onload = img.onerror = res; })));
}

document.addEventListener('DOMContentLoaded', () => {
  const b = document.getElementById('btnSavePDF');
  if (b) b.addEventListener('click', downloadPDF_v2);
  updatePdfBtnState();
});

/* ===== 총점/상태 ===== */
function getTotalAndStatus(scores){
  const total=(scores||[]).reduce((a,b)=>a+(parseInt(b)||0),0);
  let status={label:"예비",desc:"조금만 다듬으면 더 좋아져요.",emoji:"🙂",tone:"#f59e0b"};
  if(total<30) status={label:"다시 쓰기",desc:"다음 시도에서 더 단단해질 거예요.",emoji:"😅",tone:"#ef4444"};
  else if(total>=36) status={label:"합격",desc:"지금도 충분히 설득력 있어요!",emoji:"🥳",tone:"#10b981"};
  return { total, status };
}

/* ===== 리뷰 ===== */
async function submitEssay(){
  if(!currentUser){ deferredAction='review'; openAuth(); return; }

  document.getElementById('loading').style.display='block';
  document.getElementById('error').style.display='none';
  try{
    const name=document.getElementById('studentName').value;
    const question=document.getElementById('question').value;
    const passages=[...document.querySelectorAll('.passage')].map(p=>p.value);
    const essay=document.getElementById('essay').value;

    const r=await fetch('/review',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,question,passages,essay})});
    if(r.status===401){ deferredAction='review'; openAuth(); return; }
    const data=await r.json();
    if(!r.ok){ throw new Error(data.error||'오류'); }

    savedScores=data.scores; savedReasons=data.reasons;
    const { total, status } = getTotalAndStatus(savedScores);

    /* 결과 카드 그리기 (예시 버튼만 노출) */
    document.getElementById('evalSummary').innerHTML=`
      <div class="panel" style="display:flex;align-items:center;gap:14px">
        <div style="font-size:30px">${status.emoji}</div>
        <div style="flex:1">
          <div style="font-weight:900">총점 <span style="color:${status.tone}">${total}</span> / 40 ·
            <span style="color:${status.tone}">${status.label}</span></div>
          <div class="muted" style="margin-top:4px">${status.desc}</div>
          <div style="margin-top:8px;position:relative;height:10px;background:#eef2ff;border-radius:999px;overflow:hidden">
            <div style="width:${(total/40)*100}%;height:100%;background:${status.tone};transition:width .5s"></div>
            <div style="position:absolute;left:${(30/40)*100}%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.15)"></div>
            <div style="position:absolute;left:${(36/40)*100}%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.25)"></div>
          </div>
        </div>
        <div style="position:relative; width:110px; height:110px">
          <svg width="110" height="110">
            <circle r="52" cx="55" cy="55" fill="transparent" stroke="#eef2ff" stroke-width="10"></circle>
            <circle r="52" cx="55" cy="55" fill="transparent" stroke="${status.tone}" stroke-width="10"
              stroke-dasharray="327" stroke-dashoffset="${327-(327*(total/40))}"></circle>
          </svg>
          <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:900">${total}</div>
        </div>
      </div>

      <div class="kpi" style="margin-top:14px">
        ${['논리력','독해력','구성력','표현력'].map((k,i)=>`
          <div class="panel">
            <div style="font-weight:800">${k} (${savedScores[i]}점)</div>
            <div class="muted" style="margin-top:6px">${savedReasons[k]}</div>
          </div>
        `).join('')}
      </div>

      <div class="panel" style="margin-top:14px"><canvas id="scoreChart" height="140"></canvas></div>

      <div id="exampleCTA" style="text-align:right;margin-top:12px">
        <button id="btnExample" class="btn btn-primary" onclick="loadExample()">예시답안 보기</button>
      </div>
    `;

    const ctx=document.getElementById('scoreChart').getContext('2d');
    if(scoreChart) scoreChart.destroy();
    scoreChart=new Chart(ctx,{
      type:'bar',
      data:{ labels:['논리력','독해력','구성력','표현력'],
        datasets:[{ data:savedScores, backgroundColor:"rgba(33,64,177,.75)", borderRadius:8, barThickness:28, categoryPercentage:0.65 }]},
      options:{ animation:{duration:600,easing:'easeOutQuart'},
        scales:{ x:{grid:{display:false},ticks:{color:'#6B7280',font:{size:12}}},
                 y:{beginAtZero:true,max:10,ticks:{stepSize:1,color:'#9CA3AF',font:{size:11}},grid:{color:'rgba(17,24,39,.06)'}}},
        plugins:{legend:{display:false}}}
    });

    document.getElementById('loading').style.display='none';
    document.getElementById('resultCard').classList.remove('hidden');
    document.getElementById('exampleSection').classList.add('hidden'); // ✅ 사전 노출 금지
    document.getElementById('exampleNote').style.display='none';
    document.getElementById('exampleOutput').innerHTML='';
    document.getElementById('comparisonOutput').innerHTML='';
    exampleGenerated=false;

    updatePdfBtnState();
  }catch(e){
    console.error(e);
    document.getElementById('loading').style.display='none';
    document.getElementById('error').style.display='block';
  }
}

/* ===== 예시 ===== */
async function loadExample(){
  if(!currentUser){ deferredAction='example'; openAuth(); return; }
  const btn=document.getElementById('btnExample');
  const note=document.getElementById('exampleNote');
  const errId='exampleInlineErr';
  let err=document.getElementById(errId);
  if(!err){
    err=document.createElement('div');
    err.id=errId; err.className='muted';
    err.style.cssText='margin-top:6px;color:#dc2626;text-align:right';
    document.getElementById('exampleCTA')?.appendChild(err);
  }
  err.textContent='';

  btn.disabled=true; const old=btn.textContent; btn.textContent='생성 중...';

  try{
    const name=document.getElementById('studentName').value;
    const question=document.getElementById('question').value;
    const passages=[...document.querySelectorAll('.passage')].map(p=>p.value);
    const essay=document.getElementById('essay').value;
    const limit=document.getElementById('charLimit').value;
    const range=document.getElementById('charRange').value;

    const payload={ name, question, passages, essay };
    const base=parseInt(limit), rng=parseInt(range);
    if(!Number.isNaN(base)) payload.charBase=base;
    if(!Number.isNaN(rng))  payload.charRange=rng;

    const r=await fetch('/example',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(r.status===401){ deferredAction='example'; openAuth(); btn.disabled=false; btn.textContent=old; return; }
    const data=await r.json();
    if(!r.ok){ throw new Error(data.error||'오류'); }

    savedExample=data.example||''; savedComparison=data.comparison||'';
    if (data.length_note) {
  note.style.display = 'block';
  note.textContent = data.length_note;
} else if (data.length_valid === false) {
  note.style.display = 'block';
  note.textContent = '✍️ 권장 글자수 범위를 벗어났지만, 참고용 예시는 표시합니다.';
} else {
  note.style.display = 'none';
}


    document.getElementById('exampleOutput').innerHTML=(savedExample||'').replace(/\n/g,'<br>');
    document.getElementById('comparisonOutput').innerHTML=(savedComparison||'').replace(/\n/g,'<br>');

    document.getElementById('exampleSection').classList.remove('hidden'); // ✅ 이때만 열기
    document.getElementById('exampleSection').scrollIntoView({behavior:'smooth',block:'start'});
    btn.textContent='예시답안 생성됨';

   updatePdfBtnState();
  }catch(e){
    console.error(e);
    err.textContent='생성 중 문제가 있었어요. 잠시 뒤 다시 시도해 주세요.';
    btn.textContent=old; btn.disabled=false;
  }
}

/* ===== PDF ===== */
// === PDF 저장 (최종) ===
window.__pdf_version = 'v2.1-2025-10-10';

function updatePdfBtnState(){
  const b = document.getElementById('btnSavePDF');
  if(!b) return;
  b.disabled = !(savedScores?.length); // 점수 없을 때 비활성화
}

async function waitFontsAndImages(root){
  try { if (document.fonts?.ready) await document.fonts.ready; } catch(e){}
  const imgs = Array.from(root.querySelectorAll('img')).filter(i=>!i.complete);
  await Promise.all(imgs.map(img=>new Promise(res=>{ img.onload = img.onerror = res; })));
}

async function downloadPDF_v2(){
  // 0) 가드
  if (!window.html2pdf) { alert('PDF 모듈(html2pdf)이 아직 로드되지 않았습니다.'); return; }
  if (location.protocol === 'file:') { alert('file://로 열면 PDF 생성이 막힐 수 있어요. http(s) 주소로 열어주세요.'); return; }

  // 1) 버튼 잠금
  const btn = document.getElementById('btnSavePDF');
  if (btn) btn.disabled = true;

  // 2) 데이터 수집
  const name = document.getElementById('studentName').value || '이름 미입력';
  const today = new Date().toISOString().split('T')[0];
  const { total, status } = getTotalAndStatus(savedScores || []);

  // 3) 차트 이미지(있으면)
  let chartImg = '';
  try {
    const canvas = document.getElementById('scoreChart');
    if (canvas) chartImg = canvas.toDataURL('image/png', 1.0);
  } catch(e) {}

  // 4) HTML 템플릿 (백틱 사용!)
  const html = `
<div style="font-family:'SUIT',system-ui,-apple-system,'Noto Sans KR',sans-serif;color:#111827">
  <!-- 헤더 -->
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div style="display:flex;align-items:center;gap:8px">
      <img src="/static/academy_logo.png" alt="아카데미창" style="height:22px;object-fit:contain"/>
      <h2 style="margin:0;font-weight:800;letter-spacing:-.2px">다쓰 리포트</h2>
    </div>
    <div style="color:#6b7280;font-size:12px">학생: ${name} · 날짜: ${today}</div>
  </div>

  <!-- 요약 -->
  <div style="display:flex;gap:12px;align-items:center;border:1px solid #e5e7eb;border-radius:14px;padding:12px;background:#fff">
    <div style="font-size:26px">${status.emoji || '😃'}</div>
    <div style="flex:1;min-width:0">
      <div style="font-weight:900">
        총점 <span style="color:${status.tone}">${total}</span> / 40 ·
        <span style="color:${status.tone}">${status.label}</span>
      </div>
      <div style="margin-top:6px;position:relative;height:8px;background:#eef2ff;border-radius:999px;overflow:hidden">
        <div style="width:${(total/40)*100}%;height:100%;background:${status.tone}"></div>
        <div style="position:absolute;left:${(30/40)*100}%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.12)"></div>
        <div style="position:absolute;left:${(36/40)*100}%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.12)"></div>
      </div>
      <div style="margin-top:4px;color:#6b7280;font-size:12px">${status.desc}</div>
    </div>
    <div style="position:relative;width:92px;height:92px">
      <svg width="92" height="92">
        <circle r="42" cx="46" cy="46" fill="transparent" stroke="#eef2ff" stroke-width="10"></circle>
        <circle r="42" cx="46" cy="46" fill="transparent" stroke="${status.tone}" stroke-width="10"
          stroke-dasharray="${2*Math.PI*42}" stroke-dashoffset="${2*Math.PI*42 - (2*Math.PI*42*(total/40))}"></circle>
      </svg>
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:900">${total}</div>
    </div>
  </div>

  ${chartImg ? `
  <div style="margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff">
    <img src="${chartImg}" style="width:100%;height:auto;display:block"/>
  </div>` : ''}

  <div style="margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff">
    <div style="font-weight:800;margin-bottom:8px">한눈에 이해되는 리포트</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div style="padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff">
        <div style="display:inline-block;padding:4px 8px;background:#eef2ff;color:#1d4ed8;border-radius:999px;font-weight:700;font-size:12px">
          논리력 (${(savedScores?.[0] ?? 0)}점)
        </div>
        <div style="margin-top:8px;font-size:12.5px;line-height:1.6;color:#1f2937">
          ${(savedReasons?.['논리력'] || '').replace(/\\n/g,'<br>')}
        </div>
      </div>
      <div style="padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff">
        <div style="display:inline-block;padding:4px 8px;background:#eef2ff;color:#1d4ed8;border-radius:999px;font-weight:700;font-size:12px">
          독해력 (${(savedScores?.[1] ?? 0)}점)
        </div>
        <div style="margin-top:8px;font-size:12.5px;line-height:1.6;color:#1f2937">
          ${(savedReasons?.['독해력'] || '').replace(/\\n/g,'<br>')}
        </div>
      </div>
      <div style="padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff">
        <div style="display:inline-block;padding:4px 8px;background:#eef2ff;color:#1d4ed8;border-radius:999px;font-weight:700;font-size:12px">
          구성력 (${(savedScores?.[2] ?? 0)}점)
        </div>
        <div style="margin-top:8px;font-size:12.5px;line-height:1.6;color:#1f2937">
          ${(savedReasons?.['구성력'] || '').replace(/\\n/g,'<br>')}
        </div>
      </div>
      <div style="padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff">
        <div style="display:inline-block;padding:4px 8px;background:#eef2ff;color:#1d4ed8;border-radius:999px;font-weight:700;font-size:12px">
          표현력 (${(savedScores?.[3] ?? 0)}점)
        </div>
        <div style="margin-top:8px;font-size:12.5px;line-height:1.6;color:#1f2937">
          ${(savedReasons?.['표현력'] || '').replace(/\\n/g,'<br>')}
        </div>
      </div>
    </div>
  </div>

  <h3 style="margin:12px 0 6px">예시답안</h3>
  <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;font-size:13px;line-height:1.65;color:#374151;max-height:360px;overflow:hidden">
    ${(savedExample || '').replace(/\\n/g,'<br>')}
  </div>

  <h3 style="margin:12px 0 6px">비교 분석</h3>
  <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;font-size:13px;line-height:1.65;color:#374151;max-height:300px;overflow:hidden">
    ${(savedComparison || '').replace(/\\n/g,'<br>')}
  </div>
</div>`;

  // 5) 옵션
  const opt = {
    margin: 8,
    filename: `다쓰_리포트_${today}.pdf`,
    html2canvas: { scale: 2, useCORS: true, logging: false, letterRendering: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['css','legacy'] }
  };

  // 6) 생성
  let wrap = null;
  try {
    wrap = document.createElement('div');
    wrap.style.cssText = 'position:fixed;left:-99999px;top:-99999px;opacity:0;pointer-events:none;';
    wrap.innerHTML = html;
    document.body.appendChild(wrap);

    await waitFontsAndImages(wrap);
    await html2pdf().from(wrap).set(opt).save();
  } catch (e) {
    console.error(e);
    alert('PDF 생성 실패: ' + (e?.message || e));
  } finally {
    if (wrap && wrap.parentNode) wrap.parentNode.removeChild(wrap);
    if (btn) btn.disabled = false;
  }
}

  // html2pdf 옵션
  const opt = {
    margin: 8,
    filename: `다쓰_리포트_${today}.pdf`,
    html2canvas: { scale: 2, useCORS: true, logging: false, letterRendering: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['css','legacy'] }
  };

  // 임시 DOM 생성 → 리소스 로드 대기 → PDF 생성 → 정리
  let wrap = null;
  try {
    wrap = document.createElement('div');
    wrap.style.cssText = 'position:fixed;left:-99999px;top:-99999px;opacity:0;pointer-events:none;';
    wrap.innerHTML = html;
    document.body.appendChild(wrap);                 // ✅ 임시로 DOM에 부착
    await waitFontsAndImages(wrap);                  // ✅ 폰트/이미지 로드 대기
    await html2pdf().from(wrap).set(opt).save();     // ✅ PDF 생성
  } finally {
    if (wrap && wrap.parentNode) wrap.parentNode.removeChild(wrap);  // ✅ 정리
    if (btn) btn.disabled = false;                                    // 버튼 복구
  }
}

/* ===== Auth ===== */
async function fetchMe(){ try{ const r=await fetch('/auth/me'); const data=await r.json(); if(data.ok){ currentUser=data.user; paintHeader(); } }catch(e){} }
function paintHeader(){
  const loginBtn=document.getElementById('loginBtn');
  const prof=document.getElementById('profileArea');
  if(currentUser){
    loginBtn.classList.add('hidden');
    prof.classList.remove('hidden');
    const initial=(currentUser.name||currentUser.email||'A').trim()[0].toUpperCase();
    document.getElementById('avatarInitial').textContent=initial;
    document.getElementById('profileName').textContent=currentUser.name||currentUser.email;
  }else{
    prof.classList.add('hidden');
    loginBtn.classList.remove('hidden');
  }
}
function openAuth(){ document.getElementById('authWrap').classList.remove('hidden'); switchTab('login'); document.body.style.overflow='hidden'; }
function closeAuth(){ document.getElementById('authWrap').classList.add('hidden'); document.getElementById('loginError').style.display='none'; document.getElementById('registerError').style.display='none'; document.body.style.overflow=''; }
function switchTab(which){
  const l=document.getElementById('loginPanel'), r=document.getElementById('registerPanel');
  const tl=document.getElementById('tabLogin'), tr=document.getElementById('tabRegister');
  if(which==='login'){ l.classList.remove('hidden'); r.classList.add('hidden'); tl.classList.add('active'); tr.classList.remove('active'); }
  else{ r.classList.remove('hidden'); l.classList.add('hidden'); tr.classList.add('active'); tl.classList.remove('active'); }
}
async function register(){
  const body={ name:document.getElementById('regName').value, email:document.getElementById('regEmail').value, password:document.getElementById('regPassword').value };
  const r=await fetch('/auth/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const data=await r.json();
  if(!data.ok){ const el=document.getElementById('registerError'); el.style.display='block'; el.textContent=data.error||'가입에 실패했어요.'; return; }
  currentUser=data.user; paintHeader(); closeAuth();
  if(deferredAction==='goEditor'){ goToEditor(); }
  if(deferredAction==='review'){ submitEssay(); }
  if(deferredAction==='example'){ loadExample(); }
  if(deferredAction==='records'){ openRecords(true); }
  deferredAction=null;
}
async function login(){
  const body={ email:document.getElementById('loginEmail').value, password:document.getElementById('loginPassword').value };
  const r=await fetch('/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const data=await r.json();
  if(!data.ok){ const el=document.getElementById('loginError'); el.style.display='block'; el.textContent=data.error||'로그인에 실패했어요.'; return; }
  currentUser=data.user; paintHeader(); closeAuth();
  if(deferredAction==='goEditor'){ goToEditor(); }
  if(deferredAction==='review'){ submitEssay(); }
  if(deferredAction==='example'){ loadExample(); }
  if(deferredAction==='records'){ openRecords(true); }
  deferredAction=null;
}
async function logout(){ await fetch('/auth/logout',{method:'POST'}); currentUser=null; paintHeader(); }
window.addEventListener('DOMContentLoaded', fetchMe);

/* 프로필 메뉴 토글 */
document.addEventListener('click', (e)=>{
  const btn=document.getElementById('profileBtn');
  const menu=document.getElementById('profileMenu');
  if(btn && btn.contains(e.target)){ menu.style.display = (menu.style.display==='block'?'none':'block'); }
  else if(menu && !menu.contains(e.target)){ menu.style.display='none'; }
});

/* 모달 백드롭/ESC */
window.addEventListener('DOMContentLoaded', ()=>{
  const authWrap=document.getElementById('authWrap');
  if(authWrap){ authWrap.addEventListener('click', e=>{ if(e.target===authWrap) closeAuth(); }); }
  const recWrap=document.getElementById('recordsWrap');
  if(recWrap){ recWrap.addEventListener('click', e=>{ if(e.target===recWrap) closeRecords(); }); }
  document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeAuth(); closeRecords(); } });
  document.getElementById('authWrap').classList.add('hidden'); // 초기 자동 오픈 방지
});

/* 기록 모달 */
async function openRecords(authed=false){
  if(!currentUser && !authed){ deferredAction='records'; openAuth(); return; }
  document.getElementById('recordsWrap').classList.remove('hidden');
  document.body.style.overflow='hidden';
  const box=document.getElementById('recordsList'); box.textContent='불러오는 중…';
  try{
    const r=await fetch('/reports'); const j=await r.json();
    if(!r.ok){ box.textContent=j.error||'오류'; return; }
    if(!j.items.length){ box.textContent='아직 저장된 기록이 없습니다.'; return; }
    box.innerHTML = j.items.map(it=>`
      <div style="padding:8px 0; border-bottom:1px solid #f3f4f6">
        <div><b>${(it.student||'무명')}</b> · ${it.total??'-'}점 <span class="muted">(${it.status||'-'})</span></div>
        <div class="muted" style="font-size:12px">${new Date(it.created_at).toLocaleString()}</div>
      </div>
    `).join('');
  }catch{ box.textContent='네트워크 오류'; }
}
function closeRecords(){ document.getElementById('recordsWrap').classList.add('hidden'); document.body.style.overflow=''; }
</script>
</body>
</html>
