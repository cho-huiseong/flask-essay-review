<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì•„ì¹´ë°ë¯¸ì°½ Â· ë‹¤ì“° ë¦¬í¬íŠ¸</title>

<!-- í°íŠ¸/ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
:root{
  --brand:#2140B1; --brand-700:#1a2f91;
  --ink:#111827; --muted:#6B7280; --line:rgba(17,24,39,.10);
  --bg:#f7f9ff; --white:#fff;
}
*{ box-sizing:border-box; font-family:'SUIT',system-ui,sans-serif; letter-spacing:-.2px }
html,body{ margin:0; color:var(--ink); background:var(--bg) }
a{ color:inherit; text-decoration:none }
.hidden{ display:none !important }
.muted{ color:var(--muted) }
.container{ max-width:1180px; margin:0 auto; padding:0 24px }

/* í—¤ë” */
header{
  position:sticky; top:0; z-index:20; background:rgba(255,255,255,.75);
  backdrop-filter:blur(10px); border-bottom:1px solid var(--line);
}
.nav{ height:66px; display:flex; align-items:center; justify-content:space-between }
.nav-left{ display:flex; align-items:center; gap:10px; font-weight:900 }
.nav-right{ display:flex; gap:12px; align-items:center }
.btn{ border:none; height:44px; padding:0 18px; border-radius:14px; font-weight:800; cursor:pointer; transition:.2s }
.btn-primary{ background:var(--brand); color:#fff; box-shadow:0 8px 20px rgba(33,64,177,.18) }
.btn-primary:hover{ transform:translateY(-1px); box-shadow:0 12px 28px rgba(33,64,177,.22) }
.btn-ghost{ background:#fff; border:1px solid #e5e7eb }
.avatar{ width:32px; height:32px; border-radius:50%; background:#EEF2FF; color:#2140B1; display:flex; align-items:center; justify-content:center; font-weight:900 }
.dropdown{ position:relative }
.dropdown-menu{ position:absolute; right:0; top:44px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 12px 30px rgba(17,24,39,.12); padding:8px; min-width:160px; display:none }
.dropdown-menu a, .dropdown-menu button{ display:block; width:100%; text-align:left; background:transparent; border:none; padding:8px 10px; border-radius:8px; font-weight:700; color:#374151; cursor:pointer }
.dropdown-menu a:hover, .dropdown-menu button:hover{ background:#f3f4f6 }

/* HERO */
.hero{
  padding:88px 0 40px;
  background:
    radial-gradient(1200px 600px at 80% -30%, rgba(33,64,177,.22), transparent),
    radial-gradient(900px 500px at -10% 20%, rgba(33,64,177,.12), transparent),
    linear-gradient(180deg, #ffffff 0%, #f7f9ff 60%);
  border-bottom:1px solid var(--line);
}
.hero h1{ margin:0 0 12px; font-size:clamp(36px,6vw,64px); line-height:1.08; font-weight:900 }
.hero p{ margin:0 0 24px; font-size:18px; color:#4b5563 }

/* ============== 3-STEP ë°ëª¨ ============== */
.container.wide{ max-width:1440px; }                      /* 480(ì¹´í”¼)+1120(ëª¨ë‹ˆí„°)+ì—¬ë°± */
.step{ padding:70px 0; }
.step-grid{ display:grid; gap:24px; align-items:center }
.step-grid.fixed{ grid-template-columns:400px 960px; } /* ëª¨ë‹ˆí„° 1120px ê³ ì • */
@media(max-width:1440px){ .step-grid.fixed{ grid-template-columns:1fr; } }
.step h2{ margin:0 0 8px; font-size:32px; font-weight:900 }
.step p{ margin:0; color:#6b7280 }
.step .cta-row{ display:flex; gap:10px; margin-top:12px }
.monitor{
  border-radius:22px; padding:16px; background:rgba(255,255,255,.8);
  border:1px solid rgba(229,231,235,.8); box-shadow:0 30px 60px rgba(33,64,177,.14), inset 0 0 0 1px #eef2ff;
}
.monitor .bar{ height:22px; display:flex; align-items:center; gap:8px; padding:0 10px; }
.dot{ width:10px; height:10px; border-radius:50% }
.dot.red{ background:#ff5f57 } .dot.yellow{ background:#ffbd2e } .dot.green{ background:#28c840 }
.screen{ border-radius:16px; background:#fff; border:1px solid #eef2ff; overflow:hidden; }
.viewport{ position:relative; overflow:hidden }
.stage{ width:1120px; margin:0 auto; padding:18px; transform-origin: top center; }

/* ì…ë ¥/ê²°ê³¼ ë°ëª¨ ìŠ¤íƒ€ì¼ */
.panel{ background:rgba(255,255,255,.6); backdrop-filter:blur(14px); border:1px solid rgba(255,255,255,.5);
  border-radius:22px; padding:22px; box-shadow:0 10px 30px rgba(17,24,39,.1) }
.form-label{ font-weight:900; margin:12px 0 6px; display:block }
.input,.textarea{ width:100%; padding:14px 16px; border:1px solid #e5e7eb; border-radius:12px; font-size:16px; line-height:1.6; resize:none }
.input:focus,.textarea:focus{ outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(33,64,177,.18) }
.textarea::placeholder,.input::placeholder{ color:#9CA3AF }
#passages,
#passagesDemo{
  display:grid; grid-template-columns:1fr 1fr; gap:14px;
}
@media (max-width:680px){ #passages{ grid-template-columns:1fr } }
.kpi{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
@media (max-width:900px){ .kpi{ grid-template-columns:1fr } }
canvas.demoChart{ height:140px !important; }
.divider{ height:1px; background:var(--line); margin:14px 0 }

/* ëª¨ë‹¬ */
.modal-backdrop{ position:fixed; inset:0; background:rgba(17,24,39,.4); display:flex; align-items:center; justify-content:center; z-index:50 }
.modal{ width:min(560px,90vw); background:#fff; border-radius:18px; border:1px solid #e5e7eb; box-shadow:0 24px 60px rgba(17,24,39,.22); padding:18px }
.modal-backdrop.hidden{ display:none !important; }
.tabs{ display:flex; gap:8px; margin-bottom:12px }
.tab{ flex:1; height:40px; border-radius:999px; border:1px solid #e5e7eb; background:#f8fafc; font-weight:800; cursor:pointer }
.tab.active{ background:#EEF2FF; border-color:#dbe4ff; color:var(--brand-700) }
.row{ display:flex; gap:10px }
/* >>> PDF SCOPE START (ë¦¬ë‰´ì–¼) */
.pdf-mode .pdf-scope { 
  display:block !important; 
}

/* ê³µí†µ íƒ€ì´í¬ & í˜ì´ì§€ ê¸°ë³¸ */
.pdf-scope{
  font-family:'SUIT',system-ui,sans-serif;
  color:#111827;
  font-size:12px;
}

.pdf-scope .page{
  box-sizing:border-box;
  padding:18mm 18mm 16mm;
  display:flex;
  flex-direction:column;
  gap:8mm;
  page-break-after:always;
  break-after:page;
}


/* ìˆ˜ë™ í˜ì´ì§€ ë¸Œë ˆì´í¬ìš© */
.pdf-scope .page-break{
  break-before:page;
  page-break-before:always;
}

/* í—¤ë”/í‘¸í„° */
.pdf-scope .header,
.pdf-scope .footer{
  display:flex;
  align-items:center;
  justify-content:space-between;
  color:#2140B1;
  font-weight:600;
  font-size:11px;
  opacity:.95;
}

.pdf-scope .header{
  padding-bottom:6px;
  border-bottom:1px solid rgba(33,64,177,0.15);
}

.pdf-scope .footer{
  padding-top:6px;
  border-top:1px solid rgba(33,64,177,0.12);
  margin-top:auto;
}

/* ì¹´ë“œ(ìœ ë¦¬ì¹´ë“œ í†¤) */
.pdf-scope .card{
  background:rgba(255,255,255,0.94);
  backdrop-filter:blur(8px);
  -webkit-backdrop-filter:blur(8px);
  border-radius:14px;
  border:1px solid rgba(148,163,184,0.35);
  box-shadow:0 8px 20px rgba(15,23,42,0.06);
  padding:12px 14px;
  margin:4px 0;
}

/* í…ìŠ¤íŠ¸/ë ˆì´ì•„ì›ƒ ìœ í‹¸ */
.pdf-scope .section-title{
  font-weight:800;
  font-size:13px;
  color:#2140B1;
  margin-bottom:6px;
}

.pdf-scope .muted{
  color:#6B7280;
  font-size:11px;
}

.pdf-scope .pdf-text{
  white-space:normal;
  word-break:break-word;
  overflow:visible;
  line-height:1.6;
}

.pdf-scope .avoid-break{
  break-inside:avoid;
  page-break-inside:avoid;
}

/* ê·¸ë¦¬ë“œ */
.pdf-scope .grid-2{
  display:grid;
  grid-template-columns:1.1fr 1.2fr;
  gap:10px;
}
.pdf-scope .grid-2-vertical{
  display:grid;
  grid-template-columns:1fr;
  gap:6px;
}

/* í‘œì§€(ì»¤ë²„) ë ˆì´ì•„ì›ƒ */
.pdf-scope .cover-hero{
  padding:18px 18px 14px;
  border-radius:16px;
  background:linear-gradient(135deg,rgba(33,64,177,0.09),rgba(33,64,177,0));
  border:1px solid rgba(129,140,248,0.35);
}

.pdf-scope .cover-title-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:8px;
}

.pdf-scope .cover-title-main{
  font-size:20px;
  font-weight:900;
  color:#1f2937;
}

.pdf-scope .cover-sub{
  margin-top:4px;
  line-height:1.5;
}

/* ìƒíƒœ ë°°ì§€/í•„ */
.pdf-scope .status-badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:700;
  border:1px solid rgba(148,163,184,0.6);
  background:#ffffff;
  color:#374151;
  white-space:nowrap;
}

.pdf-scope .status-pill{
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:3px 9px;
  border-radius:999px;
  font-size:11px;
  font-weight:700;
  border:1px solid rgba(148,163,184,0.7);
  background:#f9fafb;
}

/* í•©ê²©/ë³´ë¥˜/ë‹¤ì‹œì“°ê¸° ìƒ‰ì€ JSì—ì„œ í…ìŠ¤íŠ¸ ìœ„ì£¼ë¡œ, ìƒ‰ì€ ê³µí†µ ìœ ì§€ */

/* í‰ê°€ ìš”ì•½ ë ˆì´ì•„ì›ƒ */
.pdf-scope .score-layout{
  display:flex;
  align-items:flex-start;
  gap:10px;
}

.pdf-scope .score-left{
  flex:1.5;
}

.pdf-scope .score-right{
  flex:1;
  text-align:center;
}

.pdf-scope .score-main-line{
  font-weight:800;
  margin-bottom:4px;
}

.pdf-scope .score-main-desc{
  margin-bottom:8px;
}

.pdf-scope .score-cards{
  display:grid;
  grid-template-columns:1fr;
  gap:8px;
}

.pdf-scope .score-item{
  padding:8px 9px;
  border-radius:10px;
  border:1px solid rgba(226,232,240,0.9);
  background:#f9fafb;
}

.pdf-scope .score-item-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
  font-weight:700;
}

.pdf-scope .score-item-name{
  color:#111827;
}

.pdf-scope .score-item-value{
  color:#2140B1;
}

/* ì œì‹œë¬¸ ë¸”ë¡ */
.pdf-scope .passage-block{
  margin-bottom:8px;
}

.pdf-scope .passage-label{
  font-weight:700;
  color:#4b5563;
  margin-bottom:2px;
  font-size:11px;
}

.pdf-scope .passage-body{
  line-height:1.6;
}

/* í‘œ */
.pdf-scope table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
.pdf-scope thead th{
  background:rgba(33,64,177,0.06);
  color:#2140B1;
  font-weight:700;
}
.pdf-scope th,
.pdf-scope td{
  border:1px solid rgba(17,24,39,0.1);
  padding:8px;
  vertical-align:top;
}
.pdf-scope thead{
  display:table-header-group;
}
/* <<< PDF SCOPE END */

#loginBtn, #profileArea { display: none !important; }

/* ì œì‹œë¬¸ ì´ë¯¸ì§€ í”„ë¦¬ë·° */
.passage-preview{
  margin-top:6px;
  border-radius:12px;
  border:1px solid rgba(148,163,184,0.35);
  padding:6px;
  background:#f9fafb;
}
.passage-preview img{
  max-width:100%;
  display:block;
  border-radius:8px;
}
/* ì œì‹œë¬¸ ì´ë¯¸ì§€ ì‚­ì œ ë²„íŠ¼ */
.passage-preview {
  position: relative;
}

.passage-preview .remove-img-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  background: rgba(0,0,0,0.6);
  color: #fff;
  border: none;
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 4px;
  cursor: pointer;
}
/* ===== ê¸€ë¡œë²Œ ë¡œë”© ì˜¤ë²„ë ˆì´ ===== */
.loading-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.18);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.loading-card{
  min-width:260px;
  max-width:320px;
  background:rgba(255,255,255,0.98);
  border-radius:20px;
  border:1px solid rgba(148,163,184,0.45);
  box-shadow:0 24px 60px rgba(15,23,42,0.25);
  padding:18px 18px 16px;
  display:flex;
  gap:14px;
  align-items:flex-start;
}

.loading-main{
  display:flex;
  flex-direction:column;
  gap:4px;
}

.loading-title{
  font-weight:800;
  font-size:14px;
  color:#111827;
}
.loading-sub{
  font-size:12px;
  color:#6B7280;
}

/* í˜ì´í¼ ìŠ¤í”¼ë„ˆ */
.paper-spinner{
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  perspective:600px;
}

.paper{
  width:30px;
  height:38px;
  border-radius:8px;
  background:#ffffff;
  border:1px solid rgba(148,163,184,0.7);
  box-shadow:0 10px 22px rgba(15,23,42,0.22);
  padding:5px 6px;
  display:flex;
  flex-direction:column;
  gap:3px;
  transform-origin:center center;
  animation:spinPaper 1.15s linear infinite;
}

.paper-line{
  height:3px;
  border-radius:999px;
  background:rgba(148,163,184,0.8);
}
.paper-header{
  width:72%;
  background:rgba(37,99,235,0.95);
}
.paper-line.short{
  width:60%;
}

@keyframes spinPaper{
  0%   { transform:rotateY(0deg) translateY(0); opacity:1; }
  45%  { transform:rotateY(180deg) translateY(-1px); opacity:0.9; }
  100% { transform:rotateY(360deg) translateY(0); opacity:1; }
}
</style>
</head>

<body>
<header>
  <div class="container nav">
    <div class="nav-left" style="gap:10px">
      <img src="/static/academy_logo.png" alt="ì•„ì¹´ë°ë¯¸ì°½" style="height:20px;object-fit:contain">
      <span style="font-weight:900">ì•„ì¹´ë°ë¯¸ì°½</span>
    </div>
    <div class="nav-right">
      <div id="profileArea" class="dropdown hidden">
        <div id="profileBtn" class="btn btn-ghost" style="display:flex;align-items:center;gap:8px">
          <div class="avatar" id="avatarInitial">A</div>
          <span id="profileName" class="muted" style="font-weight:800"></span>
        </div>
        <div class="dropdown-menu" id="profileMenu">
          <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
      <button id="loginBtn" class="btn btn-ghost" onclick="openAuth()">ë¡œê·¸ì¸</button>
      <button class="btn btn-primary" onclick="goToEditor()">AI ì²¨ì‚­í•˜ê¸°</button>
    </div>
  </div>
</header>

<main>
  <!-- HERO -->
  <section id="homeSection" class="hero">
    <div class="container">
      <h1>ê¸€ í‰ê°€ì™€ ì˜ˆì‹œ ì‘ì„±,<br/>ë°”ë¡œ ì²´í—˜í•´ ë³´ì„¸ìš”</h1>
      <p>ì…ë ¥ â†’ í‰ê°€ â†’ ì˜ˆì‹œë‹µì•ˆ Â· ì°¨ì´ì ê¹Œì§€, ì‹¤ì œ í™”ë©´ í¬ê¸°ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>
      <div style="display:flex; gap:12px; flex-wrap:wrap">
        <button class="btn btn-primary" style="height:52px" onclick="document.getElementById('step1').scrollIntoView({behavior:'smooth'});">ì²´í—˜ ì‹œì‘</button>
      </div>
    </div>
  </section>

  <!-- STEP 1 -->
  <section id="step1" class="step">
    <div class="container wide step-grid fixed">
      <div>
        <h2>1. ì…ë ¥í•˜ê¸°</h2>
        <p>í•™ìƒÂ·ì§ˆë¬¸Â·ì œì‹œë¬¸(ì—¬ëŸ¬ ê°œ)Â·ë…¼ìˆ ë¬¸ì„ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸°ë§Œ í•˜ì„¸ìš”. ê¸€ì ìˆ˜ëŠ” ìë™ìœ¼ë¡œ ì„¸ê³ , ì œì‹œë¬¸ì€ ë²„íŠ¼ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì¶”ê°€ë¼ìš”.</p>
        <div class="cta-row"><button class="btn btn-primary" onclick="document.getElementById('step2').scrollIntoView({behavior:'smooth'});">ë‹¤ìŒ ë‹¨ê³„</button></div>
      </div>
      <div class="monitor">
        <div class="bar"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
        <div class="screen">
          <div class="viewport" data-demo="input" data-stage="960">
            <div class="stage input-demo">
              <h3 style="margin:0 0 6px;font-weight:900">âœ¨ ë„ˆì˜ ê¸€, ì˜¤ëŠ˜ ë” ë©€ë¦¬ ë‚ ì•„ê°€ê²Œ.</h3>
              <p class="muted" style="margin-top:0">ì •ì„±ê» ì“´ ë¬¸ì¥ ìœ„ì— í•„ìš”í•œ í”¼ë“œë°±ë§Œ ì–¹ì–´, ëª©í‘œì— ë‹¿ë„ë¡ ë¶€ë“œëŸ½ê²Œ ì´ëŒì–´ ë“œë¦´ê²Œìš”.</p>

              <label class="form-label">í•™ìƒ ì´ë¦„</label>
              <div class="panel" style="padding:12px">í™ê¸¸ë™</div>

              <label class="form-label">ì§ˆë¬¸</label>
              <div class="panel" style="padding:12px" data-demo-question>ì œì‹œë¬¸ì„ ë°”íƒ•ìœ¼ë¡œ 'ê³µì •'ì˜ ì˜ë¯¸ë¥¼ ì •ì˜í•˜ê³ , ì‚¬íšŒì  ì•½ì ë³´í˜¸ì˜ ê´€ì ì—ì„œ ê·¸ ì •ë‹¹ì„±ì„ ë…¼í•˜ì‹œì˜¤.</div>

              <label class="form-label">
                ì œì‹œë¬¸ <span class="muted">(ìµœì†Œ 1ê°œ)</span>
              </label>
              <p class="muted" style="margin:4px 0 6px;">
                ì œì‹œë¬¸ì€ <b>í…ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ì–´</b> ì£¼ì‹œë©´ ë¼ìš”.<br>
                í•„ìš”í•˜ë‹¤ë©´ <b>ì‚¬ì§„ íŒŒì¼ì„ ì¶”ê°€í•´ì„œ ì›ë³¸ ì´ë¯¸ì§€ë¥¼ í•¨ê»˜ ë³´ê´€</b>í•  ìˆ˜ë„ ìˆì§€ë§Œ,
                ì‚¬ì§„ì€ ê¸€ìë¡œ ë°”ê¾¸ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ë³´ì—¬ë“œë ¤ìš”.
              </p>

              <div id="passagesDemo">
                <textarea
                  class="passage textarea"
                  rows="3"
                  placeholder="ì œì‹œë¬¸ì„ ê·¸ëŒ€ë¡œ ì ì–´ ì£¼ì„¸ìš”. (ë³µì‚¬í•œ ê¸€ì„ ë¶™ì—¬ë„£ì–´ë„ ë¼ìš”.)"></textarea>
              </div>



              <label class="form-label">ë…¼ìˆ ë¬¸</label>
              <div class="panel" style="padding:12px">
                ë‚˜ëŠ” ê³µì •ì„ ê²°ê³¼ì˜ ê· ë“±ì´ ì•„ë‹ˆë¼ ê¸°íšŒì˜ ê· ë“±ìœ¼ë¡œ ì´í•´í•œë‹¤. ê°™ì€ ê·œì¹™ì´ ì£¼ì–´ì ¸ë„ ì¶œë°œì„ ì´ ê¸°ìš¸ì–´ ìˆìœ¼ë©´ ê²½ìŸì€ ê³µì •í•´ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤. â€¦ (ìƒëµ) â€¦ ì¶œë°œì„ ì˜ ê· í˜•ê³¼ ê²°ê³¼ì˜ ì±…ì„ì´ í•¨ê»˜ ì‘ë™í•  ë•Œ ìš°ë¦¬ëŠ” ë¹„ë¡œì†Œ ê³µì •í•˜ë‹¤ê³  ë§í•  ìˆ˜ ìˆë‹¤.
              </div>

              <label class="form-label">ê¸€ì ìˆ˜ ì œí•œ</label>
              <div class="row">
                <div class="panel" style="padding:12px;flex:1">ê¸°ì¤€ 700</div>
                <div class="panel" style="padding:12px;flex:1">Â± 50</div>
              </div>
              <div style="text-align:center;margin-top:10px"><button class="btn btn-primary">âš¡ ë¦¬í¬íŠ¸ ìƒì„±</button></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- STEP 2 -->
  <section id="step2" class="step">
    <div class="container wide step-grid fixed">
      <div>
        <h2>2. í‰ê°€ ë°›ê¸°</h2>
        <p>ë…¼ë¦¬Â·ë…í•´Â·êµ¬ì„±Â·í‘œí˜„ 4ê°œ í•­ëª© ì ìˆ˜ì™€ ì´ìœ ë¥¼ í•œ í™”ë©´ì—ì„œ í™•ì¸í•˜ì„¸ìš”. í•©ê²©/ì˜ˆë¹„/ë‹¤ì‹œì“°ê¸° ê¸°ì¤€ë„ í•¨ê»˜ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.</p>
        <div class="cta-row"><button class="btn btn-primary" onclick="document.getElementById('step3').scrollIntoView({behavior:'smooth'});">ë‹¤ìŒ ë‹¨ê³„</button></div>
      </div>
      <div class="monitor">
        <div class="bar"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
        <div class="screen">
          <div class="viewport" data-demo="score" data-stage="960">
            <div class="stage">
              <div class="panel" style="margin-bottom:10px">
                <div style="display:flex;align-items:center;gap:14px">
                  <div style="font-size:28px">ğŸ™‚</div>
                  <div style="flex:1">
                    <div style="font-weight:900">ì´ì  <span style="color:#10b981">37</span> / 40 Â· <span style="color:#10b981">í•©ê²©</span></div>
                    <div class="muted" style="margin-top:4px">ê·¼ê±° ë°°ì—´ê³¼ ë¬¸ì¥ì˜ ì—°ê²°ì´ ìì—°ìŠ¤ëŸ½ìŠµë‹ˆë‹¤.</div>
                    <div style="margin-top:8px;position:relative;height:10px;background:#eef2ff;border-radius:999px;overflow:hidden">
                      <div style="width:92.5%;height:100%;background:#10b981"></div>
                      <div style="position:absolute;left:75%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.15)"></div>
                      <div style="position:absolute;left:90%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.25)"></div>
                    </div>
                  </div>
                  <div style="position:relative;width:110px;height:110px">
                    <svg width="110" height="110">
                      <circle r="52" cx="55" cy="55" fill="transparent" stroke="#eef2ff" stroke-width="10"></circle>
                      <circle r="52" cx="55" cy="55" fill="transparent" stroke="#10b981" stroke-width="10"
                        stroke-dasharray="327" stroke-dashoffset="49"></circle>
                    </svg>
                    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:900">37</div>
                  </div>
                </div>
              </div>

              <div class="kpi">
                <div class="panel"><div style="font-weight:800">ë…¼ë¦¬ë ¥ (9)</div><div class="muted" style="margin-top:6px">ì£¼ì¥-ê·¼ê±°-ì˜ˆì‹œê°€ ì§ì„ ì´ë£¨ë©° ë°˜ë¡  ëŒ€ë¹„ê°€ í¬í•¨ë¨.</div></div>
                <div class="panel"><div style="font-weight:800">ë…í•´ë ¥ (9)</div><div class="muted" style="margin-top:6px">ì œì‹œë¬¸ í•µì‹¬ì„ ì •í™•íˆ ìš”ì•½í•˜ê³  ìƒí˜¸ê´€ê³„ë¥¼ ë°˜ì˜.</div></div>
                <div class="panel"><div style="font-weight:800">êµ¬ì„±ë ¥ (9)</div><div class="muted" style="margin-top:6px">ë¬¸ë‹¨ ì „í™˜ì´ ë§¤ë„ëŸ½ê³  ë‹¨ë½ ëª©í‘œê°€ ëª…í™•í•¨.</div></div>
                <div class="panel"><div style="font-weight:800">í‘œí˜„ë ¥ (10)</div><div class="muted" style="margin-top:6px">ì–´íœ˜ ì„ íƒì´ ì ì ˆí•˜ê³  ë¬¸ë²• ì˜¤ë¥˜ê°€ ê±°ì˜ ì—†ìŒ.</div></div>
              </div>

              <div style="margin-top:14px" class="panel">
                <canvas id="demoChart" class="demoChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- STEP 3 -->
  <section id="step3" class="step">
    <div class="container wide step-grid fixed">
      <div>
        <h2>3. ì˜ˆì‹œë‹µì•ˆ Â· ë¹„êµë¶„ì„</h2>
        <p>ì˜ˆì‹œë‹µì•ˆ ë³´ê¸°ë¥¼ ëˆ„ë¥´ë©´ ë‚´ ê¸€ê³¼ ë‹¤ë¥¸ ì ì„ ì¤„ê¸€ë¡œ ì •ë¦¬í•´ ë“œë ¤ìš”. ë§ˆìŒì— ë“¤ë©´ PDF ì €ì¥í•˜ê³ , ë‚´ ê¸°ë¡ì—ì„œ ì–¸ì œë“  ë‹¤ì‹œ ë³¼ ìˆ˜ ìˆì–´ìš”.</p>
        <div class="cta-row">
          <button class="btn btn-primary" onclick="location.hash='#editor'">ë‚´ ê¸€ë¡œ ì‹œì‘í•˜ê¸°</button>
        </div>
      </div>
      <div class="monitor">
        <div class="bar"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
        <div class="screen">
          <div class="viewport" data-demo="example" data-stage="960">
            <div class="stage">
              <div class="panel">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
                  <h3 style="margin:0">ğŸ“ ì˜ˆì‹œë‹µì•ˆ</h3>
                  <button id="demoExampleBtn" class="btn btn-primary" onclick="renderDemoExample()">ì˜ˆì‹œë‹µì•ˆ ë³´ê¸°</button>
                </div>
                <p class="muted" style="margin-top:6px">ê¶Œì¥ ê¸€ììˆ˜ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë„ ì°¸ê³ ìš© ì˜ˆì‹œëŠ” í‘œì‹œë©ë‹ˆë‹¤.</p>
                <div id="demoExampleWrap" class="hidden">
                  <div id="demoExampleText" class="panel" style="background:#fff"></div>
                  <div class="panel" style="background:#fff;margin-top:12px">
                    <h3 style="margin:0">ğŸ” ë¹„êµ ë¶„ì„</h3>
                    <div id="demoComparisonText" style="margin-top:8px;line-height:1.8"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ì‹¤ì œ ì—ë””í„° -->
  <section id="editorSection" class="hidden" style="visibility:hidden; padding:56px 0">
    <div class="container">

      <!-- ì…ë ¥ -->
      <div id="inputPanel" class="panel">
        <h2 style="margin:0 0 12px; font-weight:900">âœ¨ ë„ˆì˜ ê¸€, ì˜¤ëŠ˜ ë” ë©€ë¦¬ ë‚ ì•„ê°€ê²Œ.</h2>
        <p class="muted" style="margin-top:0">ì •ì„±ê» ì“´ ë¬¸ì¥ ìœ„ì— í•„ìš”í•œ í”¼ë“œë°±ë§Œ ì–¹ì–´, ëª©í‘œì— ë‹¿ë„ë¡ ë¶€ë“œëŸ½ê²Œ ì´ëŒì–´ ë“œë¦´ê²Œìš”.</p>

                <label class="form-label">í•™ìƒ ì´ë¦„</label>
        <input id="studentName" class="input" placeholder="ì˜ˆ: í™ê¸¸ë™" />

        <!-- ğŸ”½ ì§ˆë¬¸ + êµì¬ ë¶ˆëŸ¬ì˜¤ê¸° ì˜ì—­ -->
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
          <label class="form-label" style="margin:0">ì§ˆë¬¸</label>

          <div style="display:flex; align-items:center; gap:6px; font-size:13px;">
            <span class="muted">êµì¬ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</span>

            <select id="bookMainStageSelect" class="input" style="width:auto; min-width:90px;">
              <option value="">ë‹¨ê³„</option>
            </select>

            <select id="bookSubStageSelect" class="input" style="width:auto; min-width:90px;">
              <option value="">êµì¬</option>
            </select>

            <select id="bookPageSelect" class="input" style="width:auto; min-width:90px;">
              <option value="">í˜ì´ì§€</option>

              <!-- JSì—ì„œ í•´ë‹¹ ë‹¨ê³„ì˜ í˜ì´ì§€ ëª©ë¡ ìë™ ì±„ì›€ -->
            </select>

            <button type="button" class="btn btn-ghost" onclick="applyBookProblem()">
              ë¶ˆëŸ¬ì˜¤ê¸°
            </button>
          </div>
        </div>

        <textarea
          id="question"
          class="textarea"
          rows="2"
          placeholder="ì§ˆë¬¸ì„ ì—¬ê¸°ì— ì‘ì„±í•´ ì£¼ì„¸ìš”."></textarea>
          
                <!-- ğŸ”½ ì—¬ê¸°ë¶€í„° ìƒˆë¡œ ì¶”ê°€: ì œì‹œë¬¸ ì˜ì—­ -->
        <label class="form-label">
          ì œì‹œë¬¸ <span class="muted">(ìµœì†Œ 1ê°œ)</span>
        </label>
        <p class="muted" style="margin:4px 0 6px;">
          ì œì‹œë¬¸ì€ <b>í…ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ì–´</b> ì£¼ì‹œë©´ ë¼ìš”.<br>
          í•„ìš”í•˜ë‹¤ë©´ <b>ì‚¬ì§„ íŒŒì¼ì„ ì¶”ê°€í•´ì„œ ì›ë³¸ ì´ë¯¸ì§€ë¥¼ í•¨ê»˜ ë³´ê´€</b>í•  ìˆ˜ë„ ìˆì§€ë§Œ,
          ì‚¬ì§„ì€ ê¸€ìë¡œ ë°”ê¾¸ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ë³´ì—¬ë“œë ¤ìš”.
        </p>

        <div id="passages">
          <textarea
            class="passage textarea"
            rows="3"
            placeholder="ì œì‹œë¬¸ì„ ê·¸ëŒ€ë¡œ ì ì–´ ì£¼ì„¸ìš”. (ë³µì‚¬í•œ ê¸€ì„ ë¶™ì—¬ë„£ì–´ë„ ë¼ìš”.)"></textarea>
        </div>

        <!-- ğŸ”½ ì œì‹œë¬¸: ì‚¬ì§„ì—ì„œ ê°€ì ¸ì˜¤ê¸° + ì œì‹œë¬¸ ì¶”ê°€ ë²„íŠ¼ -->
        <div style="display:flex; justify-content:space-between; margin-top:8px; gap:8px;">
          <button type="button" id="btnPassageOcr" class="btn btn-ghost">
            ğŸ“¸ ì œì‹œë¬¸ ì‚¬ì§„ íŒŒì¼ ì¶”ê°€
          </button>
          <button type="button" id="btnAddPassage" class="btn btn-ghost">
            â• ì œì‹œë¬¸ ë” ì¶”ê°€
          </button>
        </div>
        <p class="muted" style="margin:4px 0 0; font-size:13px;">
          ì œì‹œë¬¸ ì‚¬ì§„ì€ <b>íŒŒì¼ì—ì„œ ì„ íƒí•˜ê±°ë‚˜, ì œì‹œë¬¸ ì¹¸ì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸°</b> í•˜ì…”ë„ ë¼ìš”.<br>
          ì‚¬ì§„ì€ ê¸€ìë¡œ ë°”ê¾¸ì§€ ì•Šê³  <b>ì›ë³¸ ì´ë¯¸ì§€ ê·¸ëŒ€ë¡œ</b> ì°¸ê³ ìš©ìœ¼ë¡œ ë³´ê´€ë©ë‹ˆë‹¤.
        </p>



<!-- ì œì‹œë¬¸ìš© ìˆ¨ì€ íŒŒì¼ ì…ë ¥ -->
<input
  id="passageImageInput"
  type="file"
  accept="image/*"
  multiple
  style="display:none" />


        <!-- ğŸ”¼ ì œì‹œë¬¸ ì˜ì—­ ë -->
        <label class="form-label">
          ë…¼ìˆ ë¬¸ <span class="muted">(í•™ìƒ ì‘ì„± ê¸€)</span>
        </label>
        <p class="muted" style="margin:4px 0 6px;">
          í•™ìƒì´ ì¢…ì´ì— ì“´ ë‹µì•ˆì€ <b>ì‚¬ì§„ì„ ë¶™ì—¬ë„£ê±°ë‚˜ íŒŒì¼ë¡œ ì˜¬ë¦¬ë©´</b>
          ìë™ìœ¼ë¡œ <b>í…ìŠ¤íŠ¸ë¡œ ë³€í™˜</b>í•´ ë“œë¦´ê²Œìš”.<br>
          ì œì‹œë¬¸ì— ì—†ëŠ” ë°°ê²½ì§€ì‹ì€ ìµœëŒ€í•œ ì¤„ì´ê³ , ì œì‹œë¬¸ë§Œ ê·¼ê±°ë¡œ ì¨ ì£¼ì„¸ìš”.
        </p>
        <textarea
          id="essay"
          class="textarea"
          rows="6"
          placeholder="ì œì‹œë¬¸ë§Œ ê·¼ê±°ë¡œ, ë°°ê²½ì§€ì‹ ì—†ì´ ì‘ì„±í•´ ì£¼ì„¸ìš”. (ì¢…ì´ì— ì“´ ë‹µì•ˆì€ ì‚¬ì§„ì„ ë¶™ì—¬ë„£ìœ¼ë©´ ê¸€ìë¡œ ë°”ë€ë‹ˆë‹¤.)"
          oninput="updateCharCount()"></textarea>
        <div id="charCount" class="muted" style="margin-top:6px"></div>
        
        <!-- ğŸ†• ì‚¬ì§„ì—ì„œ ê¸€ ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼ + ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ -->
        <div style="margin-top:6px; display:flex; justify-content:flex-end; gap:8px;">
          <button type="button" id="btnEssayOcr" class="btn btn-ghost">
            ğŸ“¸ ì‚¬ì§„ì—ì„œ ê¸€ â†’ ê¸€ìë¡œ ë³€í™˜
          </button>
        </div>
        <input
          id="essayImageInput"
          type="file"
          accept="image/*"
          style="display:none" />
        <label class="form-label">ê¸€ì ìˆ˜ ì œí•œ</label>
        <div class="row">
          <input id="charLimit" class="input" placeholder="ì˜ˆ: 700" />
          <input id="charRange" class="input" placeholder="Â± ì˜ˆ: 50" />
        </div>

        <div style="margin-top:18px; text-align:center">
          <button class="btn btn-primary" onclick="submitEssay()">âš¡ ë¦¬í¬íŠ¸ ìƒì„±</button>
        </div>
        <div id="loading" class="muted" style="display:none; margin-top:8px">â³ ì½ê³  ìˆì–´ìš”â€¦</div>
        <div id="error" class="muted" style="display:none; color:#dc2626; margin-top:8px">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</div>
      </div>

      <!-- ê²°ê³¼ (ì˜ˆì‹œ ë²„íŠ¼ë§Œ ë…¸ì¶œ) -->
      <div id="resultCard" class="panel hidden" style="margin-top:18px">
        <h3 style="margin-top:0">ğŸ“Š í•œëˆˆì— ì´í•´ë˜ëŠ” ë¦¬í¬íŠ¸</h3>
        <div id="evalSummary"></div>
      </div>

      <!-- ì˜ˆì‹œ/ë¹„êµ + PDF (ë²„íŠ¼ ëˆ„ë¥´ê¸° ì „ì—ëŠ” ê°ì¶¤) -->
      <div id="exampleSection" class="panel hidden" style="margin-top:18px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <h3 style="margin:0">ğŸ“ ì˜ˆì‹œë‹µì•ˆ</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn btn-ghost" onclick="openRecords()">ë‚´ ê¸°ë¡</button>
          </div>
        </div>
        <div id="exampleNote" class="muted" style="margin-top:8px;display:none"></div>
        <div id="exampleOutput" class="panel" style="background:#fff"></div>
        <div id="comparisonOutput" class="panel" style="background:#fff;margin-top:12px"></div>
        <button id="btnSavePDF" class="btn btn-primary" style="margin-top:14px"
        onclick="downloadPDF_dashboard_land()">ğŸ“¥ PDF ì €ì¥</button>
        <button class="btn btn-ghost" style="margin-top:14px" onclick="resetReport()">ğŸ”„ ìƒˆ ë¦¬í¬íŠ¸ ì‹œì‘</button>
      </div>

    </div>
  </section>
</main>

<!-- GLOBAL LOADING OVERLAY -->
<div id="globalLoading" class="loading-overlay hidden">
  <div class="loading-card">
    <div class="paper-spinner">
      <div class="paper">
        <div class="paper-line paper-header"></div>
        <div class="paper-line"></div>
        <div class="paper-line"></div>
        <div class="paper-line short"></div>
      </div>
    </div>
    <div class="loading-main">
      <div id="loadingMessage" class="loading-title">ê¸€ì„ ì½ê³  ìˆì–´ìš”</div>
      <div id="loadingSubMessage" class="loading-sub">
        ë…¼ë¦¬ì™€ ê·¼ê±°ë¥¼ í•œ ì¤„ì”© ë”°ë¼ê°€ê³  ìˆì–´ìš”.
      </div>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div id="authWrap" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="authTitle">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="authTitle" style="margin:0;font-weight:900">ë‚´ ê³„ì •</h3>
      <button class="btn btn-ghost" onclick="closeAuth()">ë‹«ê¸°</button>
    </div>
    <div class="tabs" style="margin-top:10px">
      <button id="tabLogin" class="tab active" onclick="switchTab('login')">ë¡œê·¸ì¸</button>
      <button id="tabRegister" class="tab" onclick="switchTab('register')">íšŒì›ê°€ì…</button>
    </div>
    <div id="loginPanel">
      <label class="form-label">ì´ë©”ì¼</label>
      <input id="loginEmail" class="input" placeholder="you@example.com" />
      <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
      <input id="loginPassword" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
      <button class="btn btn-primary" style="margin-top:12px" onclick="login()">ë¡œê·¸ì¸</button>
      <div id="loginError" class="muted" style="color:#dc2626;margin-top:8px;display:none"></div>
    </div>
    <div id="registerPanel" class="hidden">
      <label class="form-label">ì´ë¦„</label>
      <input id="regName" class="input" placeholder="í™ê¸¸ë™" />
      <label class="form-label">ì´ë©”ì¼</label>
      <input id="regEmail" class="input" placeholder="you@example.com" />
      <label class="form-label">ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
      <input id="regPassword" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
      <button class="btn btn-primary" style="margin-top:12px" onclick="register()">íšŒì›ê°€ì…</button>
      <div id="registerError" class="muted" style="color:#dc2626;margin-top:8px;display:none"></div>
    </div>
  </div>
</div>

<!-- RECORDS MODAL -->
<div id="recordsWrap" class="modal-backdrop hidden">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0;font-weight:900">ë‚´ ê¸°ë¡</h3>
      <button class="btn btn-ghost" onclick="closeRecords()">ë‹«ê¸°</button>
    </div>
    <div id="recordsList" class="muted" style="margin-top:8px">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
  </div>
</div>

<script>
  // ===== ì „ì—­ ìƒíƒœ (ë¦¬ë·°/ì˜ˆì‹œ/PDF ê³µìš©) =====
let scoreChart = null;
let savedScores = [];
let savedReasons = {};
let savedExample = '';
let savedComparison = '';
let savedSummary = '';
let exampleGenerated = false;
let currentUser = null;
let deferredAction = null;

/* ===== ë°ëª¨ ë°ì´í„° ===== */
const demoSet = {
  student: "ê¹€ë‹¤ì›€",
  question: "ì œì‹œë¬¸ì„ ë°”íƒ•ìœ¼ë¡œ 'ê³µì •'ì˜ ì˜ë¯¸ë¥¼ ì •ì˜í•˜ê³ , ì‚¬íšŒì  ì•½ì ë³´í˜¸ì˜ ê´€ì ì—ì„œ ê·¸ ì •ë‹¹ì„±ì„ ë…¼í•˜ì‹œì˜¤.",
  passages: [
    "ê³µì •ì€ ëˆ„êµ¬ë‚˜ ê²½ìŸì— ì°¸ì—¬í•  ìˆ˜ ìˆë„ë¡ ë™ë“±í•œ ì¶œë°œì„ ì„ ë³´ì¥í•˜ë ¤ëŠ” ì‚¬íšŒì˜ ì•½ì†ì´ë‹¤.",
    "ì„±ê³¼ì— ë”°ë¥¸ ì°¨ë“± ë³´ìƒì€ ë™ê¸°ë¥¼ ë†’ì´ì§€ë§Œ, ì¶œë°œì„ ì´ ê¸°ìš¸ì–´ì ¸ ìˆìœ¼ë©´ ë¶ˆí‰ë“±ì„ í™•ëŒ€í•  ìˆ˜ ìˆë‹¤.",
    "ì•½ìë¥¼ ë³´í˜¸í•˜ëŠ” ì •ì±…ì€ ê²½ìŸì„ ì•½í™”ì‹œí‚¤ëŠ” ì˜ˆì™¸ê°€ ì•„ë‹ˆë¼ ì°¸ì—¬ ëŠ¥ë ¥ì„ íšŒë³µì‹œí‚¤ëŠ” ì¡°ê±´ì´ë‹¤.",
    "ì œë„ëŠ” ê¸°íšŒì˜ ë¶ˆê· í˜•ì„ ì™„í™”í•˜ê¸° ìœ„í•´ íˆ¬ëª…í•œ ê¸°ì¤€ê³¼ ëª…í™•í•œ ì¢…ë£Œ ì¡°ê±´ì„ ê°–ì¶”ì–´ì•¼ í•œë‹¤."
  ],
  essay:"ë‚˜ëŠ” ê³µì •ì„ ê²°ê³¼ì˜ ê· ë“±ì´ ì•„ë‹ˆë¼ ê¸°íšŒì˜ ê· ë“±ìœ¼ë¡œ ì´í•´í•œë‹¤. ê°™ì€ ê·œì¹™ì´ ì£¼ì–´ì ¸ë„ ì¶œë°œì„ ì´ ê¸°ìš¸ì–´ ìˆìœ¼ë©´ ê²½ìŸì€ ê³µì •í•´ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤. â€¦ (ìƒëµ) â€¦ ì¶œë°œì„ ì˜ ê· í˜•ê³¼ ê²°ê³¼ì˜ ì±…ì„ì´ í•¨ê»˜ ì‘ë™í•  ë•Œ ìš°ë¦¬ëŠ” ë¹„ë¡œì†Œ ê³µì •í•˜ë‹¤ê³  ë§í•  ìˆ˜ ìˆë‹¤.",
  charBase:700, charRange:50,
  scores:[9,9,9,10], total:37, status:"í•©ê²©",
  reasons:{
    "ë…¼ë¦¬ë ¥":"ì£¼ì¥â†’ê·¼ê±°â†’ì¡°ê±´â†’ê²°ë¡ ìœ¼ë¡œ ì „ê°œê°€ ì¼ê´€ë¨.",
    "ë…í•´ë ¥":"ì¶œë°œì„ Â·ì°¨ë“±Â·ì•½ìë³´í˜¸Â·ì œë„ì„¤ê³„ì˜ í•µì‹¬ì„ ê°ê° ë…¼ì§€ì— ì—°ê²°.",
    "êµ¬ì„±ë ¥":"ë„ì…-ë³¸ë¬¸-ê²°ë¡ ì˜ ì•„ì¹˜í˜• êµ¬ì¡°, ë‹¨ë½ ëª©í‘œê°€ ë¶„ëª….",
    "í‘œí˜„ë ¥":"í•µì‹¬ì–´ ë°˜ë³µìœ¼ë¡œ ì‘ì§‘ë ¥ ê°•í™”, ë¬¸ë²• ì˜¤ë¥˜ ì—†ìŒ."
  },
  example:"ê³µì •ì€ ê²°ê³¼ì˜ ë™ì¼ì„ ê°•ì œí•˜ëŠ” ê·œë²”ì´ ì•„ë‹ˆë¼, ëˆ„êµ¬ë‚˜ ê²½ìŸì— ì°¸ì—¬í•  ìˆ˜ ìˆë„ë¡ ì¶œë°œì„ ì„ ê· ë“±í™”í•˜ëŠ” ì›ì¹™ì´ë‹¤. ì´ë•Œ ì•½ì ë³´í˜¸ëŠ” ì˜ˆì™¸ê°€ ì•„ë‹ˆë¼ ê³µì •ì˜ ì¡°ê±´ì´ë‹¤. êµìœ¡Â·ì •ë³´Â·ê±´ê°•ê³¼ ê°™ì€ ê¸°ë³¸ ì—­ëŸ‰ì„ ë³´ì¥í•´ ì°¸ì—¬ ëŠ¥ë ¥ì„ ëŒì–´ì˜¬ë¦¬ê³ , ì´í›„ì˜ ì„±ê³¼ëŠ” ì˜ˆì¸¡ ê°€ëŠ¥í•œ ê¸°ì¤€ì— ë”°ë¼ ì°¨ë“± ë³´ìƒë˜ì–´ì•¼ í•œë‹¤.\n\nì§€ì›ì€ ëª©ì Â·ëŒ€ìƒÂ·ê¸°ê°„Â·ì¢…ë£Œ ì¡°ê±´ì´ ëª…í™•í•´ì•¼ í•œë‹¤. ë³´ì •ì´ ì„±ê³¼ ë³´ìƒê³¼ ë’¤ì„ì´ë©´ íŠ¹í˜œë¡œ ì˜¤í•´ë˜ê¸° ë•Œë¬¸ì´ë‹¤. ë°˜ëŒ€ë¡œ ì„±ê³¼ê°€ í™•ì¸ë˜ë©´ ë” í° ììœ¨ê³¼ ì±…ì„ì„ ë¶€ì—¬í•´ì•¼ ì œë„ëŠ” ì‹ ë¢°ë¥¼ ì–»ëŠ”ë‹¤. ê²°êµ­ ê³µì •ì€ â€˜ê¸°íšŒ ë³´ì •â€™ê³¼ â€˜ì„±ê³¼ ì±…ì„â€™ì´ ë™ì‹œì— ì‘ë™í•  ë•Œ ìœ ì§€ëœë‹¤.",
  comparison:"ì›ë¬¸ì€ â€˜ì§€ì›ê³¼ ë³´ìƒ ë¶„ë¦¬â€™ì˜ í•„ìš”ì„±ì„ ê°„ë‹¨íˆ ì–¸ê¸‰í–ˆë‹¤. ì˜ˆì‹œëŠ” ì§€ì›ì˜ ë„¤ ìš”ì†Œ(ëª©ì Â·ëŒ€ìƒÂ·ê¸°ê°„Â·ì¢…ë£Œ)ë¥¼ ë¶„ëª…íˆ í•´ ì •ì±… ì„¤ê³„ì˜ ë‹«í˜ì„ í™•ë³´í•œë‹¤. ë˜í•œ ì›ë¬¸ì´ ì¶”ìƒì  ë²”ì£¼ì— ë¨¸ë¬¸ ë°˜ë©´, ì˜ˆì‹œëŠ” êµìœ¡Â·ì •ë³´Â·ê±´ê°• ë“±ìœ¼ë¡œ êµ¬ì²´í™”í•˜ì—¬ ì ìš© ê°€ëŠ¥ì„±ì„ ë†’ì˜€ë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ ê²°ë¡ ì—ì„œ â€˜ê¸°íšŒ ë³´ì • + ì„±ê³¼ ì±…ì„â€™ì´ë¼ëŠ” ì´ì› êµ¬ì¡°ë¥¼ ê³µì‹ì²˜ëŸ¼ ì œì‹œí•´ ë©”ì‹œì§€ íšŒìˆ˜ì™€ ê¸°ì–µ ìš©ì´ì„±ì„ ê°•í™”í–ˆë‹¤."
};

/* ===== ë¼ìš°íŒ… ===== */
function show(section){
  const home = document.getElementById('homeSection');
  const editor = document.getElementById('editorSection');
  home.classList.toggle('hidden', section!=='home');
  editor.classList.toggle('hidden', section!=='editor');
  if(section==='editor'){
    requestAnimationFrame(refreshAutosize);
    if (document.fonts && document.fonts.ready) document.fonts.ready.then(()=>refreshAutosize());
    editor.style.visibility = 'visible';
  }
  window.scrollTo({ top:0, behavior:'instant' });
}
function go(section){ location.hash = (section==='editor' ? '#editor' : '#home'); show(section); }
function routeFromHash(){ const h=(location.hash||'').toLowerCase(); if(h==='#editor') show('editor'); else show('home'); }
window.addEventListener('hashchange', routeFromHash);
window.addEventListener('DOMContentLoaded', routeFromHash);
function goToEditor(){ location.hash='#editor'; show('editor'); setTimeout(()=>{document.getElementById('studentName')?.focus({preventScroll:true});},0); }

/* ===== ì‹¤ í™”ë©´ ìŠ¤ì¼€ì¼: 1120px 1:1, í•„ìš” ì‹œ ì¶•ì†Œ ===== */
function scaleDemo(){
  document.querySelectorAll('.viewport').forEach(vp=>{
    const stage = vp.querySelector('.stage');
    if(!stage) return;
    const stageW = parseInt(vp.dataset.stage || '1120', 10); // ëœë”©=960, ì—ë””í„°=1120
    stage.style.width = stageW + 'px';
    const maxW = (vp.closest('.screen')||vp).clientWidth;
    const scale = Math.min(1, maxW / stageW);
    stage.style.transformOrigin = 'top center';
    stage.style.transform = `scale(${scale})`;
    const rect = stage.getBoundingClientRect();        // ë³€í™˜ í›„ ì‹¤ì œ ë†’ì´
    vp.style.height = rect.height + 'px';               // h*scale ì•„ë‹˜!
  });
}
window.addEventListener('DOMContentLoaded', scaleDemo);
window.addEventListener('resize', scaleDemo);

/* ===== ë°ëª¨ ì°¨íŠ¸ ===== */
function renderDemoChart(){
  const el=document.getElementById('demoChart');
  if(!el) return;
  new Chart(el.getContext('2d'),{
    type:'bar',
    data:{ labels:['ë…¼ë¦¬ë ¥','ë…í•´ë ¥','êµ¬ì„±ë ¥','í‘œí˜„ë ¥'],
      datasets:[{ data:[9,9,9,10], backgroundColor:"rgba(33,64,177,.75)", borderRadius:8, barThickness:28, categoryPercentage:0.65 }]},
    options:{ animation:{duration:400},
      scales:{ x:{grid:{display:false},ticks:{color:'#6B7280',font:{size:12}}},
               y:{beginAtZero:true,max:10,ticks:{stepSize:1,color:'#9CA3AF',font:{size:11}},grid:{color:'rgba(17,24,39,.06)'}}},
      plugins:{legend:{display:false}}}
  });
}
window.addEventListener('DOMContentLoaded', renderDemoChart);

/* ===== ë°ëª¨ ì˜ˆì‹œ í† ê¸€ ===== */
function renderDemoExample(){
  const btn=document.getElementById('demoExampleBtn');
  const wrap=document.getElementById('demoExampleWrap');
  const ex=document.getElementById('demoExampleText');
  const cmp=document.getElementById('demoComparisonText');
  btn.disabled=true; const old=btn.textContent; btn.textContent='ìƒì„± ì¤‘â€¦';
  setTimeout(()=>{
    ex.innerHTML = (demoSet.example||'').replace(/\n/g,'<br>');
    cmp.innerHTML = (demoSet.comparison||'').replace(/\n/g,'<br>');
    wrap.classList.remove('hidden');
    btn.textContent='ì˜ˆì‹œë‹µì•ˆ ìƒì„±ë¨';
  }, 500);
}

/* ===== textarea ìë™ ë¦¬ì‚¬ì´ì¦ˆ & ì¹´ìš´íŠ¸ ===== */
function autoResize(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,1200)+'px'; }
function refreshAutosize(){ document.querySelectorAll('textarea').forEach(t=>{ autoResize(t); }); }
function bindAutoResize(){ document.querySelectorAll('textarea').forEach(t=>{ t.addEventListener('input',()=>autoResize(t)); autoResize(t); }); }
window.addEventListener('DOMContentLoaded', bindAutoResize);
function updateCharCount(){
  const essay=document.getElementById('essay').value;
  const l=parseInt(document.getElementById('charLimit').value);
  const r=parseInt(document.getElementById('charRange').value)||0;
  const enabled=!Number.isNaN(l);
  const min=enabled?Math.max(0,l-r):0;
  const max=enabled?l+r:Infinity;
  const inRange=!enabled?true:(essay.length>=min && essay.length<=max);
  const el=document.getElementById('charCount');
  el.textContent = enabled ? `í˜„ì¬ ê¸€ì ìˆ˜: ${essay.length} Â· ê¸°ì¤€ ${min}~${max}` : `í˜„ì¬ ê¸€ì ìˆ˜: ${essay.length}`;
  el.style.color = inRange ? '#6B7280' : '#ef4444';
}

/* ===== ì œì‹œë¬¸ ì¶”ê°€ (ì „ì—­ ë°”ì¸ë”©) ===== */
window.addPassage = function(){
  const t=document.createElement('textarea');
  t.className='passage textarea'; t.rows=3;
  t.placeholder='ì œì‹œë¬¸ì„ ê·¸ëŒ€ë¡œ ì ì–´ ì£¼ì„¸ìš”.';
  document.getElementById('passages').appendChild(t);
  t.addEventListener('input',()=>autoResize(t));
  autoResize(t); t.focus();
};
document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('btnAddPassage')?.addEventListener('click', ()=>window.addPassage()); });
/* ===== êµì¬ ë¬¸ì œ(ë‹¨ê³„/í˜ì´ì§€) ë¡œë”© ===== */
let BOOK_ITEMS = [];

function loadBookItems() {
  fetch('/static/book_items.json', { cache: 'no-store' })
    .then(res => res.json())
    .then(data => {
      BOOK_ITEMS = Array.isArray(data) ? data : [];

      const mainStageSelect = document.getElementById('bookMainStageSelect');
      const subStageSelect  = document.getElementById('bookSubStageSelect');
      const pageSelect      = document.getElementById('bookPageSelect');

      if (!mainStageSelect || !subStageSelect || !pageSelect) return;

      /* ---------------------------------------------------------
         â‘  ë‹¨ê³„ ëª©ë¡ ìƒì„± (stage: "1-1" â†’ mainStage = "1")
      --------------------------------------------------------- */
      const mainStages = [...new Set(
        BOOK_ITEMS.map(item => item.stage.split('-')[0])
      )].sort((a, b) => Number(a) - Number(b));

      mainStages.forEach(main => {
        const opt = document.createElement('option');
        opt.value = main;
        opt.textContent = `${main}ë‹¨ê³„`;
        mainStageSelect.appendChild(opt);
      });

      /* ---------------------------------------------------------
         â‘¡ ë‹¨ê³„ ì„ íƒ â†’ êµì¬(ì†Œë‹¨ê³„) ëª©ë¡ ìƒì„± (stage: "1-1" â†’ subStage = "1")
      --------------------------------------------------------- */
      mainStageSelect.addEventListener('change', () => {
        const mainValue = mainStageSelect.value;

        subStageSelect.innerHTML = '<option value="">êµì¬</option>';
        pageSelect.innerHTML     = '<option value="">í˜ì´ì§€</option>';

        if (!mainValue) return;

        const subStages = [...new Set(
          BOOK_ITEMS
            .filter(item => item.stage.split('-')[0] === mainValue)
            .map(item => item.stage.split('-')[1])
        )].sort((a, b) => Number(a) - Number(b));

        subStages.forEach(sub => {
          const opt = document.createElement('option');
          opt.value = sub;
          opt.textContent = `${sub}`;
          subStageSelect.appendChild(opt);
        });
      });

      /* ---------------------------------------------------------
         â‘¢ êµì¬ ì„ íƒ â†’ í˜ì´ì§€ ëª©ë¡ ìƒì„±
      --------------------------------------------------------- */
      subStageSelect.addEventListener('change', () => {
        const mainValue = mainStageSelect.value;
        const subValue  = subStageSelect.value;

        pageSelect.innerHTML = '<option value="">í˜ì´ì§€</option>';

        if (!mainValue || !subValue) return;

        const pages = BOOK_ITEMS
          .filter(item => {
            const [m, s] = item.stage.split('-');
            return m === mainValue && s === subValue;
          })
          .map(item => item.page)
          .sort((a, b) => Number(a) - Number(b));

        pages.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p;
          opt.textContent = `${p}í˜ì´ì§€`;
          pageSelect.appendChild(opt);
        });
      });
    })
    .catch(err => {
      console.error("book_items.json ë¡œë“œ ì‹¤íŒ¨:", err);
    });
}

// í˜ì´ì§€ ë¡œë”© ì‹œ êµì¬ ë°ì´í„° ë¨¼ì € ë¶ˆëŸ¬ì˜¤ê¸°
window.addEventListener('DOMContentLoaded', loadBookItems);

/* =========================
   âœ… êµì¬ passages(ë¬¸ìì—´/ê°ì²´) ëª¨ë‘ ì§€ì› + ì´ë¯¸ì§€ ìë™ ì—°ê²° ë²„ì „
   ========================= */

// (A) "/static/..." í˜¹ì€ "passages/..." ê°™ì€ ê°’ì„ ì•ˆì „í•˜ê²Œ ì‹¤ì œ URLë¡œ ë°”ê¿”ì¤Œ
function toStaticImageUrl(pathOrUrl){
  if (!pathOrUrl) return "";
  const s = String(pathOrUrl).trim();

  // ì´ë¯¸ ì ˆëŒ€ URLì´ë©´ ê·¸ëŒ€ë¡œ
  if (/^https?:\/\//i.test(s)) return s;

  // "/static/..." í˜•íƒœ
  if (s.startsWith("/static/")) return `${location.origin}${s}`;

  // "static/..." í˜•íƒœ
  if (s.startsWith("static/")) return `${location.origin}/${s}`;

  // ê·¸ ì™¸ëŠ” "static/" ì•„ë˜ë¼ê³  ê°€ì •: "passages/5-2/22/na_1.png"
  return `${location.origin}/static/${s.replace(/^\/+/, "")}`;
}

// (B) ì´ë¯¸ì§€ URLì„ dataURLë¡œ ë°”ê¿”ì„œ passageImageMapì— ë„£ê¸° ìœ„í•¨
async function fetchAsDataUrl(imageUrl){
  const res = await fetch(imageUrl, { cache: "no-cache" });
  if (!res.ok) throw new Error(`ì´ë¯¸ì§€ fetch ì‹¤íŒ¨: ${res.status} ${imageUrl}`);
  const blob = await res.blob();

  return await new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);      // data:*/*;base64,...
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

// (C) passage ì—”íŠ¸ë¦¬ë¥¼ í‘œì¤€ í˜•íƒœë¡œ ì •ê·œí™”
//  - ë¬¸ìì—´ì´ë©´: {type:"text", content:"..."} ë˜ëŠ” {type:"image", content:[...], textContent:"..."}
//  - ê°ì²´ë©´: {type, content} ìš°ì„  ì‚¬ìš©
//  - ë¬¸ìì—´ ì•ˆì— [IMAGE:...]ê°€ ìˆìœ¼ë©´ "ì—¬ëŸ¬ ê°œ" ì „ë¶€ ì¶”ì¶œ
function normalizePassageEntry(p){
  // 1) ë¬¸ìì—´
  if (typeof p === "string") {
    const s = p.trim();

    // [IMAGE: ... ] ì—¬ëŸ¬ ê°œ ì¶”ì¶œ
    const matches = [...s.matchAll(/\[IMAGE:(.+?)\]/gi)];
    if (matches.length > 0) {
      const paths = matches.map(m => (m && m[1] ? m[1].trim() : "")).filter(Boolean);

      // ì´ë¯¸ì§€ íƒœê·¸ë¥¼ í…ìŠ¤íŠ¸ì—ì„œ ì œê±° â†’ ë‚¨ì€ í…ìŠ¤íŠ¸(ì˜ˆ: "(ë‚˜)")ëŠ” textareaì— ë‚¨ê¸¸ ìˆ˜ ìˆê²Œ
      const textOnly = s.replace(/\[IMAGE:(.+?)\]/gi, "").replace(/\n{3,}/g, "\n\n").trim();

      return { type: "image", content: paths, textContent: textOnly };
    }

    return { type: "text", content: s };
  }

  // 2) ê°ì²´
  if (p && typeof p === "object") {
    const typeRaw = (p.type || p.kind || "").toLowerCase();

    const content =
      (p.content ?? p.text ?? p.path ?? p.url ?? p.image ?? "");

    // typeì´ ëª…ì‹œë˜ì–´ ìˆìœ¼ë©´ ì¡´ì¤‘
    if (typeRaw) {
      // ê°ì²´ì¸ë° ì´ë¯¸ì§€ê°€ ë°°ì—´ë¡œ ë“¤ì–´ì˜¬ ìˆ˜ë„ ìˆì–´ì„œ ê·¸ëŒ€ë¡œ ì§€ì›
      if (typeRaw === "image" && Array.isArray(content)) {
        return { type: "image", content: content.map(x => String(x || "").trim()).filter(Boolean), textContent: "" };
      }
      return { type: typeRaw, content: String(content || "") };
    }

    // typeì´ ì—†ìœ¼ë©´ í™•ì¥ìë¡œ ì¶”ì •
    const c = String(content || "");
    if (/\.(png|jpg|jpeg|webp|gif)$/i.test(c)) return { type: "image", content: [c], textContent: "" };
    return { type: "text", content: c };
  }

  // 3) ê·¸ ì™¸
  return { type: "text", content: "" };
}

// (D) ì´ë¯¸ì§€ í”„ë¦¬ë·° DOM ìƒì„±/ì¬ì‚¬ìš©
function ensurePassagePreviewAfter(textareaEl){
  const next = textareaEl.nextElementSibling;
  if (next && next.classList && next.classList.contains("passage-preview")) {
    return next;
  }

  const preview = document.createElement("div");
  preview.className = "passage-preview";
  preview.style.marginTop = "10px";
  preview.style.marginBottom = "18px";

  textareaEl.insertAdjacentElement("afterend", preview);
  return preview;
}

/* âœ… êµì²´ ëŒ€ìƒ: êµì¬ ë¬¸ì œ ì ìš© í•¨ìˆ˜ (ë¹„ë™ê¸°) */
async function applyBookProblem() {
  const mainStageSelect = document.getElementById('bookMainStageSelect');
  const subStageSelect  = document.getElementById('bookSubStageSelect');
  const pageSelect      = document.getElementById('bookPageSelect');

  const mainStage = mainStageSelect.value;
  const subStage  = subStageSelect.value;
  const page      = pageSelect.value;

  if (!mainStage || !subStage || !page) {
    alert("ë‹¨ê³„ / êµì¬ / í˜ì´ì§€ë¥¼ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”.");
    return;
  }

  const stage = `${mainStage}-${subStage}`;

  // BOOK_ITEMSì—ì„œ í•´ë‹¹ ë‹¨ê³„/í˜ì´ì§€ ì°¾ê¸°
  const item = BOOK_ITEMS.find(
    it => it.stage === stage && String(it.page) === String(page)
  );

  if (!item) {
    alert('ì„ íƒí•œ ë‹¨ê³„/í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” êµì¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  // 1) ì§ˆë¬¸ ì±„ìš°ê¸°
  const qEl = document.getElementById('question');
  if (qEl) qEl.value = item.question || '';

  // âœ… êµì¬ ë¶ˆëŸ¬ì˜¤ê¸° ì¬ì‹¤í–‰ ëŒ€ë¹„: ê¸°ì¡´ í”„ë¦¬ë·° ì œê±° + ì´ë¯¸ì§€ë§µ ì´ˆê¸°í™”
  document.querySelectorAll('.passage-preview').forEach(preview => preview.remove());
  if (typeof passageImageMap !== "undefined" && passageImageMap && passageImageMap.clear) {
    passageImageMap.clear();
  }

  // 2) ì œì‹œë¬¸ textareaë“¤ ì±„ìš°ê¸° (+ ì´ë¯¸ì§€ë©´ ìë™ ì—°ê²°)
  const wrap = document.getElementById('passages');
  if (wrap) {
    let areas = wrap.querySelectorAll('.passage');

    // ì œì‹œë¬¸ ì¹¸ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ìµœì†Œ 1ê°œ ìƒì„±
    if (areas.length === 0) {
      window.addPassage();
      areas = wrap.querySelectorAll('.passage');
    }

    // ê¸°ì¡´ ì œì‹œë¬¸ì€ ì²« ë²ˆì§¸ë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ëŠ” ì œê±°
    areas.forEach((el, idx) => {
      if (idx !== 0) el.remove();
    });

    // item.passages ì •ê·œí™”
    const raw = Array.isArray(item.passages) ? item.passages : [];
    const normalized = raw.map(normalizePassageEntry);

    // normalizedê°€ ë¹„ì–´ìˆìœ¼ë©´ ìµœì†Œ 1ì¹¸ì€ ë¹„ì›Œë‘ 
    if (normalized.length === 0) {
      const first = wrap.querySelectorAll('.passage')[0];
      first.value = '';
      autoResize(first);
    } else {
      // ì²« ë²ˆì§¸ textarea ì„¸íŒ…
      const first = wrap.querySelectorAll('.passage')[0];
      const firstEntry = normalized[0];

      if (firstEntry.type === "image") {
        // âœ… í…ìŠ¤íŠ¸ê°€ ë‚¨ì•„ìˆìœ¼ë©´ textareaì— ë„£ê³ , ì´ë¯¸ì§€ëŠ” í”„ë¦¬ë·° + passageImageMapì— ì—°ê²°
        first.value = (firstEntry.textContent || "").trim();
        autoResize(first);

        const paths = Array.isArray(firstEntry.content) ? firstEntry.content : [firstEntry.content];
        const preview = ensurePassagePreviewAfter(first);

        // í”„ë¦¬ë·° ë Œë”ë§(ì—¬ëŸ¬ ì¥)
        const imgTags = paths.map(p => {
          const imgUrl = toStaticImageUrl(p);
          return `<img src="${imgUrl}" style="max-width:100%;border-radius:12px;border:1px solid rgba(17,24,39,.10);margin-top:8px" />`;
        }).join("");

        preview.innerHTML = `
          <div style="font-size:12px;color:#6B7280;margin-bottom:6px">ì²¨ë¶€ëœ ì´ë¯¸ì§€ ì œì‹œë¬¸</div>
          ${imgTags}
        `;

        try {
          const imageObjs = [];

          for (const p of paths) {
            const imgUrl = toStaticImageUrl(p);
            const dataUrl = await fetchAsDataUrl(imgUrl);

            imageObjs.push({
              src: dataUrl,
              confirmed: false,
              desc: null
            });
          }

// âœ… í•­ìƒ ì´ í˜•íƒœë¡œë§Œ ì €ì¥
          passageImageMap.set(first, imageObjs);
        } catch (e) {
          console.error(e);
        }
      } else {
        // text
        first.value = firstEntry.content || "";
        autoResize(first);
      }

      // ë‚˜ë¨¸ì§€ ì—”íŠ¸ë¦¬ ì²˜ë¦¬
      for (let i = 1; i < normalized.length; i++) {
        const entry = normalized[i];
        window.addPassage();
        const newAreas = wrap.querySelectorAll('.passage');
        const el = newAreas[newAreas.length - 1];

        if (entry.type === "image") {
          el.value = (entry.textContent || "").trim();
          autoResize(el);

          const paths = Array.isArray(entry.content) ? entry.content : [entry.content];
          const preview = ensurePassagePreviewAfter(el);

          const imgTags = paths.map(p => {
            const imgUrl = toStaticImageUrl(p);
            return `<img src="${imgUrl}" style="max-width:100%;border-radius:12px;border:1px solid rgba(17,24,39,.10);margin-top:8px" />`;
          }).join("");

          preview.innerHTML = `
            <div style="font-size:12px;color:#6B7280;margin-bottom:6px">ì²¨ë¶€ëœ ì´ë¯¸ì§€ ì œì‹œë¬¸</div>
            ${imgTags}
          `;

          try {
            const imageObjs = [];

            for (const p of paths) {
              const imgUrl = toStaticImageUrl(p);
              const dataUrl = await fetchAsDataUrl(imgUrl);

              imageObjs.push({
                src: dataUrl,
                confirmed: false,
                desc: null
              });
            }

            passageImageMap.set(el, imageObjs);
            
          } catch (e) {
            console.error(e);
          }
        } else {
          el.value = entry.content || "";
          autoResize(el);
        }
      }
    }
  }

  // 3) ê¸€ì ìˆ˜ ê¸°ì¤€/ë²”ìœ„ ì±„ìš°ê¸°
  if (typeof item.charBase === 'number') {
    const limitEl = document.getElementById('charLimit');
    if (limitEl) limitEl.value = item.charBase;
  }
  if (typeof item.charRange === 'number') {
    const rangeEl = document.getElementById('charRange');
    if (rangeEl) rangeEl.value = item.charRange;
  }

  // í™”ë©´ ì •ë¦¬
  refreshAutosize();
  updateCharCount();
}

/** ê° ì œì‹œë¬¸ textarea DOM ìš”ì†Œë³„ë¡œ ì´ë¯¸ì§€ dataURL ë°°ì—´ ì €ì¥ */
const passageImageMap = new Map();

function resetReport(){
  document.getElementById('studentName').value = '';
  document.getElementById('question').value = '';

 // ì œì‹œë¬¸ ì´ë¯¸ì§€ í”„ë¦¬ë·°ë„ í•¨ê»˜ ë¦¬ì…‹
  document.querySelectorAll('.passage-preview').forEach(preview => {
    preview.remove();
  });

  // ì œì‹œë¬¸ ì´ë¯¸ì§€ ìƒíƒœë„ ë¦¬ì…‹
  passageImageMap.clear();

  document.getElementById('essay').value = '';
  document.getElementById('charLimit').value = '';
  document.getElementById('charRange').value = '';
  document.getElementById('charCount').textContent = '';

  // ê²°ê³¼/ì˜ˆì‹œ ì˜ì—­ ë‹«ê³  ë¹„ìš°ê¸°
  document.getElementById('resultCard').classList.add('hidden');
  document.getElementById('exampleSection').classList.add('hidden');
  document.getElementById('exampleNote').style.display = 'none';
  document.getElementById('exampleOutput').innerHTML = '';
  document.getElementById('comparisonOutput').innerHTML = '';

  // ìƒíƒœê°’ / ì°¨íŠ¸ ì´ˆê¸°í™”
  savedScores = [];
  savedReasons = {};
  savedExample = '';
  savedComparison = '';
  if (scoreChart) { try { scoreChart.destroy(); } catch(e) {} scoreChart = null; }

  updatePdfBtnState();
  refreshAutosize();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* ===== ì´ì /ìƒíƒœ ===== */
function getTotalAndStatus(scores){
  const total=(scores||[]).reduce((a,b)=>a+(parseInt(b)||0),0);
  let status={label:"ì˜ˆë¹„",desc:"ì¡°ê¸ˆë§Œ ë‹¤ë“¬ìœ¼ë©´ ë” ì¢‹ì•„ì ¸ìš”.",emoji:"ğŸ™‚",tone:"#f59e0b"};
  if(total<30) status={label:"ë‹¤ì‹œ ì“°ê¸°",desc:"ë‹¤ìŒ ì‹œë„ì—ì„œ ë” ë‹¨ë‹¨í•´ì§ˆ ê±°ì˜ˆìš”.",emoji:"ğŸ˜…",tone:"#ef4444"};
  else if(total>=36) status={label:"í•©ê²©",desc:"ì§€ê¸ˆë„ ì¶©ë¶„íˆ ì„¤ë“ë ¥ ìˆì–´ìš”!",emoji:"ğŸ¥³",tone:"#10b981"};
  return { total, status };
}

/* ===== ë¦¬ë·° ===== */
async function submitEssay() {
  document.getElementById('loading').style.display = 'block';
  document.getElementById('error').style.display = 'none';

  showGlobalLoading('review');

  // âœ… ë¯¸í™•ì • ì´ë¯¸ì§€ ì¡´ì¬ ì—¬ë¶€ ì²´í¬
  const hasUnconfirmedImage = [...document.querySelectorAll('#passages .passage')]
    .some(p => {
      const imgs = passageImageMap.get(p) || [];
      return imgs.some(img => !img.confirmed);
    });

  // ğŸš¨ ë¯¸í™•ì • ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ëª¨ë‹¬ í‘œì‹œ í›„ ì¤‘ë‹¨
  if (hasUnconfirmedImage) {
    hideGlobalLoading();
    document.getElementById('loading').style.display = 'none';

    const modal = document.getElementById('imageConfirmModal');
    const btnProceed = document.getElementById('btnProceedWithoutImage');
    const btnGoConfirm = document.getElementById('btnGoConfirmImage');

    modal.classList.remove('hidden');

    // ğŸ‘‰ ì´ëŒ€ë¡œ ì œì¶œ
    btnProceed.onclick = () => {
      modal.classList.add('hidden');
      continueSubmitEssay();
    };

    // ğŸ‘‰ ì´ë¯¸ì§€ í™•ì •í•˜ëŸ¬ ì´ë™
    btnGoConfirm.onclick = () => {
      modal.classList.add('hidden');

      const target = [...document.querySelectorAll('#passages .passage')]
        .find(p => {
          const imgs = passageImageMap.get(p) || [];
          return imgs.some(img => !img.confirmed);
        });

      if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        target.focus({ preventScroll: true });
      }
    };

    return; // â›” ì—¬ê¸°ì„œ ë°˜ë“œì‹œ ì¢…ë£Œ
  }

  // âœ… ë¬¸ì œ ì—†ìœ¼ë©´ ë°”ë¡œ ì œì¶œ
  continueSubmitEssay();
}


/* ===== ì‹¤ì œ ë¦¬ë·° ìš”ì²­ ===== */
async function continueSubmitEssay() {
  try {
    showGlobalLoading('review');
    document.getElementById('loading').style.display = 'block';

    const name = document.getElementById('studentName').value;
    const question = document.getElementById('question').value;
    const essay = document.getElementById('essay').value;

    const passageEls = [...document.querySelectorAll('#passages .passage')];

    const passages = passageEls.map(p => {
      const baseText = p.value || '';
      const imgs = passageImageMap.get(p) || [];

      // âœ… í™•ì •ëœ ì´ë¯¸ì§€ ì„¤ëª…ë§Œ ì‚¬ìš©
      const confirmedDescs = imgs
        .filter(img => img.confirmed && img.desc)
        .map((img, i) => `[ì´ë¯¸ì§€ ${i + 1}] ${img.desc}`);

      if (confirmedDescs.length === 0) {
        return baseText;
      }

      return [
        baseText,
        '',
        confirmedDescs.join('\n')
      ].join('\n');
    });

    window.savedPassages = passages;

    const r = await fetch('/api/review', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        name,
        question,
        passages,
        essay
      })
    });

    const data = await r.json();
    if (!r.ok) {
      throw new Error(data.error || 'ë¦¬ë·° ìš”ì²­ ì‹¤íŒ¨');
    }

    savedScores = data.scores;
    savedReasons = data.reasons;
    savedSummary = data.summary;

    const { total, status } = getTotalAndStatus(savedScores);

    renderResult(savedScores, savedReasons, total, status, savedSummary);

  } catch (err) {
    console.error(err);
    document.getElementById('error').textContent = err.message;
    document.getElementById('error').style.display = 'block';
  } finally {
    hideGlobalLoading();
    document.getElementById('loading').style.display = 'none';
  }
}


    function renderResult(savedScores, savedReasons, total, status, savedSummary) {
  /* ===== ê²°ê³¼ ì¹´ë“œ ê·¸ë¦¬ê¸° (ì˜ˆì‹œ ë²„íŠ¼ë§Œ ë…¸ì¶œ) ===== */
  document.getElementById('evalSummary').innerHTML = `
    <div class="panel" style="display:flex;align-items:center;gap:14px">
      <div style="font-size:30px">${status.emoji}</div>
      <div style="flex:1">
        <div style="font-weight:900">
          ì´ì  <span style="color:${status.tone}">${total}</span> / 40 Â·
          <span style="color:${status.tone}">${status.label}</span>
        </div>
        <div class="muted" style="margin-top:4px">${status.desc}</div>
        <div style="margin-top:8px;position:relative;height:10px;background:#eef2ff;border-radius:999px;overflow:hidden">
          <div style="width:${(total / 40) * 100}%;height:100%;background:${status.tone};transition:width .5s"></div>
          <div style="position:absolute;left:${(30 / 40) * 100}%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.15)"></div>
          <div style="position:absolute;left:${(36 / 40) * 100}%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.25)"></div>
        </div>
      </div>
      <div style="position:relative; width:110px; height:110px">
        <svg width="110" height="110">
          <circle r="52" cx="55" cy="55" fill="transparent" stroke="#eef2ff" stroke-width="10"></circle>
          <circle
            r="52"
            cx="55"
            cy="55"
            fill="transparent"
            stroke="${status.tone}"
            stroke-width="10"
            stroke-dasharray="327"
            stroke-dashoffset="${327 - (327 * (total / 40))}">
          </circle>
        </svg>
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:900">
          ${total}
        </div>
      </div>
    </div>

    <div class="kpi" style="margin-top:14px">
      ${['ë…¼ë¦¬ë ¥','ë…í•´ë ¥','êµ¬ì„±ë ¥','í‘œí˜„ë ¥'].map((k, i) => `
        <div class="panel">
          <div style="font-weight:800">${k} (${savedScores[i]}ì )</div>
          <div class="muted" style="margin-top:6px">${savedReasons[k]}</div>
        </div>
      `).join('')}
    </div>

    <div class="panel" style="margin-top:14px; width:70%; margin-left:auto; margin-right:auto;">
      <canvas id="scoreChart" height="140" style="width:100%"></canvas>
    </div>

    <div id="exampleCTA" style="text-align:right;margin-top:12px">
      <button id="btnExample" class="btn btn-primary" onclick="loadExample()">ì˜ˆì‹œë‹µì•ˆ ë³´ê¸°</button>
    </div>
  `;

  const ctx = document.getElementById('scoreChart').getContext('2d');

  if (window.scoreChart && typeof window.scoreChart.destroy === 'function') {
    window.scoreChart.destroy();
  }

  window.scoreChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['ë…¼ë¦¬ë ¥', 'ë…í•´ë ¥', 'êµ¬ì„±ë ¥', 'í‘œí˜„ë ¥'],
      datasets: [{
        data: savedScores,
        backgroundColor: "rgba(33,64,177,.75)",
        borderRadius: 8,
        barThickness: 28,
        categoryPercentage: 0.65
      }]
    },
    options: {
      animation: { duration: 600, easing: 'easeOutQuart' },
      scales: {
        x: {
          grid: { display: false },
          ticks: { color: '#6B7280', font: { size: 12 } }
        },
        y: {
          beginAtZero: true,
          max: 10,
          ticks: { stepSize: 1, color: '#9CA3AF', font: { size: 11 } },
          grid: { color: 'rgba(17,24,39,.06)' }
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });

  document.getElementById('resultCard').classList.remove('hidden');
  document.getElementById('exampleSection').classList.add('hidden'); // ì˜ˆì‹œ ì‚¬ì „ ë…¸ì¶œ ë°©ì§€
  document.getElementById('exampleNote').style.display = 'none';
  document.getElementById('exampleOutput').innerHTML = '';
  document.getElementById('comparisonOutput').innerHTML = '';
  window.exampleGenerated = false;

  updatePdfBtnState();
}

/* ===== PDF ===== */
window.__pdf_version = 'v3.0-2025-10-24';

/* ê³µí†µ ìœ í‹¸ */
function __val(id, fallback=''){ return (document.getElementById(id)?.value ?? '').toString().trim() || fallback; }
function __html(id){ return (document.getElementById(id)?.innerHTML ?? '').toString().trim(); }
function __num(v, d = 0){ const n = Number(v); return Number.isFinite(n) ? n : d; }
// ì°¨íŠ¸ ìƒì„± â†’ PNG ë°ì´í„° URL
async function __chartToDataURL(type, cfg, w=700, h=260){
  return new Promise(resolve=>{
    const c = document.createElement('canvas'); c.width=w; c.height=h;
    const ctx = c.getContext('2d');
    const conf = { ...cfg, options:{ responsive:false, animation:false, ...(cfg.options||{}) } };
    new Chart(ctx, { type, ...conf });
    requestAnimationFrame(()=> resolve(c.toDataURL('image/png')) );
  });
}

async function __makeBarPNG(scores){
  const labels=['ë…¼ë¦¬ë ¥','ë…í•´ë ¥','êµ¬ì„±ë ¥','í‘œí˜„ë ¥'];
  return __chartToDataURL('bar',{
    data:{
      labels,
      datasets:[{
        data:scores||[0,0,0,0],
        backgroundColor:'rgba(33,64,177,.75)',
        borderRadius:8, barThickness:28, categoryPercentage:0.65
      }]
    },
    options:{
      scales:{
        x:{grid:{display:false},ticks:{color:'#6B7280',font:{size:12}}},
        y:{beginAtZero:true,max:10,ticks:{stepSize:1,color:'#9CA3AF',font:{size:11}},grid:{color:'rgba(17,24,39,.06)'}}
      },
      plugins:{legend:{display:false}}
    }
  }, 720, 240);
}

async function __makeDonutPNG(total){
  const val=Math.max(0,Math.min(40,total||0));
  return __chartToDataURL('doughnut',{
    data:{
      labels:['ë“ì ','ë¹ˆì¹¸'],
      datasets:[{ data:[val,40-val], backgroundColor:['#2140B1','#EEF2FF'], borderWidth:0, cutout:'72%' }]
    },
    options:{ plugins:{legend:{display:false}}, circumference:360, rotation:-90 }
  }, 120, 120);
}
function syncPdfContainer() {
  // 1) ì˜ˆì‹œ/ë¹„êµ í…ìŠ¤íŠ¸ (ê¸°ë³¸ ì„¸íŒ…)
  document.getElementById('pdfExample').innerHTML =
    (savedExample || '').replace(/\n/g, '<br/>');
  document.getElementById('pdfComparison').innerHTML =
    (savedComparison || '').replace(/\n/g, '<br/>');

  const name     = (document.getElementById('studentName')?.value || '').trim() || 'ì´ë¦„ ë¯¸ì…ë ¥';
  const question = (document.getElementById('question')?.value || '').trim();
  const essay    = (document.getElementById('essay')?.value || '').trim();
  const charCount = essay.length;
  const dateStr   = new Date().toISOString().split('T')[0];

  // 2) ì¤€ë¹„ ìƒíƒœ ì²´í¬ (ì ìˆ˜/ì˜ˆì‹œ/ê·¼ê±°ê°€ ì—†ìœ¼ë©´ PDF ìƒì„± ê±°ë¶€)
  if (!Array.isArray(savedScores) || savedScores.length !== 4) {
    alert('ë¨¼ì € [ë¦¬í¬íŠ¸ ìƒì„±]ìœ¼ë¡œ ì ìˆ˜ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”.');
    throw new Error('scores not ready');
  }
  if (!savedReasons) {
    alert('í‰ê°€ ê·¼ê±°ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    throw new Error('reasons not ready');
  }
  if (!savedExample || !savedComparison) {
    alert('ë¨¼ì € [ì˜ˆì‹œë‹µì•ˆ ë³´ê¸°]ë¡œ ì˜ˆì‹œ/ë¹„êµë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”.');
    throw new Error('example/comparison not ready');
  }
  if (!savedSummary) {
    savedSummary = 'í•œ ì¤„ ì´í‰: (ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.)';
  }

  // 3) ì ìˆ˜/ìƒíƒœ ê³„ì‚° (í•©ê²© / ë³´ë¥˜ / ë‹¤ì‹œ ì“°ê¸°)
  const { total, status } = getTotalAndStatus(savedScores);
  // label: "í•©ê²©" / "ì˜ˆë¹„" / "ë‹¤ì‹œ ì“°ê¸°"
  let statusDisplay = status.label;
  if (statusDisplay === 'ì˜ˆë¹„') statusDisplay = 'ë³´ë¥˜';  // PDFì—ì„œëŠ” 'ë³´ë¥˜'ë¡œ í‘œê¸°

  const emoji = status.emoji || '';
  const statusWithEmoji = emoji ? `${emoji} ${statusDisplay}` : statusDisplay;


  // 4) í‘œì§€(1í˜ì´ì§€) ì±„ìš°ê¸°
  document.getElementById('pdfHeaderStudent').textContent  = name;
  document.getElementById('pdfHeaderStudent2').textContent = name;
  document.getElementById('pdfHeaderStudent3').textContent = name;

  document.getElementById('pdfStudentName').textContent = name;
  document.getElementById('pdfDate').textContent        = dateStr;
  document.getElementById('pdfCharCount').textContent   = charCount;

  // â–¼ í‘œì§€ íƒ€ì´í‹€: OOO ë¦¬í¬íŠ¸
  const coverTitleEl = document.getElementById('pdfCoverTitle');
  if (coverTitleEl) {
    coverTitleEl.textContent = name && name !== 'ì´ë¦„ ë¯¸ì…ë ¥'
      ? `${name} ë¦¬í¬íŠ¸`
      : 'í•™ìƒ ë¦¬í¬íŠ¸';
  }

  // â–¼ ì§ˆë¬¸ ë ˆì´ë¸” + ë‚´ìš©
  const coverQEl = document.getElementById('pdfCoverQuestion');
   if (coverQEl) {
    if (question) {
     coverQEl.innerHTML = `<span class="muted">ì§ˆë¬¸</span><br>${question}`;
    } else {
      coverQEl.innerHTML = `<span class="muted">ì§ˆë¬¸ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</span>`;
    }
  }

  document.getElementById('pdfSummary').textContent = savedSummary || '';

  // ìƒíƒœ/ì´ì (í‘œì§€)
  const badgeEl = document.getElementById('pdfStatusBadge');
  if (badgeEl) badgeEl.textContent = statusWithEmoji;

  const totalEl = document.getElementById('pdfTotalScore');
  if (totalEl) totalEl.textContent = total.toString();

  const statusLabel2 = document.getElementById('pdfStatusLabel2');
  if (statusLabel2) statusLabel2.textContent = statusWithEmoji;


  const statusDesc = document.getElementById('pdfStatusDesc');
  if (statusDesc) statusDesc.textContent = status.desc || '';

  // 5) 2í˜ì´ì§€ â€“ ì§ˆë¬¸/ì œì‹œë¬¸/í•™ìƒ ë…¼ìˆ ë¬¸
  document.getElementById('pdfQuestion').textContent = question;

  const passages = Array.isArray(window.savedPassages)
    ? window.savedPassages
    : [];

  document.getElementById('pdfPassages').innerHTML =
    (passages.length ? passages : [''])
      .map((p, i) => `
        <div class="passage-block avoid-break">
          <div class="passage-label">[ì œì‹œë¬¸ ${i + 1}]</div>
          <div class="passage-body">${(p || '').replace(/\n/g, '<br/>')}</div>
        </div>
      `).join('');

  document.getElementById('pdfEssay').innerHTML =
    (essay || '').replace(/\n/g, '<br/>');
  document.getElementById('pdfCharCount2').textContent = charCount.toString();

  // 6) 2í˜ì´ì§€ â€“ ì„¸ë¶€ ì ìˆ˜ ì¹´ë“œ
  const labels = ['ë…¼ë¦¬ë ¥','ë…í•´ë ¥','êµ¬ì„±ë ¥','í‘œí˜„ë ¥'];
  const sc = savedScores;
  const rs = savedReasons || {};

  document.getElementById('pdfScoreCards').innerHTML =
    labels.map((k, idx) => `
      <div class="score-item">
        <div class="score-item-header">
          <span class="score-item-name">${k}</span>
          <span class="score-item-value">${(sc && sc[idx] != null) ? sc[idx] : '-'}ì </span>
        </div>
        <div class="muted">${(rs && rs[k] ? rs[k] : '').replace(/\n/g, ' ')}</div>
      </div>
    `).join('');

  // ì´ì /ìƒíƒœ(2í˜ì´ì§€ì—ë„ í•œ ë²ˆ ë” ë…¸ì¶œ)
  const totalDetailEl = document.getElementById('pdfTotalScoreDetail');
  if (totalDetailEl) totalDetailEl.textContent = total.toString();

  const statusLabelDetail = document.getElementById('pdfStatusLabelDetail');
  if (statusLabelDetail) statusLabelDetail.textContent = statusWithEmoji;


  const statusDescDetail = document.getElementById('pdfStatusDescDetail');
  if (statusDescDetail) statusDescDetail.textContent = status.desc || '';

  // 7) ë§‰ëŒ€ ê·¸ë˜í”„ ìº¡ì²˜í•´ì„œ ì´ë¯¸ì§€ë¡œ ë„£ê¸°
  try{
    const cv = document.querySelector('#scoreChart');
    if (cv && cv.toDataURL) {
      const url = cv.toDataURL('image/png');
      const imgCover = document.getElementById('pdfScoreChartCover');
      if (imgCover) imgCover.src = url;
    }
  }catch(e){
    console.warn('chart toDataURL ì‹¤íŒ¨(ë¬´ì‹œ ê°€ëŠ¥)', e);
  }

  // 8) í˜ì´ì§€ ìˆ˜(í˜„ì¬ëŠ” 3í˜ì´ì§€ ê³ ì •)
  document.getElementById('pdfTotalPages1').textContent = '3';
  document.getElementById('pdfTotalPages2').textContent = '3';
  document.getElementById('pdfTotalPages3').textContent = '3';
}

async function downloadPDF_dashboard_land(){
  if(!window.html2pdf || !window.Chart){
    alert('Chart.js ë˜ëŠ” html2pdf ë¡œë“œ ì‹¤íŒ¨'); return;
  }
  try {
    // 1) í˜„ì¬ í™”ë©´ ìƒíƒœë¥¼ PDF ì»¨í…Œì´ë„ˆì— ë™ê¸°í™”
    syncPdfContainer();

    // 2) PDF ëª¨ë“œ í™œì„±í™” (PDF ì „ìš© CSS ìŠ¤ì½”í”„ ì‘ë™)
    document.body.classList.add('pdf-mode');

    // 3) í°íŠ¸/ë ˆì´ì•„ì›ƒ ì•ˆì •í™” ëŒ€ê¸°
    if (document.fonts && document.fonts.ready) await document.fonts.ready;
    await new Promise(r => requestAnimationFrame(r));

    // 4) A4 / ë‹¤í˜ì´ì§€ / CSS ë¶„í•  ì¡´ì¤‘
    const opt = {
      margin: [10,12,10,12],
      filename: `report_${(document.getElementById('studentName')?.value||'student')}_${new Date().toISOString().slice(0,10)}.pdf`,
      image: { type: 'jpeg', quality: 0.95 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
      pagebreak: { mode: ['css','legacy'] }
    };

    await html2pdf().set(opt).from(document.getElementById('pdfContainer')).save();

  } catch(e){
    console.error(e);
    alert('PDF ìƒì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
  } finally {
    document.body.classList.remove('pdf-mode');
  }
}
</script> 

<script>
// ========== ì¸ì¦/í”„ë¡œí•„ ìµœì†Œ êµ¬í˜„ ==========
function openAuth(){ document.getElementById('authWrap').classList.remove('hidden'); }
function closeAuth(){ document.getElementById('authWrap').classList.add('hidden'); }
function switchTab(t){
  document.getElementById('tabLogin').classList.toggle('active', t==='login');
  document.getElementById('tabRegister').classList.toggle('active', t==='register');
  document.getElementById('loginPanel').classList.toggle('hidden', t!=='login');
  document.getElementById('registerPanel').classList.toggle('hidden', t!=='register');
}

async function refreshMe(){
  try{
    const r = await fetch('/auth/me', { credentials:'include' });
    const j = await r.json();
    window.currentUser = j && j.user ? j.user : null;
  }catch{ window.currentUser = null; }
  renderAuthUI();
}

function renderAuthUI(){
  const loginBtn = document.getElementById('loginBtn');
  const prof = document.getElementById('profileArea');
  const name = document.getElementById('profileName');
  const avatar = document.getElementById('avatarInitial');
  if(currentUser){
    loginBtn.classList.add('hidden');
    prof.classList.remove('hidden');
    name.textContent = currentUser.name || currentUser.email || '';
    avatar.textContent = (currentUser.name||currentUser.email||'?').slice(0,1).toUpperCase();
  }else{
    prof.classList.add('hidden');
    loginBtn.classList.remove('hidden');
  }
}

async function login(){
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const err = document.getElementById('loginError'); err.style.display='none'; err.textContent='';
  try{
    const r = await fetch('/auth/login', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email, password }),
      credentials:'include'
    });
    const j = await r.json();
    if(!r.ok || !j.ok){ throw new Error(j.error||'ë¡œê·¸ì¸ ì‹¤íŒ¨'); }
    closeAuth();
    await refreshMe();
    // ëŒ€ê¸° ì¤‘ì´ë˜ ë™ì‘ ì²˜ë¦¬
    if(deferredAction==='review') submitEssay();
    if(deferredAction==='example') loadExample();
    if(deferredAction==='goEditor') goToEditor();
    deferredAction=null;
  }catch(e){
    err.textContent = e.message || 'ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.';
    err.style.display='block';
  }
}

async function register(){
  const name = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const password = document.getElementById('regPassword').value;
  const err = document.getElementById('registerError'); err.style.display='none'; err.textContent='';
  try{
    const r = await fetch('/auth/register', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name, email, password }),
      credentials:'include'
    });
    const j = await r.json();
    if(!r.ok || !j.ok){ throw new Error(j.error||'íšŒì›ê°€ì… ì‹¤íŒ¨'); }
    closeAuth();
    await refreshMe();
    if(deferredAction==='review') submitEssay();
    if(deferredAction==='example') loadExample();
    if(deferredAction==='goEditor') goToEditor();
    deferredAction=null;
  }catch(e){
    err.textContent = e.message || 'ì…ë ¥ ê°’ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.';
    err.style.display='block';
  }
}

async function logout(){
  try{ await fetch('/auth/logout', { method:'POST', credentials:'include' }); }catch{}
  currentUser=null; renderAuthUI();
}

document.addEventListener('DOMContentLoaded', refreshMe);
</script>

<!-- >>> PDF CONTAINER START (ë¦¬ë‰´ì–¼) -->
<section id="pdfContainer" class="pdf-scope" style="display:none">

  <!-- 1í˜ì´ì§€: í‘œì§€ -->
  <div class="page">
    <div class="header">
      <div>ì•„ì¹´ë°ë¯¸ì°½ Â· ë‹¤ì“° ë¦¬í¬íŠ¸</div>
      <div id="pdfHeaderStudent"></div>
    </div>

    <div class="card cover-hero avoid-break">
      <div class="cover-title-row">
        <div>
          <div class="cover-title-main" id="pdfCoverTitle">í•™ìƒ ë¦¬í¬íŠ¸</div>
          <div class="muted cover-sub" id="pdfCoverQuestion"></div>
        </div>
        <div id="pdfStatusBadge" class="status-badge"></div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card avoid-break">
        <div class="section-title">í•™ìƒ ì •ë³´</div>
        <div class="pdf-text">
          ì´ë¦„: <span id="pdfStudentName"></span><br/>
          ì‘ì„±ì¼: <span id="pdfDate"></span><br/>
          ê¸€ì ìˆ˜: <span id="pdfCharCount"></span>ì
        </div>
      </div>

      <div class="card avoid-break">
        <div class="section-title">í•œ ì¤„ ì´í‰</div>
        <div class="pdf-text" id="pdfSummary"></div>
      </div>
    </div>

    <div class="card avoid-break">
      <div class="section-title">í‰ê°€ ê²°ê³¼ ìš”ì•½</div>
      <div class="score-layout">
        <div class="score-left">
          <div class="score-main-line">
            ì´ì  <span id="pdfTotalScore"></span> / 40ì  Â·
            <span id="pdfStatusLabel2" class="status-pill"></span>
          </div>
          <div class="muted score-main-desc" id="pdfStatusDesc"></div>
          <div class="muted">
            ì´ ë¦¬í¬íŠ¸ëŠ” ì•„ì¹´ë°ë¯¸ì°½ ë‹¤ì“° ë¦¬í¬íŠ¸ì˜ AI ë¶„ì„ì„ ë°”íƒ•ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
          </div>
        </div>
       </div>
      </div>


      <div class="card avoid-break">
       <div class="section-title">ì ìˆ˜ ê·¸ë˜í”„</div>
       <div style="text-align:center">
         <img id="pdfScoreChartCover"
              alt="Score Chart"
              style="max-width:70%; width:70%; margin:0 auto; display:block;" />
       </div>
      </div>


    <div class="footer">
      <div>Generated by ë‹¤ì“° ë¦¬í¬íŠ¸</div>
      <div>Page 1 / <span id="pdfTotalPages1">3</span></div>
    </div>
  </div>

  <!-- 2í˜ì´ì§€: ë¬¸ì œ/ì œì‹œë¬¸/í•™ìƒ ë…¼ìˆ ë¬¸/ì„¸ë¶€ ì ìˆ˜ -->
  <div class="page">
    <div class="header">
      <div>ë¬¸ì œ Â· ì œì‹œë¬¸ Â· í•™ìƒ ë…¼ìˆ ë¬¸</div>
      <div id="pdfHeaderStudent2"></div>
    </div>

    <div class="card avoid-break">
      <div class="section-title">ì§ˆë¬¸</div>
      <div class="pdf-text" id="pdfQuestion"></div>
    </div>

    <div class="card avoid-break">
      <div class="section-title">ì œì‹œë¬¸ (ì „ë¬¸)</div>
      <div class="pdf-text" id="pdfPassages"></div>
    </div>

    <div class="card avoid-break">
      <div class="section-title">í•™ìƒ ë…¼ìˆ ë¬¸</div>
      <div class="pdf-text" id="pdfEssay"></div>
      <div class="muted" style="margin-top:4px;">
        ê¸€ì ìˆ˜: <span id="pdfCharCount2"></span>ì
      </div>
    </div>

    <div class="card avoid-break">
     <div class="section-title">í‰ê°€ ìš”ì•½ (ë…¼ë¦¬ Â· ë…í•´ Â· êµ¬ì„± Â· í‘œí˜„)</div>
     <div class="score-layout">
       <div class="score-left">
         <div class="score-main-line">
           ì´ì  <span id="pdfTotalScoreDetail"></span> / 40ì  Â·
           <span id="pdfStatusLabelDetail" class="status-pill"></span>
         </div>
         <div class="muted score-main-desc" id="pdfStatusDescDetail"></div>
         <div id="pdfScoreCards" class="score-cards"></div>
       </div>
     </div>
   </div>


    <div class="footer">
      <div>ì•„ì¹´ë°ë¯¸ì°½ Â· ë‹¤ì“° ë¦¬í¬íŠ¸</div>
      <div>Page 2 / <span id="pdfTotalPages2">3</span></div>
    </div>
  </div>

  <!-- 3í˜ì´ì§€: ì˜ˆì‹œë‹µì•ˆ Â· ë¹„êµë¶„ì„ -->
  <div class="page">
    <div class="header">
      <div>ì˜ˆì‹œë‹µì•ˆ Â· ë¹„êµë¶„ì„</div>
      <div id="pdfHeaderStudent3"></div>
    </div>

    <div class="card avoid-break">
      <div class="section-title">ì˜ˆì‹œë‹µì•ˆ</div>
      <div class="muted" style="margin-bottom:4px;">
        â€» ì´ ì˜ˆì‹œë‹µì•ˆì€ í•™ìƒ ê¸€ì˜ ë¬¸ì²´ì™€ ìˆ˜ì¤€ì„ ì°¸ê³ í•˜ì—¬ ì‘ì„±ëœ ì°¸ê³ ìš© ì˜ˆì‹œì…ë‹ˆë‹¤.
      </div>
      <div class="pdf-text" id="pdfExample"></div>
    </div>

    <div class="card avoid-break">
      <div class="section-title">ë¹„êµë¶„ì„</div>
      <div id="pdfComparison" class="pdf-text"></div>
    </div>

    <div class="footer">
      <div>ì•„ì¹´ë°ë¯¸ì°½ Â· ë‹¤ì“° ë¦¬í¬íŠ¸</div>
      <div>Page 3 / <span id="pdfTotalPages3">3</span></div>
    </div>
  </div>
</section>
<!-- <<< PDF CONTAINER END -->

<script>
function updatePdfBtnState(){
  const btn = document.getElementById('btnSavePDF');
  if(!btn) return;
  const ready =
    Array.isArray(savedScores) && savedScores.length === 4 &&
    !!savedExample &&
    !!savedComparison;
  btn.disabled = !ready;
  btn.title = ready ? '' : 'í‰ê°€(ë¦¬í¬íŠ¸ ìƒì„±)ì™€ ì˜ˆì‹œë‹µì•ˆê¹Œì§€ ìƒì„± í›„ ì €ì¥í•  ìˆ˜ ìˆì–´ìš”';
}

function openRecords(){
  document.getElementById('recordsWrap').classList.remove('hidden');
}
function closeRecords(){
  document.getElementById('recordsWrap').classList.add('hidden');
}
</script>
<script>
// ğŸ”¹ ì œì‹œë¬¸ OCR ëŒ€ìƒ textareaë¥¼ ê¸°ì–µí•˜ëŠ” ì „ì—­ ë³€ìˆ˜
let currentPassageTarget = null;

// ğŸ”¹ ì–´ë–¤ ì œì‹œë¬¸ ì¹¸ì´ í¬ì»¤ìŠ¤ë¥¼ ë°›ì•˜ëŠ”ì§€ ì¶”ì 
document.addEventListener('focusin', (e) => {
  const t = e.target;
  if (t && t.classList && t.classList.contains('passage')) {
    // âœ… ë°ëª¨(#passagesDemo) ì œì™¸, ì‹¤ì œ ì…ë ¥ ì˜ì—­(#passages)ë§Œ ì¸ì •
    if (t.closest && t.closest('#passages')) {
      currentPassageTarget = t;
    }
  }
});


</script>

<!-- ğŸ†• ì—¬ê¸° OCRìš© ìŠ¤í¬ë¦½íŠ¸ í•˜ë‚˜ ë¼ì›Œ ë„£ê¸° -->
 
<!-- ğŸ†• ì œì‹œë¬¸ / ë…¼ìˆ ë¬¸ OCR ë° ì´ë¯¸ì§€ ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
const MAX_IMAGE_SIZE = 5 * 1024 * 1024; // âœ… 5MB ì œí•œ (ë¶„ì„ìš© ì´ë¯¸ì§€ ê¸°ì¤€)

document.addEventListener('DOMContentLoaded', () => {
  const essayOcrBtn   = document.getElementById('btnEssayOcr');
  const essayOcrInput = document.getElementById('essayImageInput');
  const essayArea     = document.getElementById('essay');
  const loadingEl     = document.getElementById('loading');
  const errorEl       = document.getElementById('error');

  const passageOcrBtn   = document.getElementById('btnPassageOcr');
  const passageOcrInput = document.getElementById('passageImageInput');

  // ---------- ê³µí†µ: ì—ëŸ¬ / ë¡œë”© í—¬í¼ ----------
  function clearError(){
    if (errorEl) {
      errorEl.style.display = 'none';
      errorEl.textContent = '';
    }
  }
  function setError(msg){
    if (errorEl) {
      errorEl.textContent = msg;
      errorEl.style.display = 'block';
    }
  }
  function setLoading(msg){
    if (!loadingEl) return;
    if (msg) {
      loadingEl.textContent = msg;
      loadingEl.style.display = 'block';
    } else {
      loadingEl.style.display = 'none';
    }
  }

  // ---------- ì œì‹œë¬¸ ì´ë¯¸ì§€ í”„ë¦¬ë·° ì»¨í…Œì´ë„ˆ ----------
  function ensurePassagePreview(targetTextarea){
    if (!targetTextarea) return null;
    let preview = targetTextarea.nextElementSibling;
    if (!preview || !preview.classList.contains('passage-preview')) {
      preview = document.createElement('div');
      preview.className = 'passage-preview';
      targetTextarea.insertAdjacentElement('afterend', preview);
    }
    return preview;
  }

  // ========== 1) ë…¼ìˆ ë¬¸: íŒŒì¼ ì—…ë¡œë“œ â†’ OCR â†’ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ ==========
  async function runEssayOcrWithFile(file){
  if (!file || !essayArea) return;

  if (file.size > MAX_IMAGE_SIZE) {
    setError('ì‚¬ì§„ íŒŒì¼ì€ 5MB ì´í•˜ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆì–´ìš”.');
    return;
  }

  const formData = new FormData();
  formData.append('image', file);

  clearError();
  setLoading('ğŸ“¸ ë…¼ìˆ ë¬¸ì„ ì½ê³  ìˆì–´ìš”â€¦');
  showGlobalLoading('ocr');


    try{
      const res  = await fetch('/api/ocr', {
        method: 'POST',
        body: formData,
        credentials: 'include',
      });
      const data = await res.json();

      if (!data.ok) {
        throw new Error(data.error || 'OCR ì‹¤íŒ¨');
      }

      const text = data.text || '';
      const prefix = essayArea.value ? '\n' : '';
      essayArea.value = essayArea.value + prefix + text;

      if (typeof autoResize === 'function') autoResize(essayArea);
      if (typeof updateCharCount === 'function') updateCharCount();

      setLoading(null);
    }catch(err){
      console.error('Essay OCR error:', err);
      setLoading(null);
      setError('ì‚¬ì§„ì—ì„œ ê¸€ìë¥¼ ì½ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
    }finally{
    hideGlobalLoading();       // ğŸŸ¦ ì¶”ê°€
  }
}

  // ë²„íŠ¼ â†’ íŒŒì¼ ì„ íƒ
  if (essayOcrBtn && essayOcrInput && essayArea) {
    essayOcrBtn.addEventListener('click', () => {
      clearError();
      essayOcrInput.value = '';
      essayOcrInput.click();
    });

    // íŒŒì¼ ì„ íƒ í›„ OCR ì‹¤í–‰
    essayOcrInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      runEssayOcrWithFile(file);
    });

    // ë…¼ìˆ ë¬¸ textareaì— ì§ì ‘ "ë¶™ì—¬ë„£ê¸°" í–ˆì„ ë•Œ, ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ OCR ì‹¤í–‰
    essayArea.addEventListener('paste', (e) => {
      const cd = e.clipboardData;
      if (!cd || !cd.items) return;

      // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë™ì‘(í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°) ìœ ì§€
      const items = Array.from(cd.items);
      const imageItem = items.find(it => it.type && it.type.startsWith('image/'));
      if (!imageItem) return;

      e.preventDefault(); // ì´ë¯¸ì§€ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ëŠ” ê¸°ë³¸ ë™ì‘ ë§‰ê¸°

      const file = imageItem.getAsFile();
      if (!file) return;
      runEssayOcrWithFile(file);
    });
  }

  // ========== 2-0) ì œì‹œë¬¸: ë²„íŠ¼ í´ë¦­ â†’ íŒŒì¼ ì„ íƒ ì—´ê¸° ==========
  if (passageOcrBtn && passageOcrInput) {
    passageOcrBtn.addEventListener('click', () => {
      clearError();
      passageOcrInput.value = '';
      passageOcrInput.click();
    });

    // ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥
    passageOcrInput.addEventListener('change', (e) => {
      const files = (e.target.files ? Array.from(e.target.files) : []);
      if (files.length === 0) return;

      // í¬ì»¤ìŠ¤ëœ ì œì‹œë¬¸ì´ ì—†ìœ¼ë©´ ì²« ì¹¸ìœ¼ë¡œ
      if(!currentPassageTarget){
        const first = document.querySelector('#passages .passage');
        if(first) currentPassageTarget = first;
      }

      files.forEach(f => addImageToCurrentPassage(f));
    });
  }

  // ========== 2) ì œì‹œë¬¸: íŒŒì¼ / ë¶™ì—¬ë„£ê¸° â†’ ì´ë¯¸ì§€ "ê·¸ëŒ€ë¡œ" ì¶”ê°€ ==========
function addImageToCurrentPassage(file){
  if (file.size > MAX_IMAGE_SIZE) {
    alert('ì´ë¯¸ì§€ íŒŒì¼ì€ 5MB ì´í•˜ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆì–´ìš”.');
    return;
  }

  // âœ… í¬ì»¤ìŠ¤ëœ ì œì‹œë¬¸ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì œì‹œë¬¸ì„ ëŒ€ìƒìœ¼ë¡œ
  if(!currentPassageTarget){
    const first = document.querySelector('.passage');
    if(!first) return;
    currentPassageTarget = first;
  }


  // âœ… previewëŠ” "í•´ë‹¹ textarea ë°”ë¡œ ë‹¤ìŒ"ì— ë¶™ì´ëŠ” ë°©ì‹ìœ¼ë¡œ ì•ˆì •í™”
  const preview = ensurePassagePreview(currentPassageTarget);

  // âœ… ì´ textareaì— ì´ë¯¸ ì—°ê²°ëœ ì´ë¯¸ì§€ ë°°ì—´(ì—†ìœ¼ë©´ ìƒˆë¡œ)
  let prevArr = passageImageMap.get(currentPassageTarget) || [];

  // âœ… í˜¹ì‹œ ì˜ˆì „ ë°ì´í„°(string)ê°€ ì„ì—¬ ìˆìœ¼ë©´ ì •ê·œí™”
  prevArr = prevArr.map(item => {
    if (typeof item === 'string') {
      return {
        src: item,
        confirmed: false,
        desc: null
      };
    }
    return item;
  });


  if (prevArr.length >= 3) {
    alert('ì œì‹œë¬¸ë‹¹ ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 3ì¥ê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.');
    return;
  }

const reader = new FileReader();
reader.onload = () => {

    const dataUrl = reader.result; // "data:image/png;base64,...."

    // âœ… ë°°ì—´ì— ì¶”ê°€ (ì—¬ëŸ¬ ì¥ ì§€ì›)
    prevArr.push({
      src: dataUrl,
      confirmed: false,
      desc: null
    });

passageImageMap.set(currentPassageTarget, prevArr);

    // âœ… í”„ë¦¬ë·° ë‹¤ì‹œ ê·¸ë¦¬ê¸°(ì—¬ëŸ¬ ì¥ ì¸ë„¤ì¼ + ê°œë³„ ì‚­ì œ)
    preview.innerHTML = '';
    prevArr.forEach((imageObj, idx) => {
    const item = document.createElement('div');
    item.style.cssText = 'display:inline-block; position:relative; margin:6px;';

    // ì´ë¯¸ì§€
    const img = document.createElement('img');
    img.src = imageObj.src;
    img.style.cssText = 'max-width:160px; border-radius:8px; display:block;';
    item.appendChild(img);
  
    // ğŸ†• ì‚¬ì§„ í™•ì • ë²„íŠ¼
    const confirmBtn = document.createElement('button');
    confirmBtn.type = 'button';
    confirmBtn.textContent = imageObj.confirmed ? 'í™•ì •ë¨' : 'ì‚¬ì§„ í™•ì •í•˜ê¸°';
    confirmBtn.style.cssText = `
      margin-top:4px;
      width:100%;
      font-size:12px;
      padding:4px 6px;
      border-radius:6px;
      border:1px solid #d1d5db;
      background:${imageObj.confirmed ? '#e5e7eb' : '#fff'};
      cursor:${imageObj.confirmed ? 'default' : 'pointer'};
    `;
    confirmBtn.disabled = imageObj.confirmed;

    confirmBtn.onclick = async () => {
      if (imageObj.confirmed) return;

      confirmBtn.textContent = 'í™•ì • ì¤‘...';
      confirmBtn.disabled = true;

      try {
        const res = await fetch('/api/image-confirm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: imageObj.src })
        });
        const data = await res.json();
        if (!data.ok) throw new Error();

        imageObj.confirmed = true;
        imageObj.desc = data.image_desc;

        confirmBtn.textContent = 'í™•ì •ë¨';
        confirmBtn.style.background = '#e5e7eb';
      } catch (e) {
        alert('ì‚¬ì§„ í™•ì •ì— ì‹¤íŒ¨í–ˆì–´ìš”.');
        confirmBtn.textContent = 'ì‚¬ì§„ í™•ì •í•˜ê¸°';
        confirmBtn.disabled = false;
      }
    };

    item.appendChild(confirmBtn);

    // ì‚­ì œ ë²„íŠ¼ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
    const rm = document.createElement('button');
    rm.className = 'img-remove';
    rm.textContent = 'ì‚­ì œ';

    rm.onclick = () => {
      const imgs = passageImageMap.get(textarea) || [];
      const target = imgs[idx];

      // âœ… í™•ì •ëœ ì´ë¯¸ì§€ë©´ ê²½ê³ 
      if (target && target.confirmed) {
        const ok = confirm(
          'ì´ ì´ë¯¸ì§€ëŠ” ì´ë¯¸ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\nì‚­ì œí•˜ë©´ ë¶„ì„ ê¸°ì¤€ì—ì„œ ì™„ì „íˆ ì œê±°ë©ë‹ˆë‹¤.\nì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
        );
        if (!ok) return;
      }

      // âœ… ë°°ì—´ì—ì„œ ì œê±°
      imgs.splice(idx, 1);
      passageImageMap.set(textarea, imgs);

      if (imgs.length === 0) {
        passageImageMap.delete(textarea);
      }

      // âœ… í”„ë¦¬ë·° ë‹¤ì‹œ ë Œë”
      renderPassageImagePreview(textarea);
    };

    wrap.appendChild(rm);

    preview.appendChild(item);
  });
  };

  reader.readAsDataURL(file);
}

  // ì œì‹œë¬¸ textareaì— "ë¶™ì—¬ë„£ê¸°" í–ˆì„ ë•Œ, ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í”„ë¦¬ë·°ë¡œë§Œ ì¶”ê°€
document.addEventListener('paste', (e) => {
  const active = document.activeElement;

  // âœ… ë°ëª¨(#passagesDemo) ì œì™¸, ì‹¤ì œ ì…ë ¥ ì˜ì—­(#passages)ë§Œ í—ˆìš©
    if (!active || !active.classList || !active.classList.contains('passage') || !(active.closest && active.closest('#passages'))) {
      return;
    }

    const cd = e.clipboardData;
    if (!cd || !cd.items) return;

    const items = Array.from(cd.items);
    const imageItem = items.find(it => it.type && it.type.startsWith('image/'));
    if (!imageItem) return; // ì´ë¯¸ì§€ ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°

  // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´, í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° ëŒ€ì‹  ì´ë¯¸ì§€ í”„ë¦¬ë·°ë§Œ ì¶”ê°€
    e.preventDefault();

    const file = imageItem.getAsFile();
    if (!file) return;

    currentPassageTarget = active;
    addImageToCurrentPassage(file);
  });
});
</script>
<script>
// ===== ê¸€ë¡œë²Œ ë¡œë”© ë¬¸êµ¬ & ì»¨íŠ¸ë¡¤ =====
const loadingPhrases = {
  review: [
    'ê¸€ì˜ ìˆ¨ì€ ê·¼ê±°ë“¤ì„ í•˜ë‚˜ì”© êº¼ë‚´ë³´ëŠ” ì¤‘ì´ì—ìš”.',
    'ë…¼ë¦¬Â·ë…í•´Â·êµ¬ì„±Â·í‘œí˜„ì„ ë„¤ ë°©í–¥ì—ì„œ í›‘ì–´ë³´ê³  ìˆì–´ìš”.',
    'ì„ ìƒë‹˜ì´ë¼ë©´ ë­ë¼ê³  ë§í• ì§€ ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ì ì–´ë³´ê³  ìˆì–´ìš”.'
  ],
  example: [
    'ë„¤ê°€ ì“´ ë¬¸ì¥ì„ ì‚´ë¦¬ë©´ì„œ ë” ë‹¨ë‹¨í•œ ë²„ì „ì„ ê³ ë¯¼í•˜ê³  ìˆì–´ìš”.',
    'ì˜ˆì‹œë‹µì•ˆì´ í•™ìƒ ê¸€ì„ ë°€ì–´ë‚´ì§€ ì•Šë„ë¡ ê±°ë¦¬ê°ì„ ë§ì¶”ëŠ” ì¤‘ì´ì—ìš”.'
  ],
  ocr: [
    'ì‚¬ì§„ ì† ê¸€ìë¥¼ í•œ ê¸€ìì”© ë”ë“¬ì–´ ì½ëŠ” ì¤‘ì´ì—ìš”.',
    'ì¤„ë°”ê¿ˆê³¼ ë„ì–´ì“°ê¸°ë„ ê°€ëŠ¥í•œ í•œ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜¤ë ¤ê³  í•´ìš”.'
  ]
};

let loadingPhraseTimer = null;

function showGlobalLoading(kind = 'review'){
  const wrap   = document.getElementById('globalLoading');
  const mainEl = document.getElementById('loadingMessage');
  const subEl  = document.getElementById('loadingSubMessage');
  if(!wrap || !mainEl || !subEl) return;

  const list = loadingPhrases[kind] || loadingPhrases.review;
  let idx = 0;

  // íƒ€ì´í‹€ì€ ìƒí™©ë³„ë¡œ ì•½ê°„ ë‹¤ë¥´ê²Œ
  if(kind === 'review'){
    mainEl.textContent = 'ë¦¬í¬íŠ¸ë¥¼ ë§Œë“¤ê³  ìˆì–´ìš”';
  }else if(kind === 'example'){
    mainEl.textContent = 'ì˜ˆì‹œë‹µì•ˆì„ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”';
  }else if(kind === 'ocr'){
    mainEl.textContent = 'ì‚¬ì§„ ì† ê¸€ìë¥¼ ì½ê³  ìˆì–´ìš”';
  }else{
    mainEl.textContent = 'ê¸€ì„ ì½ê³  ìˆì–´ìš”';
  }

  subEl.textContent  = list[0] || '';

  if(loadingPhraseTimer){
    clearInterval(loadingPhraseTimer);
    loadingPhraseTimer = null;
  }

  loadingPhraseTimer = setInterval(()=>{
    idx = (idx + 1) % list.length;
    subEl.textContent = list[idx];
  }, 1900);

  wrap.classList.remove('hidden');
}

function hideGlobalLoading(){
  const wrap = document.getElementById('globalLoading');
  if(wrap) wrap.classList.add('hidden');
  if(loadingPhraseTimer){
    clearInterval(loadingPhraseTimer);
    loadingPhraseTimer = null;
  }
}
</script>
<script>
document.addEventListener('DOMContentLoaded', updatePdfBtnState);
</script>
<!-- ===== ì œì‹œë¬¸ ì´ë¯¸ì§€ í™•ì • ì•ˆë‚´ ëª¨ë‹¬ ===== -->
<div id="imageConfirmModal" class="modal-backdrop hidden">
  <div class="modal">
    <h3 style="margin: 0 0 8px; font-weight: 900;">
      ì•„ì§ í™•ì •ë˜ì§€ ì•Šì€ ì œì‹œë¬¸ ì´ë¯¸ì§€ê°€ ìˆì–´ìš”
    </h3>

    <p class="muted" style="line-height: 1.6;">
      ì´ ì œì‹œë¬¸ ì´ë¯¸ì§€ëŠ” ì•„ì§ í•´ì„ì´ í™•ì •ë˜ì§€ ì•Šì•˜ì–´ìš”.<br><br>
      ì§€ê¸ˆ ì§„í–‰í•˜ë©´ <b>í™•ì •ëœ ì œì‹œë¬¸ë§Œ</b>ì„ ê·¼ê±°ë¡œ<br>
      ë¦¬í¬íŠ¸ê°€ ë§Œë“¤ì–´ì ¸ìš”.
    </p>

    <div style="display: flex; gap: 10px; margin-top: 18px;">
      <button
        id="btnProceedWithoutImage"
        class="btn btn-primary"
        style="flex: 1;"
      >
        ì´ëŒ€ë¡œ ë¦¬í¬íŠ¸ ìƒì„±
      </button>

      <button
        id="btnGoConfirmImage"
        class="btn btn-ghost"
        style="flex: 1;"
      >
        ì‚¬ì§„ í™•ì •í•˜ëŸ¬ ê°€ê¸°
      </button>
    </div>
  </div>
</div>

</body>
</html>


