<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì•„ì¹´ë°ë¯¸ì°½ Â· ë‹¤ì“° ë¦¬í¬íŠ¸</title>

<link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
:root{
  --brand:#2140B1; --brand-700:#1a2f91;
  --ink:#111827; --muted:#6B7280; --line:rgba(17,24,39,.10);
  --bg:#f7f9ff; --white:#fff; --glass:rgba(255,255,255,.55);
}
*{ box-sizing:border-box; font-family:'SUIT',system-ui,sans-serif; letter-spacing:-.2px }
html,body{ margin:0; color:var(--ink); background:var(--bg) }
a{ color:inherit; text-decoration:none }
.container{ max-width:1180px; margin:0 auto; padding:0 24px }
.hidden{ display:none }
.muted{ color:var(--muted) }
.badge{ font-weight:900; color:var(--brand-700); background:#EEF2FF; border:1px solid #e6ebff; padding:6px 10px; border-radius:999px; display:inline-flex; align-items:center; gap:6px }
.card{ background:var(--white); border:1px solid #eef2ff; border-radius:18px; padding:18px; box-shadow:0 12px 30px rgba(17,24,39,.06); overflow:hidden }

header{
  position:sticky; top:0; z-index:20; background:rgba(255,255,255,.75);
  backdrop-filter:blur(10px); border-bottom:1px solid var(--line);
}
.nav{ height:66px; display:flex; align-items:center; justify-content:space-between }
.nav-left{ display:flex; align-items:center; gap:10px; font-weight:900 }
.nav-right{ display:flex; gap:12px; align-items:center }
.btn{ border:none; height:44px; padding:0 18px; border-radius:14px; font-weight:800; cursor:pointer; transition:.2s }
.btn-primary{ background:var(--brand); color:#fff; box-shadow:0 8px 20px rgba(33,64,177,.18) }
.btn-primary:hover{ transform:translateY(-1px); box-shadow:0 12px 28px rgba(33,64,177,.22) }
.btn-ghost{ background:#fff; border:1px solid #e5e7eb }
.btn-link{ background:transparent; border:none; color:#374151; font-weight:800; cursor:pointer }

.hero{
  padding:96px 0 50px;
  background:
    radial-gradient(1200px 600px at 80% -30%, rgba(33,64,177,.22), transparent),
    radial-gradient(900px 500px at -10% 20%, rgba(33,64,177,.12), transparent),
    linear-gradient(180deg, #ffffff 0%, #f7f9ff 60%);
  border-bottom:1px solid var(--line);
}
.hero h1{ margin:0 0 12px; font-size:clamp(36px,6vw,64px); line-height:1.08; font-weight:900 }
.hero p{ margin:0 0 24px; font-size:18px; color:#4b5563 }

/* Showcase (Two Monitors) */
.showcase{ padding:32px 0 20px; border-bottom:1px solid var(--line);
  background:
    radial-gradient(900px 400px at 10% -10%, rgba(33,64,177,.08), transparent),
    radial-gradient(800px 300px at 110% 10%, rgba(33,64,177,.06), transparent);
}
.monitor-grid{ display:grid; grid-template-columns:1fr 1fr; gap:22px }
@media(max-width:980px){ .monitor-grid{ grid-template-columns:1fr; } }

.monitor{
  border-radius:22px; padding:16px; background:rgba(255,255,255,.7);
  backdrop-filter: blur(10px);
  border:1px solid rgba(255,255,255,.6);
  box-shadow:0 30px 60px rgba(33,64,177,.14), inset 0 0 0 1px #eef2ff;
}
.monitor .bar{
  height:22px; display:flex; align-items:center; gap:8px; padding:0 10px;
}
.dot{ width:10px; height:10px; border-radius:50% }
.dot.red{ background:#ff5f57 } .dot.yellow{ background:#ffbd2e } .dot.green{ background:#28c840 }
.monitor .screen{
  border-radius:16px; background:#fff; border:1px solid #eef2ff; overflow:hidden;
  height: 420px; position:relative
}
@media(max-width:980px){ .monitor .screen{ height: 360px } }

/* Screen inner: fixed width then scaled down for sharpness */
.viewport{
  position:absolute; inset:0; display:flex; align-items:stretch; justify-content:center; overflow:hidden;
}
.viewport > .stage{
  width: 980px; /* base layout width to clone into */
  transform-origin: top left;
  /* scale is calculated in JS to fit into .screen */
  padding: 16px;
}

/* Placeholder slide style */
.placeholder{ padding:18px }
.placeholder h4{ margin:0 0 8px; font-weight:900 }
.placeholder .line{ height:12px; background:#eef2ff; border-radius:8px; margin:8px 0; }
.placeholder .chip{ display:inline-block; padding:6px 10px; border-radius:999px; background:#f3f4f6; border:1px solid #e5e7eb; margin-right:6px; font-weight:800; color:#475569; font-size:12px }
.fade{ animation:fadeUp .45s ease } @keyframes fadeUp{ from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

/* Editor */
.section{ padding:56px 0 }
.panel{ background:var(--glass); backdrop-filter:blur(14px); border:1px solid rgba(255,255,255,.5);
  border-radius:22px; padding:22px; box-shadow:0 10px 30px rgba(17,24,39,.1) }
.form-label{ font-weight:900; margin:12px 0 6px; display:block }
.input,.textarea{ width:100%; padding:14px 16px; border:1px solid #e5e7eb; border-radius:12px; font-size:16px; line-height:1.6; resize:none }
.input:focus,.textarea:focus{ outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(33,64,177,.18) }
.textarea::placeholder,.input::placeholder{ color:#9CA3AF }
#passages{ display:grid; grid-template-columns:1fr 1fr; gap:14px }
@media (max-width:680px){ #passages{ grid-template-columns:1fr } }
.kpi{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
@media (max-width:900px){ .kpi{ grid-template-columns:1fr } }

/* Auth modal */
.modal-backdrop{ position:fixed; inset:0; background:rgba(17,24,39,.4); display:flex; align-items:center; justify-content:center; z-index:50 }
.modal{ width:min(560px,90vw); background:#fff; border-radius:18px; border:1px solid #e5e7eb; box-shadow:0 24px 60px rgba(17,24,39,.22); padding:18px }
.tabs{ display:flex; gap:8px; margin-bottom:12px }
.tab{ flex:1; height:40px; border-radius:999px; border:1px solid #e5e7eb; background:#f8fafc; font-weight:800; cursor:pointer }
.tab.active{ background:#EEF2FF; border-color:#dbe4ff; color:var(--brand-700) }
.row{ display:flex; gap:10px }
.avatar{ width:32px; height:32px; border-radius:50%; background:#EEF2FF; color:var(--brand-700); display:flex; align-items:center; justify-content:center; font-weight:900 }
.dropdown{ position:relative }
.dropdown-menu{ position:absolute; right:0; top:44px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 12px 30px rgba(17,24,39,.12); padding:8px; min-width:160px; display:none }
.dropdown-menu a, .dropdown-menu button{ display:block; width:100%; text-align:left; background:transparent; border:none; padding:8px 10px; border-radius:8px; font-weight:700; color:#374151; cursor:pointer }
.dropdown-menu a:hover, .dropdown-menu button:hover{ background:#f3f4f6 }
</style>
</head>

<body>
<header>
  <div class="container nav">
    <div class="nav-left" style="gap:10px">
      <div style="width:10px;height:10px;border-radius:50%;background:var(--brand)"></div>
      <span>ì•„ì¹´ë°ë¯¸ì°½</span>
    </div>
    <div class="nav-right">
      <div id="profileArea" class="dropdown hidden">
        <div id="profileBtn" class="btn btn-ghost" style="display:flex;align-items:center;gap:8px">
          <div class="avatar" id="avatarInitial">A</div>
          <span id="profileName" class="muted" style="font-weight:800"></span>
        </div>
        <div class="dropdown-menu" id="profileMenu">
          <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
      <button id="loginBtn" class="btn btn-ghost" onclick="openAuth()">ë¡œê·¸ì¸</button>
      <button class="btn btn-primary" onclick="goToEditor()">AI ì²¨ì‚­í•˜ê¸°</button>
    </div>
  </div>
</header>

<main>
  <!-- ===================== HERO ===================== -->
  <section id="homeSection" class="hero">
    <div class="container">
      <div class="badge">âœ¨ ë…¼ìˆ  AI ì²¨ì‚­ Â· ìƒë‹´ìš© ë¦¬í¬íŠ¸</div>
      <h1>ê¸€ í‰ê°€ì™€ ì˜ˆì‹œ ì‘ì„±,<br/>ë” ì‰½ê³  ê°„í¸í•˜ê²Œ</h1>
      <p>í•™ìƒ ê¸€ ì…ë ¥ â†’ AI í‰ê°€/ê·¸ë˜í”„ â†’ ì œì‹œë¬¸ ê¸°ë°˜ ì˜ˆì‹œë‹µì•ˆ â†’ PDF ì €ì¥ê¹Œì§€, í•œ ë²ˆì—.</p>
      <div style="display:flex; gap:12px; flex-wrap:wrap">
        <button class="btn btn-primary" style="height:52px" onclick="goToEditor()">ì‹œì‘í•˜ê¸°</button>
      </div>
    </div>
  </section>

  <!-- ===================== SHOWCASE (Two Monitors) ===================== -->
  <section id="showcase" class="showcase">
    <div class="container">
      <div style="display:flex;justify-content:space-between;align-items:end;gap:12px;margin-bottom:12px">
        <h3 style="margin:0;font-weight:900">í•œ ëˆˆì— ë³´ëŠ” ì²¨ì‚­ íë¦„</h3>
        <div class="muted" style="font-size:13px">ì…ë ¥ë¶€í„° ê²°ê³¼ê¹Œì§€ ì‹¤ì œ í™”ë©´ ê·¸ëŒ€ë¡œ</div>
      </div>

      <div class="monitor-grid">
        <!-- Left Monitor: Input preview -->
        <div class="monitor fade">
          <div class="bar">
            <span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span>
            <span class="muted" style="font-weight:800;margin-left:8px">ë‹¤ì“° ë¦¬í¬íŠ¸ Â· ì…ë ¥</span>
          </div>
          <div class="screen">
            <div class="viewport"><div id="monitorInputStage" class="stage"></div></div>
          </div>
        </div>

        <!-- Right Monitor: Result preview -->
        <div class="monitor fade">
          <div class="bar">
            <span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span>
            <span class="muted" style="font-weight:800;margin-left:8px">ë‹¤ì“° ë¦¬í¬íŠ¸ Â· ê²°ê³¼</span>
          </div>
          <div class="screen">
            <div class="viewport"><div id="monitorResultStage" class="stage"></div></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===================== EDITOR ===================== -->
  <section id="editorSection" class="section hidden" style="visibility:hidden">
    <div class="container">

      <!-- ì…ë ¥ íŒ¨ë„ -->
      <div id="inputPanel" class="panel fade">
        <h2 style="margin:0 0 12px; font-weight:900">âœ¨ ë„ˆì˜ ê¸€, ì˜¤ëŠ˜ ë” ë©€ë¦¬ ë‚ ì•„ê°€ê²Œ.</h2>
        <p class="muted" style="margin-top:0">ì •ì„±ê» ì“´ ë¬¸ì¥ ìœ„ì— í•„ìš”í•œ í”¼ë“œë°±ë§Œ ì–¹ì–´, ëª©í‘œì— ë‹¿ë„ë¡ ë¶€ë“œëŸ½ê²Œ ì´ëŒì–´ ë“œë¦´ê²Œìš”.</p>

        <label class="form-label">í•™ìƒ ì´ë¦„</label>
        <input id="studentName" class="input" placeholder="ì˜ˆ: í™ê¸¸ë™" />

        <label class="form-label">ì§ˆë¬¸</label>
        <textarea id="question" class="textarea" rows="2" placeholder="ì§ˆë¬¸ì„ ì—¬ê¸°ì— ì‘ì„±í•´ ì£¼ì„¸ìš”."></textarea>

        <label class="form-label">ì œì‹œë¬¸ <span class="muted">(ìµœì†Œ 1ê°œ)</span></label>
        <div id="passages">
          <textarea class="passage textarea" rows="3" placeholder="ì œì‹œë¬¸ì„ ê·¸ëŒ€ë¡œ ì ì–´ ì£¼ì„¸ìš”."></textarea>
        </div>
        <div style="display:flex; justify-content:flex-end; margin-top:8px">
          <button type="button" class="btn btn-ghost" onclick="addPassage()">â• ì œì‹œë¬¸ ë” ì¶”ê°€</button>
        </div>

        <label class="form-label">ë…¼ìˆ ë¬¸ <span class="muted">(í•™ìƒ ì‘ì„± ê¸€)</span></label>
        <textarea id="essay" class="textarea" rows="6" placeholder="ì œì‹œë¬¸ë§Œ ê·¼ê±°ë¡œ, ë°°ê²½ì§€ì‹ ì—†ì´ ì‘ì„±í•´ ì£¼ì„¸ìš”." oninput="updateCharCount()"></textarea>
        <div id="charCount" class="muted" style="margin-top:6px"></div>

        <label class="form-label">ê¸€ì ìˆ˜ ì œí•œ</label>
        <div class="row">
          <input id="charLimit" class="input" placeholder="ì˜ˆ: 700" />
          <input id="charRange" class="input" placeholder="Â± ì˜ˆ: 50" />
        </div>

        <div style="margin-top:18px; text-align:center">
          <button class="btn btn-primary" onclick="submitEssay()">âš¡ ë¦¬í¬íŠ¸ ìƒì„±</button>
        </div>
        <div id="loading" class="muted" style="display:none; margin-top:8px">â³ ì½ê³  ìˆì–´ìš”â€¦ ë¬¸ì¥ ì‚¬ì´ì‚¬ì´ì˜ ì§„ì‹¬ê¹Œì§€ ë†“ì¹˜ì§€ ì•Šì„ê²Œìš”.</div>
        <div id="error" class="muted" style="display:none; color:#dc2626; margin-top:8px">ì ì‹œ ìˆ¨ ê³ ë¥´ëŠ” ì¤‘ì´ì—ìš”. ê³§ ë‹¤ì‹œ ë„ì™€ë“œë¦´ê²Œìš”.</div>
      </div>

      <!-- ê²°ê³¼ -->
      <div id="resultCard" class="panel fade hidden" style="margin-top:18px">
        <h3 style="margin-top:0">ğŸ“Š í•œëˆˆì— ì´í•´ë˜ëŠ” ë¦¬í¬íŠ¸</h3>
        <div id="evalSummary"></div>
      </div>

      <!-- ì˜ˆì‹œ/ë¹„êµ + PDF -->
      <div id="exampleSection" class="panel fade hidden" style="margin-top:18px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <h3 style="margin:0">ğŸ“ ì˜ˆì‹œë‹µì•ˆ</h3>
          <button id="btnExample" class="btn btn-primary" onclick="loadExample()">ì˜ˆì‹œë‹µì•ˆ ë³´ê¸°</button>
        </div>
        <div id="exampleNote" class="muted" style="margin-top:8px;display:none"></div>
        <div id="exampleOutput" class="card" style="background:#fff"></div>
        <div id="comparisonOutput" class="card" style="background:#fff"></div>
        <button class="btn btn-primary" style="margin-top:14px" onclick="downloadPDF()">ğŸ“¥ PDF ì €ì¥</button>
        <button class="btn btn-ghost" style="margin-top:14px" onclick="resetReport()">ğŸ”„ ìƒˆ ë¦¬í¬íŠ¸ ì‹œì‘</button>
      </div>

    </div>
  </section>
</main>

<!-- ===================== AUTH MODAL ===================== -->
<div id="authWrap" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="authTitle">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="authTitle" style="margin:0;font-weight:900">ë‚´ ê³„ì •</h3>
      <button class="btn btn-ghost" onclick="closeAuth()">ë‹«ê¸°</button>
    </div>

    <div class="tabs" style="margin-top:10px">
      <button id="tabLogin" class="tab active" onclick="switchTab('login')">ë¡œê·¸ì¸</button>
      <button id="tabRegister" class="tab" onclick="switchTab('register')">íšŒì›ê°€ì…</button>
    </div>

    <div id="loginPanel">
      <label class="form-label">ì´ë©”ì¼</label>
      <input id="loginEmail" class="input" placeholder="you@example.com" />
      <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
      <input id="loginPassword" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
      <button class="btn btn-primary" style="margin-top:12px" onclick="login()">ë¡œê·¸ì¸</button>
      <div id="loginError" class="muted" style="color:#dc2626;margin-top:8px;display:none"></div>
    </div>

    <div id="registerPanel" class="hidden">
      <label class="form-label">ì´ë¦„</label>
      <input id="regName" class="input" placeholder="í™ê¸¸ë™" />
      <label class="form-label">ì´ë©”ì¼</label>
      <input id="regEmail" class="input" placeholder="you@example.com" />
      <label class="form-label">ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
      <input id="regPassword" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
      <button class="btn btn-primary" style="margin-top:12px" onclick="register()">íšŒì›ê°€ì…</button>
      <div id="registerError" class="muted" style="color:#dc2626;margin-top:8px;display:none"></div>
    </div>
  </div>
</div>

<script>
/* ===== Router ===== */
function show(section){
  const home = document.getElementById('homeSection');
  const editor = document.getElementById('editorSection');
  home.classList.toggle('hidden', section!=='home');
  editor.classList.toggle('hidden', section!=='editor');

  if(section==='editor'){
    requestAnimationFrame(refreshAutosize);
    if (document.fonts && document.fonts.ready) document.fonts.ready.then(refreshAutosize);
    editor.style.visibility = 'visible';
    // ì…ë ¥ ëª¨ë‹ˆí„°ë„ ì—…ë°ì´íŠ¸ (ì…ë ¥ íŒ¨ë„ ë¯¸ëŸ¬ë§)
    mirrorInputToMonitor();
  }
  window.scrollTo({ top:0, behavior:'instant' });
}
function go(section){ location.hash = (section==='editor' ? '#editor' : '#home'); show(section); }
function routeFromHash(){ const h=(location.hash||'').toLowerCase(); if(h==='#editor') show('editor'); else show('home'); }
window.addEventListener('hashchange', routeFromHash);
window.addEventListener('DOMContentLoaded', routeFromHash);
function goToEditor(){ location.hash='#editor'; show('editor'); setTimeout(()=>{document.getElementById('studentName')?.focus({preventScroll:true});},0); }

/* ===== Textarea Autoresize & Counters ===== */
function autoResize(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,1200)+'px'; }
function refreshAutosize(){ document.querySelectorAll('textarea').forEach(t=>{ autoResize(t); }); }
function bindAutoResize(){ document.querySelectorAll('textarea').forEach(t=>{ t.addEventListener('input',()=>autoResize(t)); autoResize(t); }); }
window.addEventListener('DOMContentLoaded', bindAutoResize);

function addPassage(){ const t=document.createElement('textarea'); t.className='passage textarea'; t.rows=3; t.placeholder='ì œì‹œë¬¸ì„ ê·¸ëŒ€ë¡œ ì ì–´ ì£¼ì„¸ìš”.'; document.getElementById('passages').appendChild(t); t.addEventListener('input',()=>autoResize(t)); autoResize(t); mirrorInputToMonitor(); }
function updateCharCount(){ const essay=document.getElementById('essay').value; const l=parseInt(document.getElementById('charLimit').value); const r=parseInt(document.getElementById('charRange').value)||0; const enabled=!Number.isNaN(l); const min=enabled?Math.max(0,l-r):0; const max=enabled?l+r:Infinity; const inRange=!enabled?true:(essay.length>=min && essay.length<=max); const el=document.getElementById('charCount'); el.textContent = enabled ? `í˜„ì¬ ê¸€ì ìˆ˜: ${essay.length} Â· ê¸°ì¤€ ${min}~${max}` : `í˜„ì¬ ê¸€ì ìˆ˜: ${essay.length}`; el.style.color = inRange ? '#6B7280' : '#ef4444'; }

/* ===== Showcase: Two Monitors ===== */
function scaleStageToScreen(stage, screenEl){
  const screenW = screenEl.clientWidth;
  const screenH = screenEl.clientHeight;
  const baseW = 980; // stage width
  const stageHeight = stage.scrollHeight;
  const scaleX = screenW / baseW;
  const scaleY = screenH / stageHeight;
  const scale = Math.min(scaleX, scaleY, 1.0);
  stage.style.transform = `scale(${scale})`;
}

function renderPlaceholders(){
  // ì…ë ¥ ëª¨ë‹ˆí„° placeholder
  const inStage = document.getElementById('monitorInputStage');
  inStage.innerHTML = `
    <div class="placeholder">
      <span class="chip">í•™ìƒ ì´ë¦„</span> <span class="chip">ì§ˆë¬¸</span> <span class="chip">ì œì‹œë¬¸</span>
      <div class="line" style="width:70%"></div>
      <div class="line" style="width:84%"></div>
      <div class="line" style="width:65%"></div>
      <div class="line" style="width:90%"></div>
      <div class="line" style="width:55%"></div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <div class="chip">âš¡ ë¦¬í¬íŠ¸ ìƒì„±</div>
        <div class="chip">ğŸ“ ì˜ˆì‹œë‹µì•ˆ</div>
      </div>
    </div>`;
  // ê²°ê³¼ ëª¨ë‹ˆí„° placeholder
  const outStage = document.getElementById('monitorResultStage');
  outStage.innerHTML = `
    <div class="placeholder">
      <h4>ğŸ“Š í‰ê°€ ìš”ì•½</h4>
      <div class="line" style="width:50%"></div>
      <div class="line" style="width:40%"></div>
      <div class="line" style="width:60%"></div>
      <div class="line" style="width:55%"></div>
      <h4 style="margin-top:16px">ğŸ“ ì˜ˆì‹œë‹µì•ˆ</h4>
      <div class="line" style="width:90%"></div>
      <div class="line" style="width:80%"></div>
      <div class="line" style="width:70%"></div>
    </div>`;
  requestAnimationFrame(()=>{
    scaleStageToScreen(inStage, inStage.closest('.screen'));
    scaleStageToScreen(outStage, outStage.closest('.screen'));
  });
}
window.addEventListener('DOMContentLoaded', renderPlaceholders);
window.addEventListener('resize', ()=>renderPlaceholders());

function mirrorInputToMonitor(){
  const src = document.getElementById('inputPanel');
  const stage = document.getElementById('monitorInputStage');
  if(!src || !stage) return;
  stage.innerHTML = '';
  const clone = src.cloneNode(true);
  // í¼ ì…ë ¥ì€ disable/readOnlyë¡œ ë³´ì´ë„ë¡
  clone.querySelectorAll('input,textarea,button').forEach(el=>{
    if(el.tagName==='BUTTON'){ el.disabled = true; }
    else { el.setAttribute('readonly','readonly'); el.disabled = true; }
  });
  stage.appendChild(clone);
  requestAnimationFrame(()=>scaleStageToScreen(stage, stage.closest('.screen')));
}

function mirrorResultToMonitor(){
  const res = document.getElementById('resultCard');
  const ex = document.getElementById('exampleSection');
  const stage = document.getElementById('monitorResultStage');
  if(!stage) return;

  stage.innerHTML = '';
  if(res && !res.classList.contains('hidden')){
    const resClone = res.cloneNode(true);
    resClone.querySelectorAll('button').forEach(b=>b.disabled=true);
    stage.appendChild(resClone);
  }
  if(ex && !ex.classList.contains('hidden')){
    const exClone = ex.cloneNode(true);
    exClone.querySelectorAll('button').forEach(b=>b.disabled=true);
    stage.appendChild(exClone);
  }
  requestAnimationFrame(()=>scaleStageToScreen(stage, stage.closest('.screen')));
}

/* ===== Helpers ===== */
let scoreChart, savedScores=[], savedReasons={}, savedExample="", savedComparison="";
let exampleGenerated=false;
function getLimitInfo(){
  const essayLen=(document.getElementById('essay')?.value||'').length;
  const l=parseInt(document.getElementById('charLimit')?.value);
  const r=parseInt(document.getElementById('charRange')?.value)||0;
  const enabled=!Number.isNaN(l);
  const min=enabled?Math.max(0,l-r):0;
  const max=enabled?l+r:Infinity;
  const inRange=!enabled?true:(essayLen>=min && essayLen<=max);
  return {enabled,inRange,len:essayLen,min,max,target:l||null};
}
function getTotalAndStatus(scores){
  const total=(scores||[]).reduce((a,b)=>a+(parseInt(b)||0),0);
  let status={label:"ì˜ˆë¹„",desc:"ì¡°ê¸ˆë§Œ ë‹¤ë“¬ìœ¼ë©´ ë” ì¢‹ì•„ì ¸ìš”.",emoji:"ğŸ™‚",tone:"#f59e0b"};
  if(total<30) status={label:"ë‹¤ì‹œ ì“°ê¸°",desc:"ë‹¤ìŒ ì‹œë„ì—ì„œ ë” ë‹¨ë‹¨í•´ì§ˆ ê±°ì˜ˆìš”.",emoji:"ğŸ˜…",tone:"#ef4444"};
  else if(total>=36) status={label:"í•©ê²©",desc:"ì§€ê¸ˆë„ ì¶©ë¶„íˆ ì„¤ë“ë ¥ ìˆì–´ìš”!",emoji:"ğŸ¥³",tone:"#10b981"};
  return { total, status };
}

/* ===== Review ===== */
async function submitEssay(){
  document.getElementById('loading').style.display='block';
  document.getElementById('error').style.display='none';
  try{
    const name=document.getElementById('studentName').value;
    const question=document.getElementById('question').value;
    const passages=[...document.querySelectorAll('.passage')].map(p=>p.value);
    const essay=document.getElementById('essay').value;
    const limit=document.getElementById('charLimit').value;
    const range=document.getElementById('charRange').value;

    const r=await fetch('/review',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,question,passages,essay,limit,range})});
    const data=await r.json();
    savedScores=data.scores; savedReasons=data.reasons;

    const { total, status } = getTotalAndStatus(savedScores);
    const progress=`
      <div style="margin-top:8px">
        <div style="position:relative;height:10px;background:#eef2ff;border-radius:999px;overflow:hidden">
          <div style="width:${(total/40)*100}%;height:100%;background:${status.tone};transition:width .5s"></div>
          <div style="position:absolute;left:${(30/40)*100}%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.15)"></div>
          <div style="position:absolute;left:${(36/40)*100}%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.25)"></div>
        </div>
        <div class="muted" style="display:flex;justify-content:space-between;font-size:12px;margin-top:6px">
          <span>0</span><span>30(ì˜ˆë¹„)</span><span>36(í•©ê²©)</span><span>40</span>
        </div>
      </div>`;

    document.getElementById('evalSummary').innerHTML=`
      <div class="card" style="display:flex;align-items:center;gap:14px">
        <div style="font-size:30px">${status.emoji}</div>
        <div style="flex:1">
          <div style="font-weight:900">ì´ì  <span style="color:${status.tone}">${total}</span> / 40 Â·
            <span style="color:${status.tone}">${status.label}</span></div>
          <div class="muted" style="margin-top:4px">${status.desc}</div>
          ${progress}
        </div>
        <div style="position:relative; width:110px; height:110px">
          <svg width="110" height="110">
            <circle r="52" cx="55" cy="55" fill="transparent" stroke="#eef2ff" stroke-width="10"></circle>
            <circle r="52" cx="55" cy="55" fill="transparent" stroke="${status.tone}" stroke-width="10"
              stroke-dasharray="327" stroke-dashoffset="${327-(327*(total/40))}"></circle>
          </svg>
          <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:900">${total}</div>
        </div>
      </div>

      <div class="kpi" style="margin-top:14px">
        ${['ë…¼ë¦¬ë ¥','ë…í•´ë ¥','êµ¬ì„±ë ¥','í‘œí˜„ë ¥'].map((k,i)=>`
          <div class="card">
            <div style="font-weight:800">${k} (${savedScores[i]}ì )</div>
            <div class="muted" style="margin-top:6px">${savedReasons[k]}</div>
          </div>
        `).join('')}
      </div>

      <div style="margin-top:18px"><canvas id="scoreChart" height="140"></canvas></div>
    `;

    const ctx=document.getElementById('scoreChart').getContext('2d');
    if(scoreChart) scoreChart.destroy();
    scoreChart=new Chart(ctx,{
      type:'bar',
      data:{ labels:['ë…¼ë¦¬ë ¥','ë…í•´ë ¥','êµ¬ì„±ë ¥','í‘œí˜„ë ¥'],
        datasets:[{ data:savedScores, backgroundColor:"rgba(33,64,177,.75)", borderRadius:8, barThickness:28, categoryPercentage:0.65 }]},
      options:{ animation:{duration:600,easing:'easeOutQuart'},
        scales:{ x:{grid:{display:false},ticks:{color:'#6B7280',font:{size:12}}},
                 y:{beginAtZero:true,max:10,ticks:{stepSize:1,color:'#9CA3AF',font:{size:11}},grid:{color:'rgba(17,24,39,.06)'}}},
        plugins:{legend:{display:false},tooltip:{enabled:true}}}
    });

    document.getElementById('loading').style.display='none';
    document.getElementById('resultCard').classList.remove('hidden');
    document.getElementById('exampleSection').classList.remove('hidden');
    document.getElementById('exampleNote').style.display='none';
    document.getElementById('exampleOutput').innerHTML='';
    document.getElementById('comparisonOutput').innerHTML='';
    document.getElementById('btnExample').disabled=false;
    document.getElementById('btnExample').textContent='ì˜ˆì‹œë‹µì•ˆ ë³´ê¸°';
    exampleGenerated=false;

    // ğŸ”´ ê²°ê³¼ ëª¨ë‹ˆí„° LIVE ë°˜ì˜
    mirrorResultToMonitor();

  }catch(e){
    console.error(e);
    document.getElementById('loading').style.display='none';
    document.getElementById('error').style.display='block';
  }
}

/* ===== Example (on demand) ===== */
async function loadExample(){
  const btn=document.getElementById('btnExample');
  const note=document.getElementById('exampleNote');
  btn.disabled=true; const old=btn.textContent; btn.textContent='ìƒì„± ì¤‘...';

  try{
    const name=document.getElementById('studentName').value;
    const question=document.getElementById('question').value;
    const passages=[...document.querySelectorAll('.passage')].map(p=>p.value);
    const essay=document.getElementById('essay').value;
    const limit=document.getElementById('charLimit').value;
    const range=document.getElementById('charRange').value;

    const payload={name,question,passages,essay,limit,range};
    const info=getLimitInfo();
    if(info.enabled){
      payload.target_length = info.target;
      payload.min_length = info.min;
      payload.max_length = info.max;
      payload.length_strategy = (info.len<info.min)?'expand':(info.len>info.max)?'compress':'keep';
      payload.enforce_length = true;
    }

    const r=await fetch('/example',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const data=await r.json();

    savedExample=data.example||'';
    savedComparison=data.comparison||'';
    exampleGenerated=true;

    if(!data.length_valid){
      note.style.display='block';
      note.textContent='âœï¸ ê¸€ì ìˆ˜ëŠ” ê¸°ì¤€ê³¼ ì¡°ê¸ˆ ë‹¤ë¥¼ ìˆ˜ ìˆì§€ë§Œ, ìµœëŒ€í•œ ë§ì¶˜ ì˜ˆì‹œì˜ˆìš”. í•„ìš”í•˜ë©´ ê°€ë³ê²Œ ì†ë´ë„ ì¢‹ì•„ìš”.';
    }else{
      note.style.display='none';
    }
    if(!savedExample.trim() && !savedComparison.trim()){
      note.style.display='block';
      note.textContent='ì´ë²ˆì—ëŠ” ìë™ ìƒì„±ì´ ì–´ë ¤ì› ì–´ìš”. ê¸€ì ìˆ˜ ë²”ìœ„ë¥¼ ì¡°ê¸ˆ ì¡°ì •í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•´ ë³´ì„¸ìš”.';
    }

    document.getElementById('exampleOutput').innerHTML=savedExample.replace(/\n/g,'<br>');
    document.getElementById('comparisonOutput').innerHTML=savedComparison.replace(/\n/g,'<br>');
    btn.textContent='ì˜ˆì‹œë‹µì•ˆ ìƒì„±ë¨';

    // ğŸ”´ ì˜ˆì‹œ ìƒì„± í›„ ê²°ê³¼ ëª¨ë‹ˆí„° ê°±ì‹ 
    mirrorResultToMonitor();

  }catch(e){
    console.error(e);
    document.getElementById('exampleNote').style.display='block';
    document.getElementById('exampleNote').textContent='ìƒì„± ì¤‘ ë¬¸ì œê°€ ìˆì—ˆì–´ìš”. ì ì‹œ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
    btn.textContent=old; btn.disabled=false;
  }
}

/* ===== PDF ===== */
function downloadPDF(){
  const name=document.getElementById('studentName').value || 'ì´ë¦„ ë¯¸ì…ë ¥';
  const today=new Date().toISOString().split('T')[0];
  const { total, status } = getTotalAndStatus(savedScores);
  let chartImg=''; try{ const canvas=document.getElementById('scoreChart'); if(canvas) chartImg=canvas.toDataURL('image/png',1.0); }catch(e){}
  const noteHtml = (document.getElementById('exampleNote').style.display==='block')
    ? `<div style="margin:8px 0;color:#6b7280;font-size:12px">âœï¸ ê¸€ì ìˆ˜ëŠ” ê¸°ì¤€ê³¼ ì¡°ê¸ˆ ë‹¤ë¥¼ ìˆ˜ ìˆì§€ë§Œ, ìµœëŒ€í•œ ë§ì¶˜ ì˜ˆì‹œì˜ˆìš”. í•„ìš”í•˜ë©´ ê°€ë³ê²Œ ì†ë´ë„ ì¢‹ì•„ìš”.</div>`
    : ``;

  const html=`
  <div style="font-family:'SUIT',system-ui,-apple-system,sans-serif; color:#111827;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="display:flex;align-items:center;gap:8px">
        <img src="/static/academy_logo.png" alt="ì•„ì¹´ë°ë¯¸ì°½" style="height:22px;object-fit:contain"/>
        <h2 style="margin:0">ë‹¤ì“° ë¦¬í¬íŠ¸</h2>
      </div>
      <div style="color:#6b7280;font-size:12px">í•™ìƒ: ${name} Â· ë‚ ì§œ: ${today}</div>
    </div>

    <div style="display:flex;gap:12px;align-items:center;border:1px solid #e5e7eb;border-radius:12px;padding:12px;">
      <div style="font-size:26px">${status.emoji}</div>
      <div style="flex:1">
        <div style="font-weight:900">ì´ì  <span style="color:${status.tone}">${total}</span> / 40 Â·
          <span style="color:${status.tone}">${status.label}</span></div>
        <div style="color:#6b7280;font-size:13px;margin-top:4px">${status.desc}</div>
        <div style="margin-top:8px;position:relative;height:8px;background:#eef2ff;border-radius:999px;overflow:hidden">
          <div style="width:${(total/40)*100}%;height:100%;background:${status.tone}"></div>
          <div style="position:absolute;left:${(30/40)*100}%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.18)"></div>
          <div style="position:absolute;left:${(36/40)*100}%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.28)"></div>
        </div>
        <div style="display:flex;justify-content:space-between;color:#9ca3af;font-size:11px;margin-top:4px">
          <span>0</span><span>30(ì˜ˆë¹„)</span><span>36(í•©ê²©)</span><span>40</span>
        </div>
      </div>
      <div style="position:relative;width:110px;height:110px">
        <svg width="110" height="110">
          <circle r="52" cx="55" cy="55" fill="transparent" stroke="#eef2ff" stroke-width="10"></circle>
          <circle r="52" cx="55" cy="55" fill="transparent" stroke="${status.tone}" stroke-width="10"
            stroke-dasharray="327" stroke-dashoffset="${327-(327*(total/40))}"></circle>
        </svg>
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:900">${total}</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
      ${['ë…¼ë¦¬ë ¥','ë…í•´ë ¥','êµ¬ì„±ë ¥','í‘œí˜„ë ¥'].map((k,i)=>`
        <div style="border:1px solid #e5e7eb;border-radius:12px;padding:12px">
          <div style="font-weight:800">${k} (${savedScores[i]}ì )</div>
          <div style="color:#6b7280;font-size:13px;margin-top:6px">${savedReasons[k]}</div>
        </div>
      `).join('')}
    </div>

    ${chartImg ? `<div style="margin-top:12px;border:1px solid #e5e7eb;border-radius:12px;padding:12px"><img src="${chartImg}" style="width:100%;height:auto;display:block;"/></div>` : ''}

    <h3 style="margin:16px 0 6px">ì˜ˆì‹œë‹µì•ˆ</h3>
    ${noteHtml}
    <div style="border:1px solid #e5e7eb;border-radius:12px;padding:12px;font-size:13px;color:#374151">${(savedExample||'').replace(/\n/g,'<br>')}</div>

    <h3 style="margin:16px 0 6px">ë¹„êµ ë¶„ì„</h3>
    <div style="border:1px solid #e5e7eb;border-radius:12px;padding:12px;font-size:13px;color:#374151">${(savedComparison||'').replace(/\n/g,'<br>')}</div>
  </div>`;
  const wrap=document.createElement('div'); wrap.innerHTML=html;
  html2pdf().from(wrap).set({ margin:10, filename:`ë‹¤ì“°_ë¦¬í¬íŠ¸_${today}.pdf`, html2canvas:{ scale:2, useCORS:true }, jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' } }).save();
}
function resetReport(){ location.hash='#home'; routeFromHash(); }

/* ===== Auth Modal / API ===== */
let currentUser=null;
async function fetchMe(){ try{ const r=await fetch('/auth/me'); const data=await r.json(); if(data.ok && data.user){ currentUser=data.user; paintHeader(); } }catch(e){} }
function paintHeader(){
  const loginBtn=document.getElementById('loginBtn');
  const prof=document.getElementById('profileArea');
  if(currentUser){
    loginBtn.classList.add('hidden');
    prof.classList.remove('hidden');
    const initial=(currentUser.name||currentUser.email||'A').trim()[0].toUpperCase();
    document.getElementById('avatarInitial').textContent=initial;
    document.getElementById('profileName').textContent=currentUser.name||currentUser.email;
  }else{
    prof.classList.add('hidden');
    loginBtn.classList.remove('hidden');
  }
}
function openAuth(){ document.getElementById('authWrap').classList.remove('hidden'); switchTab('login'); }
function closeAuth(){ document.getElementById('authWrap').classList.add('hidden'); document.getElementById('loginError').style.display='none'; document.getElementById('registerError').style.display='none'; }
function switchTab(which){
  const l=document.getElementById('loginPanel'), r=document.getElementById('registerPanel');
  const tl=document.getElementById('tabLogin'), tr=document.getElementById('tabRegister');
  if(which==='login'){ l.classList.remove('hidden'); r.classList.add('hidden'); tl.classList.add('active'); tr.classList.remove('active'); }
  else{ r.classList.remove('hidden'); l.classList.add('hidden'); tr.classList.add('active'); tl.classList.remove('active'); }
}
async function register(){
  const body={ name:document.getElementById('regName').value, email:document.getElementById('regEmail').value, password:document.getElementById('regPassword').value };
  const r=await fetch('/auth/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const data=await r.json();
  if(!data.ok){ const el=document.getElementById('registerError'); el.style.display='block'; el.textContent=data.error||'ê°€ì…ì— ì‹¤íŒ¨í–ˆì–´ìš”.'; return; }
  currentUser=data.user; paintHeader(); closeAuth();
}
async function login(){
  const body={ email:document.getElementById('loginEmail').value, password:document.getElementById('loginPassword').value };
  const r=await fetch('/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const data=await r.json();
  if(!data.ok){ const el=document.getElementById('loginError'); el.style.display='block'; el.textContent=data.error||'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆì–´ìš”.'; return; }
  currentUser=data.user; paintHeader(); closeAuth();
}
async function logout(){ await fetch('/auth/logout',{method:'POST'}); currentUser=null; paintHeader(); }
window.addEventListener('DOMContentLoaded', fetchMe);

/* Profile dropdown */
document.addEventListener('click', (e)=>{
  const btn=document.getElementById('profileBtn');
  const menu=document.getElementById('profileMenu');
  if(btn && btn.contains(e.target)){ menu.style.display = (menu.style.display==='block'?'none':'block'); }
  else if(menu && !menu.contains(e.target)){ menu.style.display='none'; }
});
</script>
</body>
</html>
