<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì•„ì¹´ë°ë¯¸ì°½ Â· ë‹¤ì“° ë¦¬í¬íŠ¸</title>

<!-- í°íŠ¸/ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
:root{
  --brand:#2140B1; --brand-700:#1a2f91;
  --ink:#111827; --muted:#6B7280; --line:rgba(17,24,39,.10);
  --bg:#f7f9ff; --white:#fff;
}
*{ box-sizing:border-box; font-family:'SUIT',system-ui,sans-serif; letter-spacing:-.2px }
html,body{ margin:0; color:var(--ink); background:var(--bg) }
a{ color:inherit; text-decoration:none }
.hidden{ display:none !important }
.muted{ color:var(--muted) }
.container{ max-width:1180px; margin:0 auto; padding:0 24px }

/* í—¤ë” */
header{
  position:sticky; top:0; z-index:20; background:rgba(255,255,255,.75);
  backdrop-filter:blur(10px); border-bottom:1px solid var(--line);
}
.nav{ height:66px; display:flex; align-items:center; justify-content:space-between }
.nav-left{ display:flex; align-items:center; gap:10px; font-weight:900 }
.nav-right{ display:flex; gap:12px; align-items:center }
.btn{ border:none; height:44px; padding:0 18px; border-radius:14px; font-weight:800; cursor:pointer; transition:.2s }
.btn-primary{ background:var(--brand); color:#fff; box-shadow:0 8px 20px rgba(33,64,177,.18) }
.btn-primary:hover{ transform:translateY(-1px); box-shadow:0 12px 28px rgba(33,64,177,.22) }
.btn-ghost{ background:#fff; border:1px solid #e5e7eb }
.avatar{ width:32px; height:32px; border-radius:50%; background:#EEF2FF; color:#2140B1; display:flex; align-items:center; justify-content:center; font-weight:900 }
.dropdown{ position:relative }
.dropdown-menu{ position:absolute; right:0; top:44px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 12px 30px rgba(17,24,39,.12); padding:8px; min-width:160px; display:none }
.dropdown-menu a, .dropdown-menu button{ display:block; width:100%; text-align:left; background:transparent; border:none; padding:8px 10px; border-radius:8px; font-weight:700; color:#374151; cursor:pointer }
.dropdown-menu a:hover, .dropdown-menu button:hover{ background:#f3f4f6 }

/* HERO */
.hero{
  padding:88px 0 40px;
  background:
    radial-gradient(1200px 600px at 80% -30%, rgba(33,64,177,.22), transparent),
    radial-gradient(900px 500px at -10% 20%, rgba(33,64,177,.12), transparent),
    linear-gradient(180deg, #ffffff 0%, #f7f9ff 60%);
  border-bottom:1px solid var(--line);
}
.hero h1{ margin:0 0 12px; font-size:clamp(36px,6vw,64px); line-height:1.08; font-weight:900 }
.hero p{ margin:0 0 24px; font-size:18px; color:#4b5563 }

/* ============== 3-STEP ë°ëª¨ ============== */
.container.wide{ max-width:1440px; }                      /* 480(ì¹´í”¼)+1120(ëª¨ë‹ˆí„°)+ì—¬ë°± */
.step{ padding:70px 0; }
.step-grid{ display:grid; gap:24px; align-items:center }
.step-grid.fixed{ grid-template-columns:400px 960px; } /* ëª¨ë‹ˆí„° 1120px ê³ ì • */
@media(max-width:1440px){ .step-grid.fixed{ grid-template-columns:1fr; } }
.step h2{ margin:0 0 8px; font-size:32px; font-weight:900 }
.step p{ margin:0; color:#6b7280 }
.step .cta-row{ display:flex; gap:10px; margin-top:12px }
.monitor{
  border-radius:22px; padding:16px; background:rgba(255,255,255,.8);
  border:1px solid rgba(229,231,235,.8); box-shadow:0 30px 60px rgba(33,64,177,.14), inset 0 0 0 1px #eef2ff;
}
.monitor .bar{ height:22px; display:flex; align-items:center; gap:8px; padding:0 10px; }
.dot{ width:10px; height:10px; border-radius:50% }
.dot.red{ background:#ff5f57 } .dot.yellow{ background:#ffbd2e } .dot.green{ background:#28c840 }
.screen{ border-radius:16px; background:#fff; border:1px solid #eef2ff; overflow:hidden; }
.viewport{ position:relative; overflow:hidden }
.stage{ width:1120px; margin:0 auto; padding:18px; transform-origin: top center; }

/* ì…ë ¥/ê²°ê³¼ ë°ëª¨ ìŠ¤íƒ€ì¼ */
.panel{ background:rgba(255,255,255,.6); backdrop-filter:blur(14px); border:1px solid rgba(255,255,255,.5);
  border-radius:22px; padding:22px; box-shadow:0 10px 30px rgba(17,24,39,.1) }
.form-label{ font-weight:900; margin:12px 0 6px; display:block }
.input,.textarea{ width:100%; padding:14px 16px; border:1px solid #e5e7eb; border-radius:12px; font-size:16px; line-height:1.6; resize:none }
.input:focus,.textarea:focus{ outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(33,64,177,.18) }
.textarea::placeholder,.input::placeholder{ color:#9CA3AF }
#passages{ display:grid; grid-template-columns:1fr 1fr; gap:14px }
@media (max-width:680px){ #passages{ grid-template-columns:1fr } }
.kpi{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
@media (max-width:900px){ .kpi{ grid-template-columns:1fr } }
canvas.demoChart{ height:140px !important; }
.divider{ height:1px; background:var(--line); margin:14px 0 }

/* ëª¨ë‹¬ */
.modal-backdrop{ position:fixed; inset:0; background:rgba(17,24,39,.4); display:flex; align-items:center; justify-content:center; z-index:50 }
.modal{ width:min(560px,90vw); background:#fff; border-radius:18px; border:1px solid #e5e7eb; box-shadow:0 24px 60px rgba(17,24,39,.22); padding:18px }
.modal-backdrop.hidden{ display:none !important; }
.tabs{ display:flex; gap:8px; margin-bottom:12px }
.tab{ flex:1; height:40px; border-radius:999px; border:1px solid #e5e7eb; background:#f8fafc; font-weight:800; cursor:pointer }
.tab.active{ background:#EEF2FF; border-color:#dbe4ff; color:var(--brand-700) }
.row{ display:flex; gap:10px }
</style>
</head>

<body>
<header>
  <div class="container nav">
    <div class="nav-left" style="gap:10px">
      <img src="/static/academy_logo.png" alt="ì•„ì¹´ë°ë¯¸ì°½" style="height:20px;object-fit:contain">
      <span style="font-weight:900">ì•„ì¹´ë°ë¯¸ì°½</span>
    </div>
    <div class="nav-right">
      <div id="profileArea" class="dropdown hidden">
        <div id="profileBtn" class="btn btn-ghost" style="display:flex;align-items:center;gap:8px">
          <div class="avatar" id="avatarInitial">A</div>
          <span id="profileName" class="muted" style="font-weight:800"></span>
        </div>
        <div class="dropdown-menu" id="profileMenu">
          <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
      <button id="loginBtn" class="btn btn-ghost" onclick="openAuth()">ë¡œê·¸ì¸</button>
      <button class="btn btn-primary" onclick="goToEditor()">AI ì²¨ì‚­í•˜ê¸°</button>
    </div>
  </div>
</header>

<main>
  <!-- HERO -->
  <section id="homeSection" class="hero">
    <div class="container">
      <h1>ê¸€ í‰ê°€ì™€ ì˜ˆì‹œ ì‘ì„±,<br/>ë°”ë¡œ ì²´í—˜í•´ ë³´ì„¸ìš”</h1>
      <p>ì…ë ¥ â†’ í‰ê°€ â†’ ì˜ˆì‹œë‹µì•ˆ Â· ì°¨ì´ì ê¹Œì§€, ì‹¤ì œ í™”ë©´ í¬ê¸°ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>
      <div style="display:flex; gap:12px; flex-wrap:wrap">
        <button class="btn btn-primary" style="height:52px" onclick="document.getElementById('step1').scrollIntoView({behavior:'smooth'});">ì²´í—˜ ì‹œì‘</button>
      </div>
    </div>
  </section>

  <!-- STEP 1 -->
  <section id="step1" class="step">
    <div class="container wide step-grid fixed">
      <div>
        <h2>1. ì…ë ¥í•˜ê¸°</h2>
        <p>í•™ìƒÂ·ì§ˆë¬¸Â·ì œì‹œë¬¸(ì—¬ëŸ¬ ê°œ)Â·ë…¼ìˆ ë¬¸ì„ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸°ë§Œ í•˜ì„¸ìš”. ê¸€ì ìˆ˜ëŠ” ìë™ìœ¼ë¡œ ì„¸ê³ , ì œì‹œë¬¸ì€ ë²„íŠ¼ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì¶”ê°€ë¼ìš”.</p>
        <div class="cta-row"><button class="btn btn-primary" onclick="document.getElementById('step2').scrollIntoView({behavior:'smooth'});">ë‹¤ìŒ ë‹¨ê³„</button></div>
      </div>
      <div class="monitor">
        <div class="bar"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
        <div class="screen">
          <div class="viewport" data-demo="input" data-stage="960">
            <div class="stage input-demo">
              <h3 style="margin:0 0 6px;font-weight:900">âœ¨ ë„ˆì˜ ê¸€, ì˜¤ëŠ˜ ë” ë©€ë¦¬ ë‚ ì•„ê°€ê²Œ.</h3>
              <p class="muted" style="margin-top:0">ì •ì„±ê» ì“´ ë¬¸ì¥ ìœ„ì— í•„ìš”í•œ í”¼ë“œë°±ë§Œ ì–¹ì–´, ëª©í‘œì— ë‹¿ë„ë¡ ë¶€ë“œëŸ½ê²Œ ì´ëŒì–´ ë“œë¦´ê²Œìš”.</p>

              <label class="form-label">í•™ìƒ ì´ë¦„</label>
              <div class="panel" style="padding:12px">í™ê¸¸ë™</div>

              <label class="form-label">ì§ˆë¬¸</label>
              <div class="panel" style="padding:12px" data-demo-question>ì œì‹œë¬¸ì„ ë°”íƒ•ìœ¼ë¡œ 'ê³µì •'ì˜ ì˜ë¯¸ë¥¼ ì •ì˜í•˜ê³ , ì‚¬íšŒì  ì•½ì ë³´í˜¸ì˜ ê´€ì ì—ì„œ ê·¸ ì •ë‹¹ì„±ì„ ë…¼í•˜ì‹œì˜¤.</div>

              <label class="form-label">ì œì‹œë¬¸ <span class="muted">(ìµœì†Œ 1ê°œ)</span></label>
              <div id="demoPassages" class="row" style="flex-wrap:wrap">
                <div class="panel" style="padding:12px;flex:1;min-width:300px" data-demo-passage>â€œê³µì •ì€ ëˆ„êµ¬ë‚˜ ê²½ìŸì— ì°¸ì—¬í•  ìˆ˜ ìˆë„ë¡ ë™ë“±í•œ ì¶œë°œì„ ì„ ë³´ì¥í•˜ë ¤ëŠ” ì‚¬íšŒì˜ ì•½ì†ì´ë‹¤.â€</div>
                <div class="panel" style="padding:12px;flex:1;min-width:300px" data-demo-passage>â€œì„±ê³¼ì— ë”°ë¥¸ ì°¨ë“± ë³´ìƒì€ ë™ê¸°ë¥¼ ë†’ì´ì§€ë§Œ, ì¶œë°œì„ ì´ ê¸°ìš¸ì–´ì ¸ ìˆìœ¼ë©´ ë¶ˆí‰ë“±ì„ í™•ëŒ€í•  ìˆ˜ ìˆë‹¤.â€</div>
                <div class="panel" style="padding:12px;flex:1;min-width:300px" data-demo-passage>â€œì•½ìë¥¼ ë³´í˜¸í•˜ëŠ” ì •ì±…ì€ ê²½ìŸì„ ì•½í™”ì‹œí‚¤ëŠ” ì˜ˆì™¸ê°€ ì•„ë‹ˆë¼ ì°¸ì—¬ ëŠ¥ë ¥ì„ íšŒë³µì‹œí‚¤ëŠ” ì¡°ê±´ì´ë‹¤.â€</div>
                <div class="panel" style="padding:12px;flex:1;min-width:300px" data-demo-passage>â€œì œë„ëŠ” ê¸°íšŒì˜ ë¶ˆê· í˜•ì„ ì™„í™”í•˜ê¸° ìœ„í•´ íˆ¬ëª…í•œ ê¸°ì¤€ê³¼ ëª…í™•í•œ ì¢…ë£Œ ì¡°ê±´ì„ ê°–ì¶”ì–´ì•¼ í•œë‹¤.â€</div>
              </div>

              <label class="form-label">ë…¼ìˆ ë¬¸</label>
              <div class="panel" style="padding:12px">
                ë‚˜ëŠ” ê³µì •ì„ ê²°ê³¼ì˜ ê· ë“±ì´ ì•„ë‹ˆë¼ ê¸°íšŒì˜ ê· ë“±ìœ¼ë¡œ ì´í•´í•œë‹¤. ê°™ì€ ê·œì¹™ì´ ì£¼ì–´ì ¸ë„ ì¶œë°œì„ ì´ ê¸°ìš¸ì–´ ìˆìœ¼ë©´ ê²½ìŸì€ ê³µì •í•´ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤. â€¦ (ìƒëµ) â€¦ ì¶œë°œì„ ì˜ ê· í˜•ê³¼ ê²°ê³¼ì˜ ì±…ì„ì´ í•¨ê»˜ ì‘ë™í•  ë•Œ ìš°ë¦¬ëŠ” ë¹„ë¡œì†Œ ê³µì •í•˜ë‹¤ê³  ë§í•  ìˆ˜ ìˆë‹¤.
              </div>

              <label class="form-label">ê¸€ì ìˆ˜ ì œí•œ</label>
              <div class="row">
                <div class="panel" style="padding:12px;flex:1">ê¸°ì¤€ 700</div>
                <div class="panel" style="padding:12px;flex:1">Â± 50</div>
              </div>
              <div style="text-align:center;margin-top:10px"><button class="btn btn-primary">âš¡ ë¦¬í¬íŠ¸ ìƒì„±</button></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- STEP 2 -->
  <section id="step2" class="step">
    <div class="container wide step-grid fixed">
      <div>
        <h2>2. í‰ê°€ ë°›ê¸°</h2>
        <p>ë…¼ë¦¬Â·ë…í•´Â·êµ¬ì„±Â·í‘œí˜„ 4ê°œ í•­ëª© ì ìˆ˜ì™€ ì´ìœ ë¥¼ í•œ í™”ë©´ì—ì„œ í™•ì¸í•˜ì„¸ìš”. í•©ê²©/ì˜ˆë¹„/ë‹¤ì‹œì“°ê¸° ê¸°ì¤€ë„ í•¨ê»˜ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.</p>
        <div class="cta-row"><button class="btn btn-primary" onclick="document.getElementById('step3').scrollIntoView({behavior:'smooth'});">ë‹¤ìŒ ë‹¨ê³„</button></div>
      </div>
      <div class="monitor">
        <div class="bar"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
        <div class="screen">
          <div class="viewport" data-demo="score" data-stage="960">
            <div class="stage">
              <div class="panel" style="margin-bottom:10px">
                <div style="display:flex;align-items:center;gap:14px">
                  <div style="font-size:28px">ğŸ™‚</div>
                  <div style="flex:1">
                    <div style="font-weight:900">ì´ì  <span style="color:#10b981">37</span> / 40 Â· <span style="color:#10b981">í•©ê²©</span></div>
                    <div class="muted" style="margin-top:4px">ê·¼ê±° ë°°ì—´ê³¼ ë¬¸ì¥ì˜ ì—°ê²°ì´ ìì—°ìŠ¤ëŸ½ìŠµë‹ˆë‹¤.</div>
                    <div style="margin-top:8px;position:relative;height:10px;background:#eef2ff;border-radius:999px;overflow:hidden">
                      <div style="width:92.5%;height:100%;background:#10b981"></div>
                      <div style="position:absolute;left:75%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.15)"></div>
                      <div style="position:absolute;left:90%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.25)"></div>
                    </div>
                  </div>
                  <div style="position:relative;width:110px;height:110px">
                    <svg width="110" height="110">
                      <circle r="52" cx="55" cy="55" fill="transparent" stroke="#eef2ff" stroke-width="10"></circle>
                      <circle r="52" cx="55" cy="55" fill="transparent" stroke="#10b981" stroke-width="10"
                        stroke-dasharray="327" stroke-dashoffset="49"></circle>
                    </svg>
                    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:900">37</div>
                  </div>
                </div>
              </div>

              <div class="kpi">
                <div class="panel"><div style="font-weight:800">ë…¼ë¦¬ë ¥ (9)</div><div class="muted" style="margin-top:6px">ì£¼ì¥-ê·¼ê±°-ì˜ˆì‹œê°€ ì§ì„ ì´ë£¨ë©° ë°˜ë¡  ëŒ€ë¹„ê°€ í¬í•¨ë¨.</div></div>
                <div class="panel"><div style="font-weight:800">ë…í•´ë ¥ (9)</div><div class="muted" style="margin-top:6px">ì œì‹œë¬¸ í•µì‹¬ì„ ì •í™•íˆ ìš”ì•½í•˜ê³  ìƒí˜¸ê´€ê³„ë¥¼ ë°˜ì˜.</div></div>
                <div class="panel"><div style="font-weight:800">êµ¬ì„±ë ¥ (9)</div><div class="muted" style="margin-top:6px">ë¬¸ë‹¨ ì „í™˜ì´ ë§¤ë„ëŸ½ê³  ë‹¨ë½ ëª©í‘œê°€ ëª…í™•í•¨.</div></div>
                <div class="panel"><div style="font-weight:800">í‘œí˜„ë ¥ (10)</div><div class="muted" style="margin-top:6px">ì–´íœ˜ ì„ íƒì´ ì ì ˆí•˜ê³  ë¬¸ë²• ì˜¤ë¥˜ê°€ ê±°ì˜ ì—†ìŒ.</div></div>
              </div>

              <div style="margin-top:14px" class="panel">
                <canvas id="demoChart" class="demoChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- STEP 3 -->
  <section id="step3" class="step">
    <div class="container wide step-grid fixed">
      <div>
        <h2>3. ì˜ˆì‹œë‹µì•ˆ Â· ë¹„êµë¶„ì„</h2>
        <p>ì˜ˆì‹œë‹µì•ˆ ë³´ê¸°ë¥¼ ëˆ„ë¥´ë©´ ë‚´ ê¸€ê³¼ ë‹¤ë¥¸ ì ì„ ì¤„ê¸€ë¡œ ì •ë¦¬í•´ ë“œë ¤ìš”. ë§ˆìŒì— ë“¤ë©´ PDF ì €ì¥í•˜ê³ , ë‚´ ê¸°ë¡ì—ì„œ ì–¸ì œë“  ë‹¤ì‹œ ë³¼ ìˆ˜ ìˆì–´ìš”.</p>
        <div class="cta-row">
          <button class="btn btn-primary" onclick="location.hash='#editor'">ë‚´ ê¸€ë¡œ ì‹œì‘í•˜ê¸°</button>
        </div>
      </div>
      <div class="monitor">
        <div class="bar"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
        <div class="screen">
          <div class="viewport" data-demo="example" data-stage="960">
            <div class="stage">
              <div class="panel">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
                  <h3 style="margin:0">ğŸ“ ì˜ˆì‹œë‹µì•ˆ</h3>
                  <button id="demoExampleBtn" class="btn btn-primary" onclick="renderDemoExample()">ì˜ˆì‹œë‹µì•ˆ ë³´ê¸°</button>
                </div>
                <p class="muted" style="margin-top:6px">ê¶Œì¥ ê¸€ììˆ˜ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë„ ì°¸ê³ ìš© ì˜ˆì‹œëŠ” í‘œì‹œë©ë‹ˆë‹¤.</p>
                <div id="demoExampleWrap" class="hidden">
                  <div id="demoExampleText" class="panel" style="background:#fff"></div>
                  <div class="panel" style="background:#fff;margin-top:12px">
                    <h3 style="margin:0">ğŸ” ë¹„êµ ë¶„ì„</h3>
                    <div id="demoComparisonText" style="margin-top:8px;line-height:1.8"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ì‹¤ì œ ì—ë””í„° -->
  <section id="editorSection" class="hidden" style="visibility:hidden; padding:56px 0">
    <div class="container">

      <!-- ì…ë ¥ -->
      <div id="inputPanel" class="panel">
        <h2 style="margin:0 0 12px; font-weight:900">âœ¨ ë„ˆì˜ ê¸€, ì˜¤ëŠ˜ ë” ë©€ë¦¬ ë‚ ì•„ê°€ê²Œ.</h2>
        <p class="muted" style="margin-top:0">ì •ì„±ê» ì“´ ë¬¸ì¥ ìœ„ì— í•„ìš”í•œ í”¼ë“œë°±ë§Œ ì–¹ì–´, ëª©í‘œì— ë‹¿ë„ë¡ ë¶€ë“œëŸ½ê²Œ ì´ëŒì–´ ë“œë¦´ê²Œìš”.</p>

        <label class="form-label">í•™ìƒ ì´ë¦„</label>
        <input id="studentName" class="input" placeholder="ì˜ˆ: í™ê¸¸ë™" />

        <label class="form-label">ì§ˆë¬¸</label>
        <textarea id="question" class="textarea" rows="2" placeholder="ì§ˆë¬¸ì„ ì—¬ê¸°ì— ì‘ì„±í•´ ì£¼ì„¸ìš”."></textarea>

        <label class="form-label">ì œì‹œë¬¸ <span class="muted">(ìµœì†Œ 1ê°œ)</span></label>
        <div id="passages">
          <textarea class="passage textarea" rows="3" placeholder="ì œì‹œë¬¸ì„ ê·¸ëŒ€ë¡œ ì ì–´ ì£¼ì„¸ìš”."></textarea>
        </div>
        <div style="display:flex; justify-content:flex-end; margin-top:8px">
          <button type="button" id="btnAddPassage" class="btn btn-ghost">â• ì œì‹œë¬¸ ë” ì¶”ê°€</button>
        </div>

        <label class="form-label">ë…¼ìˆ ë¬¸ <span class="muted">(í•™ìƒ ì‘ì„± ê¸€)</span></label>
        <textarea id="essay" class="textarea" rows="6" placeholder="ì œì‹œë¬¸ë§Œ ê·¼ê±°ë¡œ, ë°°ê²½ì§€ì‹ ì—†ì´ ì‘ì„±í•´ ì£¼ì„¸ìš”." oninput="updateCharCount()"></textarea>
        <div id="charCount" class="muted" style="margin-top:6px"></div>

        <label class="form-label">ê¸€ì ìˆ˜ ì œí•œ</label>
        <div class="row">
          <input id="charLimit" class="input" placeholder="ì˜ˆ: 700" />
          <input id="charRange" class="input" placeholder="Â± ì˜ˆ: 50" />
        </div>

        <div style="margin-top:18px; text-align:center">
          <button class="btn btn-primary" onclick="submitEssay()">âš¡ ë¦¬í¬íŠ¸ ìƒì„±</button>
        </div>
        <div id="loading" class="muted" style="display:none; margin-top:8px">â³ ì½ê³  ìˆì–´ìš”â€¦</div>
        <div id="error" class="muted" style="display:none; color:#dc2626; margin-top:8px">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</div>
      </div>

      <!-- ê²°ê³¼ (ì˜ˆì‹œ ë²„íŠ¼ë§Œ ë…¸ì¶œ) -->
      <div id="resultCard" class="panel hidden" style="margin-top:18px">
        <h3 style="margin-top:0">ğŸ“Š í•œëˆˆì— ì´í•´ë˜ëŠ” ë¦¬í¬íŠ¸</h3>
        <div id="evalSummary"></div>
      </div>

      <!-- ì˜ˆì‹œ/ë¹„êµ + PDF (ë²„íŠ¼ ëˆ„ë¥´ê¸° ì „ì—ëŠ” ê°ì¶¤) -->
      <div id="exampleSection" class="panel hidden" style="margin-top:18px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <h3 style="margin:0">ğŸ“ ì˜ˆì‹œë‹µì•ˆ</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn btn-ghost" onclick="openRecords()">ë‚´ ê¸°ë¡</button>
          </div>
        </div>
        <div id="exampleNote" class="muted" style="margin-top:8px;display:none"></div>
        <div id="exampleOutput" class="panel" style="background:#fff"></div>
        <div id="comparisonOutput" class="panel" style="background:#fff;margin-top:12px"></div>
        <button id="btnSavePDF" class="btn btn-primary" style="margin-top:14px"
        onclick="downloadPDF_v2()">ğŸ“¥ PDF ì €ì¥</button>
        <button class="btn btn-ghost" style="margin-top:14px" onclick="resetReport()">ğŸ”„ ìƒˆ ë¦¬í¬íŠ¸ ì‹œì‘</button>
      </div>

    </div>
  </section>
</main>

<!-- AUTH MODAL -->
<div id="authWrap" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="authTitle">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="authTitle" style="margin:0;font-weight:900">ë‚´ ê³„ì •</h3>
      <button class="btn btn-ghost" onclick="closeAuth()">ë‹«ê¸°</button>
    </div>
    <div class="tabs" style="margin-top:10px">
      <button id="tabLogin" class="tab active" onclick="switchTab('login')">ë¡œê·¸ì¸</button>
      <button id="tabRegister" class="tab" onclick="switchTab('register')">íšŒì›ê°€ì…</button>
    </div>
    <div id="loginPanel">
      <label class="form-label">ì´ë©”ì¼</label>
      <input id="loginEmail" class="input" placeholder="you@example.com" />
      <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
      <input id="loginPassword" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
      <button class="btn btn-primary" style="margin-top:12px" onclick="login()">ë¡œê·¸ì¸</button>
      <div id="loginError" class="muted" style="color:#dc2626;margin-top:8px;display:none"></div>
    </div>
    <div id="registerPanel" class="hidden">
      <label class="form-label">ì´ë¦„</label>
      <input id="regName" class="input" placeholder="í™ê¸¸ë™" />
      <label class="form-label">ì´ë©”ì¼</label>
      <input id="regEmail" class="input" placeholder="you@example.com" />
      <label class="form-label">ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
      <input id="regPassword" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
      <button class="btn btn-primary" style="margin-top:12px" onclick="register()">íšŒì›ê°€ì…</button>
      <div id="registerError" class="muted" style="color:#dc2626;margin-top:8px;display:none"></div>
    </div>
  </div>
</div>

<!-- RECORDS MODAL -->
<div id="recordsWrap" class="modal-backdrop hidden">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0;font-weight:900">ë‚´ ê¸°ë¡</h3>
      <button class="btn btn-ghost" onclick="closeRecords()">ë‹«ê¸°</button>
    </div>
    <div id="recordsList" class="muted" style="margin-top:8px">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
  </div>
</div>

<script>
/* ===== ë°ëª¨ ë°ì´í„° ===== */
const demoSet = {
  student: "ê¹€ë‹¤ì›€",
  question: "ì œì‹œë¬¸ì„ ë°”íƒ•ìœ¼ë¡œ 'ê³µì •'ì˜ ì˜ë¯¸ë¥¼ ì •ì˜í•˜ê³ , ì‚¬íšŒì  ì•½ì ë³´í˜¸ì˜ ê´€ì ì—ì„œ ê·¸ ì •ë‹¹ì„±ì„ ë…¼í•˜ì‹œì˜¤.",
  passages: [
    "ê³µì •ì€ ëˆ„êµ¬ë‚˜ ê²½ìŸì— ì°¸ì—¬í•  ìˆ˜ ìˆë„ë¡ ë™ë“±í•œ ì¶œë°œì„ ì„ ë³´ì¥í•˜ë ¤ëŠ” ì‚¬íšŒì˜ ì•½ì†ì´ë‹¤.",
    "ì„±ê³¼ì— ë”°ë¥¸ ì°¨ë“± ë³´ìƒì€ ë™ê¸°ë¥¼ ë†’ì´ì§€ë§Œ, ì¶œë°œì„ ì´ ê¸°ìš¸ì–´ì ¸ ìˆìœ¼ë©´ ë¶ˆí‰ë“±ì„ í™•ëŒ€í•  ìˆ˜ ìˆë‹¤.",
    "ì•½ìë¥¼ ë³´í˜¸í•˜ëŠ” ì •ì±…ì€ ê²½ìŸì„ ì•½í™”ì‹œí‚¤ëŠ” ì˜ˆì™¸ê°€ ì•„ë‹ˆë¼ ì°¸ì—¬ ëŠ¥ë ¥ì„ íšŒë³µì‹œí‚¤ëŠ” ì¡°ê±´ì´ë‹¤.",
    "ì œë„ëŠ” ê¸°íšŒì˜ ë¶ˆê· í˜•ì„ ì™„í™”í•˜ê¸° ìœ„í•´ íˆ¬ëª…í•œ ê¸°ì¤€ê³¼ ëª…í™•í•œ ì¢…ë£Œ ì¡°ê±´ì„ ê°–ì¶”ì–´ì•¼ í•œë‹¤."
  ],
  essay:"ë‚˜ëŠ” ê³µì •ì„ ê²°ê³¼ì˜ ê· ë“±ì´ ì•„ë‹ˆë¼ ê¸°íšŒì˜ ê· ë“±ìœ¼ë¡œ ì´í•´í•œë‹¤. ê°™ì€ ê·œì¹™ì´ ì£¼ì–´ì ¸ë„ ì¶œë°œì„ ì´ ê¸°ìš¸ì–´ ìˆìœ¼ë©´ ê²½ìŸì€ ê³µì •í•´ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤. â€¦ (ìƒëµ) â€¦ ì¶œë°œì„ ì˜ ê· í˜•ê³¼ ê²°ê³¼ì˜ ì±…ì„ì´ í•¨ê»˜ ì‘ë™í•  ë•Œ ìš°ë¦¬ëŠ” ë¹„ë¡œì†Œ ê³µì •í•˜ë‹¤ê³  ë§í•  ìˆ˜ ìˆë‹¤.",
  charBase:700, charRange:50,
  scores:[9,9,9,10], total:37, status:"í•©ê²©",
  reasons:{
    "ë…¼ë¦¬ë ¥":"ì£¼ì¥â†’ê·¼ê±°â†’ì¡°ê±´â†’ê²°ë¡ ìœ¼ë¡œ ì „ê°œê°€ ì¼ê´€ë¨.",
    "ë…í•´ë ¥":"ì¶œë°œì„ Â·ì°¨ë“±Â·ì•½ìë³´í˜¸Â·ì œë„ì„¤ê³„ì˜ í•µì‹¬ì„ ê°ê° ë…¼ì§€ì— ì—°ê²°.",
    "êµ¬ì„±ë ¥":"ë„ì…-ë³¸ë¬¸-ê²°ë¡ ì˜ ì•„ì¹˜í˜• êµ¬ì¡°, ë‹¨ë½ ëª©í‘œê°€ ë¶„ëª….",
    "í‘œí˜„ë ¥":"í•µì‹¬ì–´ ë°˜ë³µìœ¼ë¡œ ì‘ì§‘ë ¥ ê°•í™”, ë¬¸ë²• ì˜¤ë¥˜ ì—†ìŒ."
  },
  example:"ê³µì •ì€ ê²°ê³¼ì˜ ë™ì¼ì„ ê°•ì œí•˜ëŠ” ê·œë²”ì´ ì•„ë‹ˆë¼, ëˆ„êµ¬ë‚˜ ê²½ìŸì— ì°¸ì—¬í•  ìˆ˜ ìˆë„ë¡ ì¶œë°œì„ ì„ ê· ë“±í™”í•˜ëŠ” ì›ì¹™ì´ë‹¤. ì´ë•Œ ì•½ì ë³´í˜¸ëŠ” ì˜ˆì™¸ê°€ ì•„ë‹ˆë¼ ê³µì •ì˜ ì¡°ê±´ì´ë‹¤. êµìœ¡Â·ì •ë³´Â·ê±´ê°•ê³¼ ê°™ì€ ê¸°ë³¸ ì—­ëŸ‰ì„ ë³´ì¥í•´ ì°¸ì—¬ ëŠ¥ë ¥ì„ ëŒì–´ì˜¬ë¦¬ê³ , ì´í›„ì˜ ì„±ê³¼ëŠ” ì˜ˆì¸¡ ê°€ëŠ¥í•œ ê¸°ì¤€ì— ë”°ë¼ ì°¨ë“± ë³´ìƒë˜ì–´ì•¼ í•œë‹¤.\n\nì§€ì›ì€ ëª©ì Â·ëŒ€ìƒÂ·ê¸°ê°„Â·ì¢…ë£Œ ì¡°ê±´ì´ ëª…í™•í•´ì•¼ í•œë‹¤. ë³´ì •ì´ ì„±ê³¼ ë³´ìƒê³¼ ë’¤ì„ì´ë©´ íŠ¹í˜œë¡œ ì˜¤í•´ë˜ê¸° ë•Œë¬¸ì´ë‹¤. ë°˜ëŒ€ë¡œ ì„±ê³¼ê°€ í™•ì¸ë˜ë©´ ë” í° ììœ¨ê³¼ ì±…ì„ì„ ë¶€ì—¬í•´ì•¼ ì œë„ëŠ” ì‹ ë¢°ë¥¼ ì–»ëŠ”ë‹¤. ê²°êµ­ ê³µì •ì€ â€˜ê¸°íšŒ ë³´ì •â€™ê³¼ â€˜ì„±ê³¼ ì±…ì„â€™ì´ ë™ì‹œì— ì‘ë™í•  ë•Œ ìœ ì§€ëœë‹¤.",
  comparison:"ì›ë¬¸ì€ â€˜ì§€ì›ê³¼ ë³´ìƒ ë¶„ë¦¬â€™ì˜ í•„ìš”ì„±ì„ ê°„ë‹¨íˆ ì–¸ê¸‰í–ˆë‹¤. ì˜ˆì‹œëŠ” ì§€ì›ì˜ ë„¤ ìš”ì†Œ(ëª©ì Â·ëŒ€ìƒÂ·ê¸°ê°„Â·ì¢…ë£Œ)ë¥¼ ë¶„ëª…íˆ í•´ ì •ì±… ì„¤ê³„ì˜ ë‹«í˜ì„ í™•ë³´í•œë‹¤. ë˜í•œ ì›ë¬¸ì´ ì¶”ìƒì  ë²”ì£¼ì— ë¨¸ë¬¸ ë°˜ë©´, ì˜ˆì‹œëŠ” êµìœ¡Â·ì •ë³´Â·ê±´ê°• ë“±ìœ¼ë¡œ êµ¬ì²´í™”í•˜ì—¬ ì ìš© ê°€ëŠ¥ì„±ì„ ë†’ì˜€ë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ ê²°ë¡ ì—ì„œ â€˜ê¸°íšŒ ë³´ì • + ì„±ê³¼ ì±…ì„â€™ì´ë¼ëŠ” ì´ì› êµ¬ì¡°ë¥¼ ê³µì‹ì²˜ëŸ¼ ì œì‹œí•´ ë©”ì‹œì§€ íšŒìˆ˜ì™€ ê¸°ì–µ ìš©ì´ì„±ì„ ê°•í™”í–ˆë‹¤."
};

/* ===== ë¼ìš°íŒ… ===== */
function show(section){
  const home = document.getElementById('homeSection');
  const editor = document.getElementById('editorSection');
  home.classList.toggle('hidden', section!=='home');
  editor.classList.toggle('hidden', section!=='editor');
  if(section==='editor'){
    requestAnimationFrame(refreshAutosize);
    if (document.fonts && document.fonts.ready) document.fonts.ready.then(()=>refreshAutosize());
    editor.style.visibility = 'visible';
  }
  window.scrollTo({ top:0, behavior:'instant' });
}
function go(section){ location.hash = (section==='editor' ? '#editor' : '#home'); show(section); }
function routeFromHash(){ const h=(location.hash||'').toLowerCase(); if(h==='#editor') show('editor'); else show('home'); }
window.addEventListener('hashchange', routeFromHash);
window.addEventListener('DOMContentLoaded', routeFromHash);
function goToEditor(){ if(!currentUser){ deferredAction='goEditor'; openAuth(); return; } location.hash='#editor'; show('editor'); setTimeout(()=>{document.getElementById('studentName')?.focus({preventScroll:true});},0); }

/* ===== ì‹¤ í™”ë©´ ìŠ¤ì¼€ì¼: 1120px 1:1, í•„ìš” ì‹œ ì¶•ì†Œ ===== */
function scaleDemo(){
  document.querySelectorAll('.viewport').forEach(vp=>{
    const stage = vp.querySelector('.stage');
    if(!stage) return;
    const stageW = parseInt(vp.dataset.stage || '1120', 10); // ëœë”©=960, ì—ë””í„°=1120
    stage.style.width = stageW + 'px';
    const maxW = (vp.closest('.screen')||vp).clientWidth;
    const scale = Math.min(1, maxW / stageW);
    stage.style.transformOrigin = 'top center';
    stage.style.transform = `scale(${scale})`;
    const rect = stage.getBoundingClientRect();        // ë³€í™˜ í›„ ì‹¤ì œ ë†’ì´
    vp.style.height = rect.height + 'px';               // h*scale ì•„ë‹˜!
  });
}
window.addEventListener('DOMContentLoaded', scaleDemo);
window.addEventListener('resize', scaleDemo);

/* ===== ë°ëª¨ ì°¨íŠ¸ ===== */
function renderDemoChart(){
  const el=document.getElementById('demoChart');
  if(!el) return;
  new Chart(el.getContext('2d'),{
    type:'bar',
    data:{ labels:['ë…¼ë¦¬ë ¥','ë…í•´ë ¥','êµ¬ì„±ë ¥','í‘œí˜„ë ¥'],
      datasets:[{ data:[9,9,9,10], backgroundColor:"rgba(33,64,177,.75)", borderRadius:8, barThickness:28, categoryPercentage:0.65 }]},
    options:{ animation:{duration:400},
      scales:{ x:{grid:{display:false},ticks:{color:'#6B7280',font:{size:12}}},
               y:{beginAtZero:true,max:10,ticks:{stepSize:1,color:'#9CA3AF',font:{size:11}},grid:{color:'rgba(17,24,39,.06)'}}},
      plugins:{legend:{display:false}}}
  });
}
window.addEventListener('DOMContentLoaded', renderDemoChart);

/* ===== ë°ëª¨ ì˜ˆì‹œ í† ê¸€ ===== */
function renderDemoExample(){
  const btn=document.getElementById('demoExampleBtn');
  const wrap=document.getElementById('demoExampleWrap');
  const ex=document.getElementById('demoExampleText');
  const cmp=document.getElementById('demoComparisonText');
  btn.disabled=true; const old=btn.textContent; btn.textContent='ìƒì„± ì¤‘â€¦';
  setTimeout(()=>{
    ex.innerHTML = (demoSet.example||'').replace(/\n/g,'<br>');
    cmp.innerHTML = (demoSet.comparison||'').replace(/\n/g,'<br>');
    wrap.classList.remove('hidden');
    btn.textContent='ì˜ˆì‹œë‹µì•ˆ ìƒì„±ë¨';
  }, 500);
}

/* ===== textarea ìë™ ë¦¬ì‚¬ì´ì¦ˆ & ì¹´ìš´íŠ¸ ===== */
function autoResize(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,1200)+'px'; }
function refreshAutosize(){ document.querySelectorAll('textarea').forEach(t=>{ autoResize(t); }); }
function bindAutoResize(){ document.querySelectorAll('textarea').forEach(t=>{ t.addEventListener('input',()=>autoResize(t)); autoResize(t); }); }
window.addEventListener('DOMContentLoaded', bindAutoResize);
function updateCharCount(){
  const essay=document.getElementById('essay').value;
  const l=parseInt(document.getElementById('charLimit').value);
  const r=parseInt(document.getElementById('charRange').value)||0;
  const enabled=!Number.isNaN(l);
  const min=enabled?Math.max(0,l-r):0;
  const max=enabled?l+r:Infinity;
  const inRange=!enabled?true:(essay.length>=min && essay.length<=max);
  const el=document.getElementById('charCount');
  el.textContent = enabled ? `í˜„ì¬ ê¸€ì ìˆ˜: ${essay.length} Â· ê¸°ì¤€ ${min}~${max}` : `í˜„ì¬ ê¸€ì ìˆ˜: ${essay.length}`;
  el.style.color = inRange ? '#6B7280' : '#ef4444';
}

/* ===== ì œì‹œë¬¸ ì¶”ê°€ (ì „ì—­ ë°”ì¸ë”©) ===== */
window.addPassage = function(){
  const t=document.createElement('textarea');
  t.className='passage textarea'; t.rows=3;
  t.placeholder='ì œì‹œë¬¸ì„ ê·¸ëŒ€ë¡œ ì ì–´ ì£¼ì„¸ìš”.';
  document.getElementById('passages').appendChild(t);
  t.addEventListener('input',()=>autoResize(t));
  autoResize(t); t.focus();
};
document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('btnAddPassage')?.addEventListener('click', ()=>window.addPassage()); });

/* ===== ìƒíƒœ ===== */
let scoreChart, savedScores=[], savedReasons={}, savedExample="", savedComparison="";
let exampleGenerated=false; let currentUser=null; let deferredAction=null;

function resetReport(){
  document.getElementById('studentName').value = '';
  document.getElementById('question').value = '';

  // ì²« ë²ˆì§¸ ì œì‹œë¬¸ë§Œ ë¹„ìš°ê³  ë‚˜ë¨¸ì§€ëŠ” ì œê±°
  document.querySelectorAll('.passage').forEach((p, i) => {
    if (i === 0) p.value = '';
    else p.remove();
  });

  document.getElementById('essay').value = '';
  document.getElementById('charLimit').value = '';
  document.getElementById('charRange').value = '';
  document.getElementById('charCount').textContent = '';

  // ê²°ê³¼/ì˜ˆì‹œ ì˜ì—­ ë‹«ê³  ë¹„ìš°ê¸°
  document.getElementById('resultCard').classList.add('hidden');
  document.getElementById('exampleSection').classList.add('hidden');
  document.getElementById('exampleNote').style.display = 'none';
  document.getElementById('exampleOutput').innerHTML = '';
  document.getElementById('comparisonOutput').innerHTML = '';

  // ìƒíƒœê°’ / ì°¨íŠ¸ ì´ˆê¸°í™”
  savedScores = [];
  savedReasons = {};
  savedExample = '';
  savedComparison = '';
  if (scoreChart) { try { scoreChart.destroy(); } catch(e) {} scoreChart = null; }

  updatePdfBtnState();
  refreshAutosize();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}


// === PDF v2 ìœ í‹¸/ë²„íŠ¼ ë°”ì¸ë”© ===
window.__pdf_version = 'v2.1-2025-10-10';

function updatePdfBtnState(){
  const b = document.getElementById('btnSavePDF');
  if(!b) return;
  b.disabled = !(savedScores?.length); // ì ìˆ˜ ì—†ì„ ë•Œ ë¹„í™œì„±í™”
}

async function waitFontsAndImages(root){
  try { if (document.fonts?.ready) await document.fonts.ready; } catch(e){}
  const imgs = Array.from(root.querySelectorAll('img')).filter(i=>!i.complete);
  await Promise.all(imgs.map(img=>new Promise(res=>{ img.onload = img.onerror = res; })));
}

document.addEventListener('DOMContentLoaded', () => {
  const b = document.getElementById('btnSavePDF');
  if (b) b.addEventListener('click', downloadPDF_v2);
  updatePdfBtnState();
});

/* ===== ì´ì /ìƒíƒœ ===== */
function getTotalAndStatus(scores){
  const total=(scores||[]).reduce((a,b)=>a+(parseInt(b)||0),0);
  let status={label:"ì˜ˆë¹„",desc:"ì¡°ê¸ˆë§Œ ë‹¤ë“¬ìœ¼ë©´ ë” ì¢‹ì•„ì ¸ìš”.",emoji:"ğŸ™‚",tone:"#f59e0b"};
  if(total<30) status={label:"ë‹¤ì‹œ ì“°ê¸°",desc:"ë‹¤ìŒ ì‹œë„ì—ì„œ ë” ë‹¨ë‹¨í•´ì§ˆ ê±°ì˜ˆìš”.",emoji:"ğŸ˜…",tone:"#ef4444"};
  else if(total>=36) status={label:"í•©ê²©",desc:"ì§€ê¸ˆë„ ì¶©ë¶„íˆ ì„¤ë“ë ¥ ìˆì–´ìš”!",emoji:"ğŸ¥³",tone:"#10b981"};
  return { total, status };
}

/* ===== ë¦¬ë·° ===== */
async function submitEssay(){
  if(!currentUser){ deferredAction='review'; openAuth(); return; }

  document.getElementById('loading').style.display='block';
  document.getElementById('error').style.display='none';
  try{
    const name=document.getElementById('studentName').value;
    const question=document.getElementById('question').value;
    const passages=[...document.querySelectorAll('.passage')].map(p=>p.value);
    const essay=document.getElementById('essay').value;

    const r=await fetch('/review',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,question,passages,essay})});
    if(r.status===401){ deferredAction='review'; openAuth(); return; }
    const data=await r.json();
    if(!r.ok){ throw new Error(data.error||'ì˜¤ë¥˜'); }

    savedScores=data.scores; savedReasons=data.reasons;
    const { total, status } = getTotalAndStatus(savedScores);

    /* ê²°ê³¼ ì¹´ë“œ ê·¸ë¦¬ê¸° (ì˜ˆì‹œ ë²„íŠ¼ë§Œ ë…¸ì¶œ) */
    document.getElementById('evalSummary').innerHTML=`
      <div class="panel" style="display:flex;align-items:center;gap:14px">
        <div style="font-size:30px">${status.emoji}</div>
        <div style="flex:1">
          <div style="font-weight:900">ì´ì  <span style="color:${status.tone}">${total}</span> / 40 Â·
            <span style="color:${status.tone}">${status.label}</span></div>
          <div class="muted" style="margin-top:4px">${status.desc}</div>
          <div style="margin-top:8px;position:relative;height:10px;background:#eef2ff;border-radius:999px;overflow:hidden">
            <div style="width:${(total/40)*100}%;height:100%;background:${status.tone};transition:width .5s"></div>
            <div style="position:absolute;left:${(30/40)*100}%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.15)"></div>
            <div style="position:absolute;left:${(36/40)*100}%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.25)"></div>
          </div>
        </div>
        <div style="position:relative; width:110px; height:110px">
          <svg width="110" height="110">
            <circle r="52" cx="55" cy="55" fill="transparent" stroke="#eef2ff" stroke-width="10"></circle>
            <circle r="52" cx="55" cy="55" fill="transparent" stroke="${status.tone}" stroke-width="10"
              stroke-dasharray="327" stroke-dashoffset="${327-(327*(total/40))}"></circle>
          </svg>
          <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:900">${total}</div>
        </div>
      </div>

      <div class="kpi" style="margin-top:14px">
        ${['ë…¼ë¦¬ë ¥','ë…í•´ë ¥','êµ¬ì„±ë ¥','í‘œí˜„ë ¥'].map((k,i)=>`
          <div class="panel">
            <div style="font-weight:800">${k} (${savedScores[i]}ì )</div>
            <div class="muted" style="margin-top:6px">${savedReasons[k]}</div>
          </div>
        `).join('')}
      </div>

      <div class="panel" style="margin-top:14px"><canvas id="scoreChart" height="140"></canvas></div>

      <div id="exampleCTA" style="text-align:right;margin-top:12px">
        <button id="btnExample" class="btn btn-primary" onclick="loadExample()">ì˜ˆì‹œë‹µì•ˆ ë³´ê¸°</button>
      </div>
    `;

    const ctx=document.getElementById('scoreChart').getContext('2d');
    if(scoreChart) scoreChart.destroy();
    scoreChart=new Chart(ctx,{
      type:'bar',
      data:{ labels:['ë…¼ë¦¬ë ¥','ë…í•´ë ¥','êµ¬ì„±ë ¥','í‘œí˜„ë ¥'],
        datasets:[{ data:savedScores, backgroundColor:"rgba(33,64,177,.75)", borderRadius:8, barThickness:28, categoryPercentage:0.65 }]},
      options:{ animation:{duration:600,easing:'easeOutQuart'},
        scales:{ x:{grid:{display:false},ticks:{color:'#6B7280',font:{size:12}}},
                 y:{beginAtZero:true,max:10,ticks:{stepSize:1,color:'#9CA3AF',font:{size:11}},grid:{color:'rgba(17,24,39,.06)'}}},
        plugins:{legend:{display:false}}}
    });

    document.getElementById('loading').style.display='none';
    document.getElementById('resultCard').classList.remove('hidden');
    document.getElementById('exampleSection').classList.add('hidden'); // âœ… ì‚¬ì „ ë…¸ì¶œ ê¸ˆì§€
    document.getElementById('exampleNote').style.display='none';
    document.getElementById('exampleOutput').innerHTML='';
    document.getElementById('comparisonOutput').innerHTML='';
    exampleGenerated=false;

    updatePdfBtnState();
  }catch(e){
    console.error(e);
    document.getElementById('loading').style.display='none';
    document.getElementById('error').style.display='block';
  }
}

/* ===== ì˜ˆì‹œ ===== */
async function loadExample(){
  if(!currentUser){ deferredAction='example'; openAuth(); return; }
  const btn=document.getElementById('btnExample');
  const note=document.getElementById('exampleNote');
  const errId='exampleInlineErr';
  let err=document.getElementById(errId);
  if(!err){
    err=document.createElement('div');
    err.id=errId; err.className='muted';
    err.style.cssText='margin-top:6px;color:#dc2626;text-align:right';
    document.getElementById('exampleCTA')?.appendChild(err);
  }
  err.textContent='';

  btn.disabled=true; const old=btn.textContent; btn.textContent='ìƒì„± ì¤‘...';

  try{
    const name=document.getElementById('studentName').value;
    const question=document.getElementById('question').value;
    const passages=[...document.querySelectorAll('.passage')].map(p=>p.value);
    const essay=document.getElementById('essay').value;
    const limit=document.getElementById('charLimit').value;
    const range=document.getElementById('charRange').value;

    const payload={ name, question, passages, essay };
    const base=parseInt(limit), rng=parseInt(range);
    if(!Number.isNaN(base)) payload.charBase=base;
    if(!Number.isNaN(rng))  payload.charRange=rng;

    const r=await fetch('/example',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(r.status===401){ deferredAction='example'; openAuth(); btn.disabled=false; btn.textContent=old; return; }
    const data=await r.json();
    if(!r.ok){ throw new Error(data.error||'ì˜¤ë¥˜'); }

    savedExample=data.example||''; savedComparison=data.comparison||'';
    if (data.length_note) {
  note.style.display = 'block';
  note.textContent = data.length_note;
} else if (data.length_valid === false) {
  note.style.display = 'block';
  note.textContent = 'âœï¸ ê¶Œì¥ ê¸€ììˆ˜ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ì§€ë§Œ, ì°¸ê³ ìš© ì˜ˆì‹œëŠ” í‘œì‹œí•©ë‹ˆë‹¤.';
} else {
  note.style.display = 'none';
}


    document.getElementById('exampleOutput').innerHTML=(savedExample||'').replace(/\n/g,'<br>');
    document.getElementById('comparisonOutput').innerHTML=(savedComparison||'').replace(/\n/g,'<br>');

    document.getElementById('exampleSection').classList.remove('hidden'); // âœ… ì´ë•Œë§Œ ì—´ê¸°
    document.getElementById('exampleSection').scrollIntoView({behavior:'smooth',block:'start'});
    btn.textContent='ì˜ˆì‹œë‹µì•ˆ ìƒì„±ë¨';

   updatePdfBtnState();
  }catch(e){
    console.error(e);
    err.textContent='ìƒì„± ì¤‘ ë¬¸ì œê°€ ìˆì—ˆì–´ìš”. ì ì‹œ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
    btn.textContent=old; btn.disabled=false;
  }
}

/* ===== PDF ===== */
// === PDF ì €ì¥ (ìµœì¢…) ===
window.__pdf_version = 'v2.1-2025-10-10';

function updatePdfBtnState(){
  const b = document.getElementById('btnSavePDF');
  if(!b) return;
  b.disabled = !(savedScores?.length); // ì ìˆ˜ ì—†ì„ ë•Œ ë¹„í™œì„±í™”
}

async function waitFontsAndImages(root){
  try { if (document.fonts?.ready) await document.fonts.ready; } catch(e){}
  const imgs = Array.from(root.querySelectorAll('img')).filter(i=>!i.complete);
  await Promise.all(imgs.map(img=>new Promise(res=>{ img.onload = img.onerror = res; })));
}

async function downloadPDF_v2(){
  // 0) ê°€ë“œ
  if (!window.html2pdf) { alert('PDF ëª¨ë“ˆ(html2pdf)ì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }
  if (location.protocol === 'file:') { alert('file://ë¡œ ì—´ë©´ PDF ìƒì„±ì´ ë§‰í ìˆ˜ ìˆì–´ìš”. http(s) ì£¼ì†Œë¡œ ì—´ì–´ì£¼ì„¸ìš”.'); return; }

  // 1) ë²„íŠ¼ ì ê¸ˆ
  const btn = document.getElementById('btnSavePDF');
  if (btn) btn.disabled = true;

  // 2) ë°ì´í„° ìˆ˜ì§‘
  const name = document.getElementById('studentName').value || 'ì´ë¦„ ë¯¸ì…ë ¥';
  const today = new Date().toISOString().split('T')[0];
  const { total, status } = getTotalAndStatus(savedScores || []);

  // 3) ì°¨íŠ¸ ì´ë¯¸ì§€(ìˆìœ¼ë©´)
  let chartImg = '';
  try {
    const canvas = document.getElementById('scoreChart');
    if (canvas) chartImg = canvas.toDataURL('image/png', 1.0);
  } catch(e) {}

  // 4) HTML í…œí”Œë¦¿ (ë°±í‹± ì‚¬ìš©!)
  const html = `
<div style="font-family:'SUIT',system-ui,-apple-system,'Noto Sans KR',sans-serif;color:#111827">
  <!-- í—¤ë” -->
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div style="display:flex;align-items:center;gap:8px">
      <img src="/static/academy_logo.png" alt="ì•„ì¹´ë°ë¯¸ì°½" style="height:22px;object-fit:contain"/>
      <h2 style="margin:0;font-weight:800;letter-spacing:-.2px">ë‹¤ì“° ë¦¬í¬íŠ¸</h2>
    </div>
    <div style="color:#6b7280;font-size:12px">í•™ìƒ: ${name} Â· ë‚ ì§œ: ${today}</div>
  </div>

  <!-- ìš”ì•½ -->
  <div style="display:flex;gap:12px;align-items:center;border:1px solid #e5e7eb;border-radius:14px;padding:12px;background:#fff">
    <div style="font-size:26px">${status.emoji || 'ğŸ˜ƒ'}</div>
    <div style="flex:1;min-width:0">
      <div style="font-weight:900">
        ì´ì  <span style="color:${status.tone}">${total}</span> / 40 Â·
        <span style="color:${status.tone}">${status.label}</span>
      </div>
      <div style="margin-top:6px;position:relative;height:8px;background:#eef2ff;border-radius:999px;overflow:hidden">
        <div style="width:${(total/40)*100}%;height:100%;background:${status.tone}"></div>
        <div style="position:absolute;left:${(30/40)*100}%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.12)"></div>
        <div style="position:absolute;left:${(36/40)*100}%;top:0;bottom:0;width:2px;background:rgba(17,24,39,.12)"></div>
      </div>
      <div style="margin-top:4px;color:#6b7280;font-size:12px">${status.desc}</div>
    </div>
    <div style="position:relative;width:92px;height:92px">
      <svg width="92" height="92">
        <circle r="42" cx="46" cy="46" fill="transparent" stroke="#eef2ff" stroke-width="10"></circle>
        <circle r="42" cx="46" cy="46" fill="transparent" stroke="${status.tone}" stroke-width="10"
          stroke-dasharray="${2*Math.PI*42}" stroke-dashoffset="${2*Math.PI*42 - (2*Math.PI*42*(total/40))}"></circle>
      </svg>
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:900">${total}</div>
    </div>
  </div>

  ${chartImg ? `
  <div style="margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff">
    <img src="${chartImg}" style="width:100%;height:auto;display:block"/>
  </div>` : ''}

  <div style="margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff">
    <div style="font-weight:800;margin-bottom:8px">í•œëˆˆì— ì´í•´ë˜ëŠ” ë¦¬í¬íŠ¸</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div style="padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff">
        <div style="display:inline-block;padding:4px 8px;background:#eef2ff;color:#1d4ed8;border-radius:999px;font-weight:700;font-size:12px">
          ë…¼ë¦¬ë ¥ (${(savedScores?.[0] ?? 0)}ì )
        </div>
        <div style="margin-top:8px;font-size:12.5px;line-height:1.6;color:#1f2937">
          ${(savedReasons?.['ë…¼ë¦¬ë ¥'] || '').replace(/\\n/g,'<br>')}
        </div>
      </div>
      <div style="padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff">
        <div style="display:inline-block;padding:4px 8px;background:#eef2ff;color:#1d4ed8;border-radius:999px;font-weight:700;font-size:12px">
          ë…í•´ë ¥ (${(savedScores?.[1] ?? 0)}ì )
        </div>
        <div style="margin-top:8px;font-size:12.5px;line-height:1.6;color:#1f2937">
          ${(savedReasons?.['ë…í•´ë ¥'] || '').replace(/\\n/g,'<br>')}
        </div>
      </div>
      <div style="padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff">
        <div style="display:inline-block;padding:4px 8px;background:#eef2ff;color:#1d4ed8;border-radius:999px;font-weight:700;font-size:12px">
          êµ¬ì„±ë ¥ (${(savedScores?.[2] ?? 0)}ì )
        </div>
        <div style="margin-top:8px;font-size:12.5px;line-height:1.6;color:#1f2937">
          ${(savedReasons?.['êµ¬ì„±ë ¥'] || '').replace(/\\n/g,'<br>')}
        </div>
      </div>
      <div style="padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff">
        <div style="display:inline-block;padding:4px 8px;background:#eef2ff;color:#1d4ed8;border-radius:999px;font-weight:700;font-size:12px">
          í‘œí˜„ë ¥ (${(savedScores?.[3] ?? 0)}ì )
        </div>
        <div style="margin-top:8px;font-size:12.5px;line-height:1.6;color:#1f2937">
          ${(savedReasons?.['í‘œí˜„ë ¥'] || '').replace(/\\n/g,'<br>')}
        </div>
      </div>
    </div>
  </div>

  <h3 style="margin:12px 0 6px">ì˜ˆì‹œë‹µì•ˆ</h3>
  <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;font-size:13px;line-height:1.65;color:#374151;max-height:360px;overflow:hidden">
    ${(savedExample || '').replace(/\\n/g,'<br>')}
  </div>

  <h3 style="margin:12px 0 6px">ë¹„êµ ë¶„ì„</h3>
  <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;font-size:13px;line-height:1.65;color:#374151;max-height:300px;overflow:hidden">
    ${(savedComparison || '').replace(/\\n/g,'<br>')}
  </div>
</div>`;

  // 5) ì˜µì…˜
  const opt = {
    margin: 8,
    filename: `ë‹¤ì“°_ë¦¬í¬íŠ¸_${today}.pdf`,
    html2canvas: { scale: 2, useCORS: true, logging: false, letterRendering: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['css','legacy'] }
  };

  // 6) ìƒì„±
  let wrap = null;
  try {
    wrap = document.createElement('div');
    wrap.style.cssText = 'position:fixed;left:-99999px;top:-99999px;opacity:0;pointer-events:none;';
    wrap.innerHTML = html;
    document.body.appendChild(wrap);

    await waitFontsAndImages(wrap);
    await html2pdf().from(wrap).set(opt).save();
  } catch (e) {
    console.error(e);
    alert('PDF ìƒì„± ì‹¤íŒ¨: ' + (e?.message || e));
  } finally {
    if (wrap && wrap.parentNode) wrap.parentNode.removeChild(wrap);
    if (btn) btn.disabled = false;
  }
}

  // html2pdf ì˜µì…˜
  const opt = {
    margin: 8,
    filename: `ë‹¤ì“°_ë¦¬í¬íŠ¸_${today}.pdf`,
    html2canvas: { scale: 2, useCORS: true, logging: false, letterRendering: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['css','legacy'] }
  };

  // ì„ì‹œ DOM ìƒì„± â†’ ë¦¬ì†ŒìŠ¤ ë¡œë“œ ëŒ€ê¸° â†’ PDF ìƒì„± â†’ ì •ë¦¬
  let wrap = null;
  try {
    wrap = document.createElement('div');
    wrap.style.cssText = 'position:fixed;left:-99999px;top:-99999px;opacity:0;pointer-events:none;';
    wrap.innerHTML = html;
    document.body.appendChild(wrap);                 // âœ… ì„ì‹œë¡œ DOMì— ë¶€ì°©
    await waitFontsAndImages(wrap);                  // âœ… í°íŠ¸/ì´ë¯¸ì§€ ë¡œë“œ ëŒ€ê¸°
    await html2pdf().from(wrap).set(opt).save();     // âœ… PDF ìƒì„±
  } finally {
    if (wrap && wrap.parentNode) wrap.parentNode.removeChild(wrap);  // âœ… ì •ë¦¬
    if (btn) btn.disabled = false;                                    // ë²„íŠ¼ ë³µêµ¬
  }
}

/* ===== Auth ===== */
async function fetchMe(){ try{ const r=await fetch('/auth/me'); const data=await r.json(); if(data.ok){ currentUser=data.user; paintHeader(); } }catch(e){} }
function paintHeader(){
  const loginBtn=document.getElementById('loginBtn');
  const prof=document.getElementById('profileArea');
  if(currentUser){
    loginBtn.classList.add('hidden');
    prof.classList.remove('hidden');
    const initial=(currentUser.name||currentUser.email||'A').trim()[0].toUpperCase();
    document.getElementById('avatarInitial').textContent=initial;
    document.getElementById('profileName').textContent=currentUser.name||currentUser.email;
  }else{
    prof.classList.add('hidden');
    loginBtn.classList.remove('hidden');
  }
}
function openAuth(){ document.getElementById('authWrap').classList.remove('hidden'); switchTab('login'); document.body.style.overflow='hidden'; }
function closeAuth(){ document.getElementById('authWrap').classList.add('hidden'); document.getElementById('loginError').style.display='none'; document.getElementById('registerError').style.display='none'; document.body.style.overflow=''; }
function switchTab(which){
  const l=document.getElementById('loginPanel'), r=document.getElementById('registerPanel');
  const tl=document.getElementById('tabLogin'), tr=document.getElementById('tabRegister');
  if(which==='login'){ l.classList.remove('hidden'); r.classList.add('hidden'); tl.classList.add('active'); tr.classList.remove('active'); }
  else{ r.classList.remove('hidden'); l.classList.add('hidden'); tr.classList.add('active'); tl.classList.remove('active'); }
}
async function register(){
  const body={ name:document.getElementById('regName').value, email:document.getElementById('regEmail').value, password:document.getElementById('regPassword').value };
  const r=await fetch('/auth/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const data=await r.json();
  if(!data.ok){ const el=document.getElementById('registerError'); el.style.display='block'; el.textContent=data.error||'ê°€ì…ì— ì‹¤íŒ¨í–ˆì–´ìš”.'; return; }
  currentUser=data.user; paintHeader(); closeAuth();
  if(deferredAction==='goEditor'){ goToEditor(); }
  if(deferredAction==='review'){ submitEssay(); }
  if(deferredAction==='example'){ loadExample(); }
  if(deferredAction==='records'){ openRecords(true); }
  deferredAction=null;
}
async function login(){
  const body={ email:document.getElementById('loginEmail').value, password:document.getElementById('loginPassword').value };
  const r=await fetch('/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const data=await r.json();
  if(!data.ok){ const el=document.getElementById('loginError'); el.style.display='block'; el.textContent=data.error||'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆì–´ìš”.'; return; }
  currentUser=data.user; paintHeader(); closeAuth();
  if(deferredAction==='goEditor'){ goToEditor(); }
  if(deferredAction==='review'){ submitEssay(); }
  if(deferredAction==='example'){ loadExample(); }
  if(deferredAction==='records'){ openRecords(true); }
  deferredAction=null;
}
async function logout(){ await fetch('/auth/logout',{method:'POST'}); currentUser=null; paintHeader(); }
window.addEventListener('DOMContentLoaded', fetchMe);

/* í”„ë¡œí•„ ë©”ë‰´ í† ê¸€ */
document.addEventListener('click', (e)=>{
  const btn=document.getElementById('profileBtn');
  const menu=document.getElementById('profileMenu');
  if(btn && btn.contains(e.target)){ menu.style.display = (menu.style.display==='block'?'none':'block'); }
  else if(menu && !menu.contains(e.target)){ menu.style.display='none'; }
});

/* ëª¨ë‹¬ ë°±ë“œë¡­/ESC */
window.addEventListener('DOMContentLoaded', ()=>{
  const authWrap=document.getElementById('authWrap');
  if(authWrap){ authWrap.addEventListener('click', e=>{ if(e.target===authWrap) closeAuth(); }); }
  const recWrap=document.getElementById('recordsWrap');
  if(recWrap){ recWrap.addEventListener('click', e=>{ if(e.target===recWrap) closeRecords(); }); }
  document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeAuth(); closeRecords(); } });
  document.getElementById('authWrap').classList.add('hidden'); // ì´ˆê¸° ìë™ ì˜¤í”ˆ ë°©ì§€
});

/* ê¸°ë¡ ëª¨ë‹¬ */
async function openRecords(authed=false){
  if(!currentUser && !authed){ deferredAction='records'; openAuth(); return; }
  document.getElementById('recordsWrap').classList.remove('hidden');
  document.body.style.overflow='hidden';
  const box=document.getElementById('recordsList'); box.textContent='ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
  try{
    const r=await fetch('/reports'); const j=await r.json();
    if(!r.ok){ box.textContent=j.error||'ì˜¤ë¥˜'; return; }
    if(!j.items.length){ box.textContent='ì•„ì§ ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.'; return; }
    box.innerHTML = j.items.map(it=>`
      <div style="padding:8px 0; border-bottom:1px solid #f3f4f6">
        <div><b>${(it.student||'ë¬´ëª…')}</b> Â· ${it.total??'-'}ì  <span class="muted">(${it.status||'-'})</span></div>
        <div class="muted" style="font-size:12px">${new Date(it.created_at).toLocaleString()}</div>
      </div>
    `).join('');
  }catch{ box.textContent='ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'; }
}
function closeRecords(){ document.getElementById('recordsWrap').classList.add('hidden'); document.body.style.overflow=''; }
</script>
</body>
</html>
