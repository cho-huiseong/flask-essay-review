<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë‹¤ì“° ë¦¬í¬íŠ¸</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet" />
  <style>
    :root {
      --primary: #2140b1;
      --bg: #f9fafc;
      --card: #ffffff;
      --border: #e5e7eb;
      --accent: #10b981;
    }
    * {
      font-family: 'SUIT', sans-serif;
      transition: all 0.2s ease-in-out;
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: #1f2937;
    }
    header {
      background: var(--card);
      padding: 24px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }
    header h1 {
      font-size: 1.5rem;
      color: var(--primary);
      font-weight: 700;
      margin: 0;
    }
    header .ghost{
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
    }
    header .ghost:hover{ background: rgba(33,64,177,0.06);}

    .layout {
      display: flex;
      flex-wrap: wrap;
      max-width: 1200px;
      margin: 40px auto;
      gap: 32px;
      padding: 0 20px;
    }
    .left, .right {
      flex: 1 1 500px;
      background: var(--card);
      padding: 36px;
      border-radius: 24px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.06);
    }
    label {
      font-weight: 600;
      margin-top: 1.2rem;
      display: block;
      font-size: 0.95rem;
    }
    textarea, input {
      width: 100%;
      padding: 14px;
      margin-top: 6px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: white;
      font-size: 1rem;
      transition: border 0.2s;
      resize: none; /* auto-resize ì ìš©ì„ ìœ„í•´ ìˆ˜ë™ ë¦¬ì‚¬ì´ì¦ˆ ë¹„í™œì„±í™” */
      overflow: hidden; /* ìŠ¤í¬ë¡¤ ìˆ¨ê¹€ */
    }
    textarea:focus, input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(33, 64, 177, 0.15);
    }
    button {
      margin-top: 28px;
      width: 100%;
      padding: 16px;
      background-color: var(--primary);
      color: white;
      font-size: 1rem;
      border: none;
      border-radius: 14px;
      cursor: pointer;
    }
    button:hover {
      background-color: #1a2f91;
    }
    .fade {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .fade.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <header>
    <h1>ì•„ì¹´ë°ë¯¸ì°½ Â· ë‹¤ì“° ë¦¬í¬íŠ¸</h1>
    <!-- ìš°ì¸¡ ìƒë‹¨ ìƒˆ ë¦¬í¬íŠ¸ ë²„íŠ¼ -->
    <button id="resetBtn" onclick="resetAll()" class="ghost">ìƒˆ ë¦¬í¬íŠ¸ ì‹œì‘</button>
  </header>

  <div class="layout" id="mainSection">
    <div class="left">
      <label>í•™ìƒ ì´ë¦„</label>
      <input id="studentName" type="text" placeholder="í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" />

      <!-- ğŸ” ì…ë ¥ ìˆœì„œ ë³€ê²½: ì§ˆë¬¸ì„ ì œì‹œë¬¸ë³´ë‹¤ ìœ„ë¡œ -->
      <label>ì§ˆë¬¸</label>
      <textarea id="question" rows="2" placeholder="ì§ˆë¬¸ì€ ì—¬ê¸°ì— ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>

      <label>ì œì‹œë¬¸</label>
      <div id="passages">
        <textarea class="passage" rows="3" placeholder="ì½ì€ ì œì‹œë¬¸ì„ ê·¸ëŒ€ë¡œ ì ì–´ì£¼ì„¸ìš”."></textarea>
      </div>
      <div class="add-passage" onclick="addPassage()" style="margin-top:10px; color:var(--primary); cursor:pointer;">â• ì œì‹œë¬¸ ì¶”ê°€</div>

      <label>ë…¼ìˆ ë¬¸</label>
      <textarea id="essay" rows="5" placeholder="ì—´ì‹¬íˆ ì‘ì„±í•œ ë…¼ìˆ ë¬¸ì„ ì—¬ê¸°ì— ì‘ì„±í•´ì£¼ì„¸ìš”." oninput="updateCharCount()"></textarea>
      <div id="charCount" style="margin-top:6px; font-size:0.9rem; color:#555;"></div>

      <label>ê¸€ì ìˆ˜ ì œí•œ</label>
      <div style="display:flex; gap:10px;">
        <input id="charBase" type="number" placeholder="ì˜ˆ: 700" />
        <input id="charRange" type="number" placeholder="Â± ì˜ˆ: 50" />
      </div>

      <button onclick="submitEssay()">âœ¨ ë¦¬í¬íŠ¸ë¥¼ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”</button>
      <div id="loading" style="display:none; margin-top:12px;">â³ í•™ìƒì˜ ê¸€ì„ ì •ì„±ê» ì½ê³  ìˆì–´ìš”</div>
      <div id="error" style="display:none; color:red; margin-top:12px;">âš ï¸ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ë³¼ê¹Œìš”?</div>
    </div>

    <div class="right fade" id="resultCard" style="display:none">
      <h3>ğŸ“‹ í•™ìƒì˜ ì—­ëŸ‰, ì´ë ‡ê²Œ ì •ë¦¬í–ˆì–´ìš”</h3>
      <div id="evalSummary"></div>
      <button onclick="showExample()">ğŸ’¡ ë‹¤ë¥¸ ë°©ì‹ì˜ ì ‘ê·¼ë„ ì‚´í´ë³´ì„¸ìš”</button>
    </div>
  </div>

  <div id="exampleSection" class="fade" style="display:none; max-width: 800px; margin: 40px auto; background: white; padding: 36px; border-radius: 24px; box-shadow: 0 6px 24px rgba(0,0,0,0.06);">
    <div id="exampleLoading">â³ ì˜ˆì‹œë‹µì•ˆê³¼ ë¶„ì„ì„ ì •ë¦¬í•˜ê³  ìˆì–´ìš”...</div>
    <div id="exampleResult" style="display:none">
      <h3>ğŸ“ ì˜ˆì‹œë‹µì•ˆ</h3>
      <p id="exampleAnswer"></p>
      <h3>ğŸ” í•™ìƒì˜ ë…¼ìˆ ë¬¸ê³¼ ë¹„êµí•œ ë¶„ì„ì´ì—ìš”</h3>
      <p id="comparisonBox"></p>
      <p id="lengthWarning" style="color: red; font-size: 0.9rem; display: none;"></p>
      <div id="retryButtonBox" style="display: none; margin-top: 10px; gap: 8px;">
        <button onclick="handleRetryResponse(true)">ì˜ˆ</button>
        <button onclick="handleRetryResponse(false)">ì•„ë‹ˆìš”</button>
      </div>
      <button onclick="downloadPDF()" style="background: var(--accent); margin-top: 20px;">ğŸ“„ ìš°ë¦¬ì˜ ê¸°ì–µ ì†ì— ë‚¨ê²¨ë‘˜ê²Œìš”.</button>
      <button onclick="backToMain()">ğŸ”™ ë‹¤ì‹œ ì…ë ¥í•˜ëŸ¬ ê°€ê¸°</button>
    </div>
  </div>

  <script>
    let savedScores = [], savedReasons = {}, savedExample = '', savedComparison = '';
    let scoreChart = null;
    const today = new Date().toISOString().split('T')[0];

    // ----- auto-resize -----
    function autoResize(el){
      el.style.height = "auto";
      el.style.height = el.scrollHeight + "px";
    }
    function bindAutoResizeToAll(){
      document.querySelectorAll("textarea").forEach(t=>{
        // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€
        if (!t.dataset.autoresizeBound){
          t.addEventListener("input", ()=>autoResize(t));
          t.dataset.autoresizeBound = "1";
          autoResize(t); // ì´ˆê¸° í˜¸ì¶œ
        }
      });
    }
    document.addEventListener("DOMContentLoaded", bindAutoResizeToAll);

    // ----- UI helpers -----
    function addPassage() {
      const wrapper = document.createElement("div");
      wrapper.innerHTML = '<textarea class="passage" rows="3" placeholder="ì½ì€ ì œì‹œë¬¸ì„ ê·¸ëŒ€ë¡œ ì ì–´ì£¼ì„¸ìš”."></textarea>';
      document.getElementById("passages").appendChild(wrapper);
      bindAutoResizeToAll();
    }

    function updateCharCount() {
      const count = document.getElementById("essay").value.length;
      document.getElementById("charCount").textContent = `í˜„ì¬ê¹Œì§€ ì‘ì„±í•œ ê¸€ì ìˆ˜: ${count}ì`;
    }

    function resetAll(){
      // ì…ë ¥ê°’ ì´ˆê¸°í™”
      document.getElementById("studentName").value = "";
      document.getElementById("question").value = "";
      document.getElementById("essay").value = "";
      document.getElementById("charBase").value = "";
      document.getElementById("charRange").value = "";
      document.getElementById("charCount").textContent = "";

      // ì œì‹œë¬¸ í•œ ì¹¸ë§Œ ë‚¨ê¸°ê¸°
      const pWrap = document.getElementById("passages");
      pWrap.innerHTML = '<textarea class="passage" rows="3" placeholder="ì½ì€ ì œì‹œë¬¸ì„ ê·¸ëŒ€ë¡œ ì ì–´ì£¼ì„¸ìš”."></textarea>';
      bindAutoResizeToAll();

      // ìƒíƒœ/ê²°ê³¼ ì´ˆê¸°í™”
      savedScores = []; savedReasons = {}; savedExample = ""; savedComparison = "";
      document.getElementById("resultCard").style.display = "none";
      document.getElementById("exampleSection").style.display = "none";
      document.getElementById("mainSection").style.display = "flex";
      document.getElementById("loading").style.display = "none";
      document.getElementById("error").style.display = "none";

      // ì°¨íŠ¸ ì œê±°
      if (scoreChart) { scoreChart.destroy(); scoreChart = null; }
    }

    // ----- API calls -----
    async function submitEssay() {
      const name = document.getElementById("studentName").value.trim();
      const passages = [...document.querySelectorAll(".passage")].map(p => p.value).filter(p => p.trim());
      const question = document.getElementById("question").value.trim();
      const essay = document.getElementById("essay").value.trim();
      const charBase = document.getElementById("charBase").value;
      const charRange = document.getElementById("charRange").value;

      if (!name || !question || !essay || passages.length === 0) {
        alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      document.getElementById("loading").style.display = "block";
      document.getElementById("error").style.display = "none";

      try {
        const res = await fetch("/review", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ passages, question, essay, charBase, charRange })
        });
        const result = await res.json();
        if (!res.ok) throw new Error(result.error || "ì„œë²„ ì˜¤ë¥˜");

        savedScores = result.scores;
        savedReasons = result.reasons;

        // ê²°ê³¼ ë Œë”ë§
        document.getElementById("resultCard").style.display = "block";
        setTimeout(() => document.getElementById("resultCard").classList.add("show"), 30);

        document.getElementById("evalSummary").innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            ${['ë…¼ë¦¬ë ¥','ë…í•´ë ¥','êµ¬ì„±ë ¥','í‘œí˜„ë ¥'].map((label, i) => `
              <div style="background:white; border-radius:16px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.06);">
                <h4 style="margin:0 0 12px; font-size:1.1rem;">${label} (${savedScores[i]}ì )</h4>
                <p style="margin:0; color:#4b5563; line-height:1.5;">${savedReasons[label]}</p>
              </div>
            `).join('')}
          </div>
          <div style="margin-top: 40px;">
            <canvas id="scoreChart" height="300"></canvas>
          </div>
        `;

        const ctx = document.getElementById("scoreChart").getContext("2d");
        if (scoreChart) scoreChart.destroy();
        scoreChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["ë…¼ë¦¬ë ¥", "ë…í•´ë ¥", "êµ¬ì„±ë ¥", "í‘œí˜„ë ¥"],
            datasets: [{
              label: "ì ìˆ˜",
              data: savedScores,
              backgroundColor: ["#6366f1", "#3b82f6", "#f59e0b", "#10b981"],
              borderRadius: 8,
              barThickness: 40
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: true, max: 10, ticks: { stepSize: 1 } }
            },
            plugins: { legend: { display: false } }
          }
        });

      } catch (err) {
        console.error("ë¦¬ë·° ì˜¤ë¥˜:", err);
        document.getElementById("error").style.display = "block";
      } finally {
        document.getElementById("loading").style.display = "none";
      }
    }

    function showExample(retry = false) {
      document.getElementById("mainSection").style.display = "none";
      document.getElementById("exampleSection").style.display = "block";
      setTimeout(() => document.getElementById("exampleSection").classList.add("show"), 50);
      document.getElementById("exampleLoading").style.display = "block";
      document.getElementById("exampleResult").style.display = "none";
      document.getElementById("lengthWarning").style.display = "none";
      document.getElementById("retryButtonBox").style.display = "none";

      const passages = [...document.querySelectorAll(".passage")].map(p => p.value);
      const question = document.getElementById("question").value;
      const essay = document.getElementById("essay").value;
      const charBase = document.getElementById("charBase").value;
      const charRange = document.getElementById("charRange").value;

      fetch("/example", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ passages, question, essay, scores: savedScores, reasons: savedReasons, charBase, charRange, retryConfirmed: retry })
      })
      .then(res => res.json())
      .then(result => {
        if (result.error) throw new Error(result.error);
        savedExample = result.example || "ì˜ˆì‹œë‹µì•ˆ ì—†ìŒ";
        savedComparison = result.comparison || "ë¹„êµ ì„¤ëª… ì—†ìŒ";

        document.getElementById("exampleAnswer").textContent = savedExample;
        document.getElementById("comparisonBox").textContent = savedComparison;

        if (!result.length_valid && !retry) {
          document.getElementById("lengthWarning").style.display = "block";
          document.getElementById("lengthWarning").textContent =
            `ì´ ì˜ˆì‹œë‹µì•ˆì€ ${result.length_actual}ìë¡œ, ê¸°ì¤€ì— ë¶€ì¡±í•˜ê±°ë‚˜ ì´ˆê³¼í•©ë‹ˆë‹¤. ë‹¤ì‹œ ìƒì„±í• ê¹Œìš”?`;
          document.getElementById("retryButtonBox").style.display = "flex";
        }

        document.getElementById("exampleLoading").style.display = "none";
        document.getElementById("exampleResult").style.display = "block";
      })
      .catch(err => {
        console.error("ì˜ˆì‹œë‹µì•ˆ ì˜¤ë¥˜:", err);
        document.getElementById("exampleAnswer").textContent = "â— ì˜ˆì‹œë‹µì•ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        document.getElementById("comparisonBox").textContent = "";
        document.getElementById("exampleLoading").style.display = "none";
        document.getElementById("exampleResult").style.display = "block";
      });
    }

    function handleRetryResponse(yes) {
      if (yes) {
        showExample(true);
      } else {
        document.getElementById("lengthWarning").style.display = "none";
        document.getElementById("retryButtonBox").style.display = "none";
      }
    }

    function backToMain() {
      document.getElementById("exampleSection").style.display = "none";
      document.getElementById("mainSection").style.display = "flex";
    }

    function downloadPDF() {
      const name = document.getElementById("studentName").value;
      const essay = document.getElementById("essay").value;
      const charCount = essay.length;
      const wrapper = document.createElement("div");
      wrapper.innerHTML = `
        <h2>ğŸ“„ ë‹¤ì“° ë¦¬í¬íŠ¸</h2>
        <p>í•™ìƒ: ${name} | ë‚ ì§œ: ${today}</p>
        <p>ê³µë°± í¬í•¨ ê¸€ì ìˆ˜: ${charCount}ì</p>
        <h4>ğŸ–Š ì‘ì„±í•œ ë…¼ìˆ ë¬¸</h4>
        <p>${essay.replace(/\n/g,'<br>')}</p>
        <h4>ğŸ“Š í‰ê°€ ìš”ì•½</h4>
        ${['ë…¼ë¦¬ë ¥','ë…í•´ë ¥','êµ¬ì„±ë ¥','í‘œí˜„ë ¥'].map((label, i) => `<p><strong>${label} (${savedScores[i]}ì )</strong><br>${savedReasons[label]}</p>`).join('')}
        <h4>ğŸ“ ì˜ˆì‹œë‹µì•ˆ</h4>
        <p>${savedExample.replace(/\n/g,'<br>')}</p>
        <h4>ğŸ” ë¹„êµ ë¶„ì„</h4>
        <p>${savedComparison.replace(/\n/g,'<br>')}</p>
      `;
      html2pdf().from(wrapper).set({
        margin: 10,
        filename: `ë‹¤ì“°_ë¦¬í¬íŠ¸_${today}.pdf`,
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).save();
    }
  </script>
</body>
</html>
