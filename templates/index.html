<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì•„ì¹´ë°ë¯¸ì°½ Â· ë‹¤ì“° ë¦¬í¬íŠ¸</title>

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ (ê·¸ë˜í”„/PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <!-- í•œê¸€ í°íŠ¸ (Pretendard) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

  <!-- ìŠ¤íƒ€ì¼ í† í° + êµ¬ì„±ìš”ì†Œ -->
  <style>
    :root{
      --brand:#2140B1; --brand-600:#1a2f91;
      --bg:#f5f8ff; --ink:#0a0a0a; --muted:#6b7280; --card:#ffffff;
      --glass:rgba(255,255,255,.14); --radius:20px;
      --shadow-lg:0 25px 60px rgba(19,46,118,.18);
      --shadow:0 10px 30px rgba(19,46,118,.12);
      --ring: rgba(33,64,177,.22);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:'Pretendard',system-ui,sans-serif}
    .container{max-width:1200px;margin:0 auto;padding:0 24px}
    .card{background:var(--card); border-radius:18px; box-shadow:var(--shadow)}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:10px;
         height:48px; padding:0 20px; border-radius:14px; border:1px solid transparent;
         font-weight:700; cursor:pointer; transition:.15s}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--brand); color:#fff}
    .btn-primary:hover{background:var(--brand-600)}
    .btn-ghost{background:transparent; color:#111; border:1px solid rgba(0,0,0,.08)}
    .btn-subtle{background:#eef2ff; color:var(--brand)}
    .form-label{font-weight:700; margin:18px 0 8px}
    .input,.textarea{
      width:100%; background:#fff; border:1px solid #e5e7eb; border-radius:14px;
      padding:12px 14px; font-size:16px; resize:none; outline:0; transition:.15s;
    }
    .input:focus,.textarea:focus{border-color:var(--brand); box-shadow:0 0 0 3px var(--ring)}
    .muted{color:var(--muted)}
    .error{color:#ef4444; font-weight:700}

    /* ë„¤ë¹„(ìœ ë¦¬) */
    header.sticky{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(150%) blur(8px);
      background:rgba(255,255,255,.6);
      border-bottom:1px solid rgba(0,0,0,.06);
    }

    /* ë ˆì´ì•„ì›ƒ */
    .grid{display:grid; gap:28px}
    @media(min-width:992px){ .grid{grid-template-columns:1.05fr .95fr} }
    .kpi{display:grid; grid-template-columns:repeat(2,1fr); gap:16px}
    @media(min-width:680px){ .kpi{grid-template-columns:repeat(4,1fr)} }

    /* ìœ ë¦¬ ì¹´ë“œ */
    .glass{backdrop-filter:blur(8px); background:var(--glass);
           border:1px solid rgba(255,255,255,.55); border-radius:18px;
           box-shadow:var(--shadow-lg); padding:18px}
  </style>
</head>
<body>

  <!-- NAV -->
  <header class="sticky">
    <div class="container" style="height:64px;display:flex;align-items:center;justify-content:space-between">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:22px;height:22px;border-radius:50%;background:var(--brand)"></div>
        <strong>ì•„ì¹´ë°ë¯¸ì°½</strong>
      </div>
      <nav style="display:flex;gap:22px;color:#374151;font-weight:700">
        <a>ì„œë¹„ìŠ¤</a><a>ì´ìš©ì•ˆë‚´</a><a>ê°€ê²©</a>
      </nav>
    </div>
  </header>

  <!-- HERO -->
  <section style="position:relative;overflow:hidden;padding:92px 0 80px">
    <div style="position:absolute;inset:0;background:
      radial-gradient(1200px 600px at 50% -10%, rgba(46,106,255,.22), transparent 60%),
      linear-gradient(180deg, #ffffff 0%, #eff4ff 100%); z-index:-2"></div>

    <div class="container" style="text-align:center">
      <h1 style="font-size:clamp(36px,6vw,64px);line-height:1.1;margin:0 0 16px;font-weight:900">
        ê¸€ í‰ê°€ì™€ ì˜ˆì‹œ ì‘ì„±, <br>ë” ì‰½ê³  ê°„í¸í•˜ê²Œ
      </h1>
      <p style="margin:0 auto 28px;max-width:720px;color:#4b5563;font-size:18px">
        í•™ìƒ ê¸€ ì…ë ¥ â†’ AI í‰ê°€/ê·¸ë˜í”„ â†’ ì œì‹œë¬¸ ê¸°ë°˜ ì˜ˆì‹œë‹µì•ˆ â†’ PDF ì €ì¥ê¹Œì§€.
      </p>
      <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="document.querySelector('#inputSection')?.scrollIntoView({behavior:'smooth'})">ì‹œì‘í•˜ê¸°</button>
        <button class="btn btn-ghost" onclick="showExample()">ì˜ˆì‹œ ë¯¸ë¦¬ë³´ê¸°</button>
      </div>

      <div style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:16px;margin-top:48px">
        <div class="glass">âœï¸ <div style="font-weight:800;margin-top:8px">ë…¼ìˆ  ì…ë ¥</div><div class="muted" style="font-size:14px">ì§ˆë¬¸Â·ì œì‹œë¬¸Â·ë…¼ìˆ ë¬¸</div></div>
        <div class="glass">ğŸ“Š <div style="font-weight:800;margin-top:8px">í‰ê°€ ì¹´ë“œ/ê·¸ë˜í”„</div><div class="muted" style="font-size:14px">ì ìˆ˜ì™€ ê·¼ê±°</div></div>
        <div class="glass">ğŸ’¡ <div style="font-weight:800;margin-top:8px">ì˜ˆì‹œë‹µì•ˆ</div><div class="muted" style="font-size:14px">ì œì‹œë¬¸ë§Œ í™œìš©</div></div>
        <div class="glass">ğŸ“„ <div style="font-weight:800;margin-top:8px">PDF ì €ì¥</div><div class="muted" style="font-size:14px">ê¸°ë¡ ë³´ê´€</div></div>
      </div>
    </div>
  </section>

  <!-- MAIN (ì¢Œ: ì…ë ¥ / ìš°: ê²°ê³¼) -->
  <main class="container grid" id="mainSection">
    <!-- ì…ë ¥ -->
    <section class="card" style="padding:28px">
      <label class="form-label">í•™ìƒ ì´ë¦„</label>
      <input id="studentName" class="input" placeholder="í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"/>

      <label class="form-label">ì§ˆë¬¸</label>
      <textarea id="question" class="textarea" rows="2" placeholder="ì§ˆë¬¸ì„ ì—¬ê¸°ì— ì‘ì„±í•´ ì£¼ì„¸ìš”."></textarea>

      <label class="form-label">ì œì‹œë¬¸</label>
      <div id="passages" class="grid" style="gap:12px">
        <textarea class="passage textarea" rows="3" placeholder="ì œì‹œë¬¸ì„ ê·¸ëŒ€ë¡œ ì ì–´ ì£¼ì„¸ìš”."></textarea>
      </div>
      <button type="button" class="btn btn-ghost" onclick="addPassage()">â• ì œì‹œë¬¸ ì¶”ê°€</button>

      <label class="form-label">ë…¼ìˆ ë¬¸</label>
      <textarea id="essay" class="textarea" rows="6" placeholder="ì—´ì‹¬íˆ ì‘ì„±í•œ ë…¼ìˆ ë¬¸ì„ ì—¬ê¸°ì— ì‘ì„±í•´ ì£¼ì„¸ìš”." oninput="updateCharCount()"></textarea>
      <div id="charCount" class="muted" style="margin-top:6px"></div>

      <label class="form-label">ê¸€ì ìˆ˜ ì œí•œ</label>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <input id="charBase" class="input" placeholder="ì˜ˆ: 700"/>
        <input id="charRange" class="input" placeholder="Â± ì˜ˆ: 50"/>
      </div>

      <button class="btn btn-primary" style="width:100%; margin-top:18px" onclick="submitEssay()">âœ¨ ë¦¬í¬íŠ¸ë¥¼ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”</button>
      <div id="loading" class="muted" style="display:none; margin-top:8px">â³ í•™ìƒì˜ ê¸€ì„ ì½ê³  ìˆì–´ìš”â€¦</div>
      <div id="error" class="error" style="display:none; margin-top:8px">ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</div>
    </section>

    <!-- ê²°ê³¼ -->
    <section id="resultCard" class="card" style="padding:28px; display:none">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px">
        <h3 style="margin:0">ğŸ“‹ í•™ìƒì˜ ì—­ëŸ‰, ì´ë ‡ê²Œ ì •ë¦¬í–ˆì–´ìš”</h3>
        <button class="btn btn-ghost" onclick="resetAll()">ìƒˆ ë¦¬í¬íŠ¸ ì‹œì‘</button>
      </div>
      <div id="evalSummary"></div>
      <button class="btn btn-subtle" style="margin-top:16px" onclick="showExample()">ğŸ’¡ ì˜ˆì‹œë‹µì•ˆ ë³´ê¸°</button>
    </section>
  </main>

  <!-- ì˜ˆì‹œë‹µì•ˆ ì„¹ì…˜ -->
  <section id="exampleSection" class="card" style="max-width:960px; margin:24px auto; padding:28px; display:none">
    <div id="exampleLoading" class="muted">â³ ì˜ˆì‹œë‹µì•ˆê³¼ ë¶„ì„ì„ ì •ë¦¬ ì¤‘â€¦</div>
    <div id="exampleResult" style="display:none">
      <h3 style="margin:0 0 10px">ğŸ“ ì˜ˆì‹œë‹µì•ˆ</h3>
      <p id="exampleAnswer"></p>
      <h3 style="margin:18px 0 10px">ğŸ” ë¹„êµ ë¶„ì„</h3>
      <p id="comparisonBox"></p>
      <div style="display:flex; gap:8px; margin-top:12px">
        <button class="btn btn-ghost" onclick="resetAll()">ìƒˆ ë¦¬í¬íŠ¸ ì‹œì‘</button>
      </div>
      <button class="btn btn-primary" style="margin-top:6px" onclick="downloadPDF()">ğŸ“„ PDFë¡œ ì €ì¥</button>
    </div>
  </section>

  <!-- ê¸°ëŠ¥ JS (ê¸°ì¡´ ë¡œì§ ìœ ì§€) -->
  <script>
    let savedScores = [], savedReasons = {}, savedExample = '', savedComparison = '';
    let scoreChart = null;

    // auto-resize
    function autoResize(el){ el.style.height="auto"; el.style.height=el.scrollHeight+"px"; }
    function bindAutoResize(){ document.querySelectorAll("textarea").forEach(t=>{
      if(!t.dataset.bound){ t.addEventListener("input", ()=>autoResize(t)); t.dataset.bound="1"; autoResize(t); }
    }); }
    document.addEventListener("DOMContentLoaded", bindAutoResize);

    function addPassage(){
      const t = document.createElement('textarea');
      t.className = 'passage textarea'; t.rows=3; t.placeholder='ì œì‹œë¬¸ì„ ê·¸ëŒ€ë¡œ ì ì–´ ì£¼ì„¸ìš”.';
      document.getElementById('passages').appendChild(t);
      bindAutoResize();
    }
    function updateCharCount(){
      const n = document.getElementById('essay').value.length;
      document.getElementById('charCount').textContent = `í˜„ì¬ê¹Œì§€ ì‘ì„±í•œ ê¸€ì ìˆ˜: ${n}ì`;
    }
    function resetAll(){
      document.getElementById("studentName").value = "";
      document.getElementById("question").value = "";
      document.getElementById("essay").value = "";
      document.getElementById("charBase").value = "";
      document.getElementById("charRange").value = "";
      document.getElementById("charCount").textContent = "";
      const p = document.getElementById("passages");
      p.innerHTML = '<textarea class="passage textarea" rows="3" placeholder="ì œì‹œë¬¸ì„ ê·¸ëŒ€ë¡œ ì ì–´ ì£¼ì„¸ìš”."></textarea>';
      bindAutoResize();
      savedScores=[]; savedReasons={}; savedExample=''; savedComparison='';
      document.getElementById("resultCard").style.display="none";
      document.getElementById("exampleSection").style.display="none";
      if(scoreChart){ scoreChart.destroy(); scoreChart=null; }
      window.scrollTo({top:0, behavior:"smooth"});
    }

    async function submitEssay(){
      const name = document.getElementById("studentName").value.trim();
      const passages = [...document.querySelectorAll(".passage")].map(p=>p.value).filter(v=>v.trim());
      const question = document.getElementById("question").value.trim();
      const essay = document.getElementById("essay").value.trim();
      const charBase = document.getElementById("charBase").value;
      const charRange = document.getElementById("charRange").value;

      if(!name || !question || !essay || passages.length===0){ alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

      document.getElementById("loading").style.display="block";
      document.getElementById("error").style.display="none";

      try{
        const res = await fetch("/review", {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ passages, question, essay, charBase, charRange })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error||"ì„œë²„ ì˜¤ë¥˜");

        savedScores = data.scores;
        savedReasons = data.reasons;

        // ë Œë”
        document.getElementById("resultCard").style.display="block";
        document.getElementById("evalSummary").innerHTML = `
          <div class="kpi">
            ${['ë…¼ë¦¬ë ¥','ë…í•´ë ¥','êµ¬ì„±ë ¥','í‘œí˜„ë ¥'].map((label,i)=>`
              <div class="card" style="padding:16px">
                <div style="font-weight:800">${label} (${savedScores[i]}ì )</div>
                <div class="muted" style="margin-top:6px; line-height:1.55">${savedReasons[label]}</div>
              </div>
            `).join('')}
          </div>
          <div style="margin-top:24px"><canvas id="scoreChart" height="280"></canvas></div>
        `;
        const ctx = document.getElementById("scoreChart").getContext("2d");
        if(scoreChart) scoreChart.destroy();
        scoreChart = new Chart(ctx, {
          type:"bar",
          data:{ labels:["ë…¼ë¦¬ë ¥","ë…í•´ë ¥","êµ¬ì„±ë ¥","í‘œí˜„ë ¥"],
            datasets:[{ label:"ì ìˆ˜", data:savedScores, backgroundColor:["#6366f1","#3b82f6","#f59e0b","#10b981"], borderRadius:8, barThickness:40 }]},
          options:{ scales:{ y:{ beginAtZero:true, max:10, ticks:{ stepSize:1 } } }, plugins:{ legend:{ display:false } } }
        });
        document.getElementById("loading").style.display="none";
        // ê²°ê³¼ ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
        document.getElementById("resultCard").scrollIntoView({behavior:"smooth", block:"start"});
      }catch(e){
        console.error(e); document.getElementById("error").style.display="block";
      }finally{
        document.getElementById("loading").style.display="none";
      }
    }

    function showExample(retry=false){
      document.getElementById("exampleSection").style.display="block";
      document.getElementById("exampleLoading").style.display="block";
      document.getElementById("exampleResult").style.display="none";

      const passages = [...document.querySelectorAll(".passage")].map(p=>p.value);
      const question = document.getElementById("question").value;
      const essay = document.getElementById("essay").value;
      const charBase = document.getElementById("charBase").value;
      const charRange = document.getElementById("charRange").value;

      fetch("/example", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ passages, question, essay, scores:savedScores, reasons:savedReasons, charBase, charRange, retryConfirmed:retry })
      })
      .then(r=>r.json())
      .then(data=>{
        if(data.error) throw new Error(data.error);
        savedExample = data.example || "";
        savedComparison = data.comparison || "";
        document.getElementById("exampleAnswer").textContent = savedExample;
        document.getElementById("comparisonBox").textContent = savedComparison;
        document.getElementById("exampleLoading").style.display="none";
        document.getElementById("exampleResult").style.display="block";
        document.getElementById("exampleSection").scrollIntoView({behavior:"smooth"});
      })
      .catch(e=>{
        console.error(e);
        document.getElementById("exampleLoading").textContent = "ì˜ˆì‹œë‹µì•ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      });
    }

    function downloadPDF(){
      const name = document.getElementById("studentName").value;
      const essay = document.getElementById("essay").value;
      const today = new Date().toISOString().split("T")[0];
      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <h2>ë‹¤ì“° ë¦¬í¬íŠ¸</h2>
        <p>í•™ìƒ: ${name} | ë‚ ì§œ: ${today}</p>
        <h3>ì‘ì„±í•œ ë…¼ìˆ ë¬¸</h3><p>${essay.replace(/\n/g,'<br>')}</p>
        <h3>í‰ê°€ ìš”ì•½</h3>
        ${['ë…¼ë¦¬ë ¥','ë…í•´ë ¥','êµ¬ì„±ë ¥','í‘œí˜„ë ¥'].map((k,i)=>`<p><b>${k} (${savedScores[i]}ì )</b><br>${savedReasons[k]}</p>`).join('')}
        <h3>ì˜ˆì‹œë‹µì•ˆ</h3><p>${savedExample.replace(/\n/g,'<br>')}</p>
        <h3>ë¹„êµ ë¶„ì„</h3><p>${savedComparison.replace(/\n/g,'<br>')}</p>
      `;
      html2pdf().from(wrap).set({ margin:10, filename:`ë‹¤ì“°_ë¦¬í¬íŠ¸_${today}.pdf`,
        html2canvas:{ scale:2 }, jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' } }).save();
    }
  </script>
</body>
</html>
